<meta name="viewport" content="width=device-width, initial-scale=1.0">
<div class="receipt-container">
    <div class="receipt-header text-center mb-4">
        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Clinic Logo" class="logo mb-2">
        <h3>MAKOKHA MEDICAL CENTRE</h3>
        <p class="mb-1">PO Box 142, Kimilili</p>
        <p class="mb-1">Phone: +254 741256531</p>
        <p class="mb-1">Email: brokenpath4@gmail.com</p>
        <div class="receipt-title-section">
            <h5 class="mt-3">SALES RECEIPT</h5>
            {% if sale.bulk_sale_number %}
                <h6>Bulk Sale: {{ sale.bulk_sale_number }}</h6>
            {% endif %}
        </div>
    </div>
    
    <div class="receipt-info mb-4">
        <div class="row">
            <div class="col-6">
                <p><strong>Receipt No:</strong> {{ sale.sale_number }}</p>
                {% if sale.bulk_sale_number %}
                <p><strong>Bulk Sale No:</strong> {{ sale.bulk_sale_number }}</p>
                {% endif %}
                <p><strong>Date:</strong> {{ sale.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
            </div>
            <div class="col-6 text-end">
                <p><strong>Pharmacist:</strong> {{ sale.user.username }}</p>
                <p><strong>Payment Method:</strong> 
                    {{ 'Cash' if sale.payment_method == 'cash' }}
                    {{ 'M-Pesa' if sale.payment_method == 'mpesa' }}
                    {{ 'Credit Card' if sale.payment_method == 'credit_card' }}
                    {{ 'Insurance' if sale.payment_method == 'insurance' }}
                </p>
                {% if sale.patient %}
                <p><strong>Patient:</strong> {{ sale.patient.op_number or sale.patient.ip_number }} - {{ decrypt_data(sale.patient.name) }}</p>
                {% else %}
                <p><strong>Customer:</strong> Walk-in</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="receipt-items mb-4">
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Item Details</th>
                    <th class="text-end">Qty</th>
                    <th class="text-end">Unit Price</th>
                    <th class="text-end">Total</th>
                </tr>
            </thead>
            <tbody>
                {% for item in sale.items %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>
                        {{ item.drug.name }} ({{ item.drug.specification }})
                        {% if not sale.bulk_sale_number %}
                            <br><small class="text-muted">Item ID: {{ item.individual_sale_number }}</small>
                        {% else %}
                            <br><small class="text-muted">Item ID: {{ item.individual_sale_number }}</small>
                        {% endif %}
                    </td>
                    <td class="text-end">{{ item.quantity }}</td>
                    <td class="text-end">{{ "Ksh {:,.2f}".format(item.unit_price) }}</td>
                    <td class="text-end">{{ "Ksh {:,.2f}".format(item.total_price) }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <th colspan="4" class="text-end">Subtotal:</th>
                    <th class="text-end">{{ "Ksh {:,.2f}".format(sale.total_amount) }}</th>
                </tr>
                {% if sale.payment_method == 'insurance' %}
                <tr>
                    <th colspan="4" class="text-end">Insurance Cover:</th>
                    <th class="text-end">{{ "Ksh {:,.2f}".format(sale.insurance_cover) }}</th>
                </tr>
                <tr>
                    <th colspan="4" class="text-end">Amount Paid:</th>
                    <th class="text-end">{{ "Ksh {:,.2f}".format(sale.total_amount - sale.insurance_cover) }}</th>
                </tr>
                {% endif %}
                <tr>
                    <th colspan="4" class="text-end">Payment Method:</th>
                    <th class="text-end">
                        {% if sale.payment_method == 'mpesa' %}
                            M-Pesa
                        {% elif sale.payment_method == 'credit_card' %}
                            Credit Card
                        {% elif sale.payment_method == 'insurance' %}
                            Insurance
                        {% else %}
                            Cash
                        {% endif %}
                    </th>
                </tr>
            </tfoot>
        </table>
    </div>
    
    <div class="receipt-footer text-center mt-4">
        <p class="mb-1">Thank you for your purchase!</p>
        <p class="mb-1">Goods sold are not returnable without original receipt</p>
        <p class="mb-1"><strong>Note:</strong> For refunds, present this receipt within 7 days</p>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Close button functionality
    document.getElementById('closeReceipt').addEventListener('click', function() {
        window.close(); // Close the current window
    });

    // Alternative method for browsers that block window.close()
    document.getElementById('printReceipt').addEventListener('click', function() {
        window.print();
    });
});
</script>

<style>
.receipt-container {
    max-width: 500px;
    margin: 0 auto;
    padding: 20px;
    border: 1px solid #ddd;
    font-family: Arial, sans-serif;
    background-color: #fff;
}

.logo {
    max-height: 80px;
    max-width: 100%;
    display: block;
    margin-left: auto;
    margin-right: auto;
}

.receipt-header h3 {
    font-weight: bold;
    margin-bottom: 5px;
    color: #0d6efd;
}

.receipt-header h5 {
    border-top: 2px solid #0d6efd;
    border-bottom: 2px solid #0d6efd;
    padding: 5px 0;
    margin: 10px 0;
    color: #333;
}

.receipt-title-section {
    margin: 15px 0;
}

.receipt-info p {
    margin-bottom: 3px;
    font-size: 14px;
}

.table-sm {
    font-size: 14px;
}

.table-sm th, .table-sm td {
    padding: 5px 8px;
}

.text-end {
    text-align: right;
}

tfoot th {
    border-top: 2px solid #dee2e6 !important;
}

.no-print {
    display: block;
}

@media print {
    body {
        background: none;
        margin: 0;
        padding: 0;
    }
    
    .receipt-container {
        border: none;
        padding: 0;
        max-width: 100%;
    }
    
    .no-print {
        display: none !important;
    }
}
</style>