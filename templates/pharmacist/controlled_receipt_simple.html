{# Simple receipt template for modal display #}
<div class="no-print text-end mb-2">
    {% set whatsapp_share_endpoint = url_for('api_controlled_sale_share_whatsapp', sale_id=sale.id) %}
    {% set whatsapp_fallback_pdf = url_for('api_controlled_sale_receipt_pdf', sale_id=sale.id) %}
        {% set whatsapp_default_phone = '' %}
    {% set _class = 'btn btn-success btn-sm' %}
    {% include 'components/whatsapp_share_button.html' %}
</div>

<div class="text-center mb-3">
    <h5 class="mb-0">MAKOKHA MEDICAL CENTRE</h5>
    <div class="text-muted small">CONTROLLED DRUGS RECEIPT</div>
</div>

<div class="row mb-3">
    <div class="col-6">
        <div><small><span class="fw-semibold">Receipt No:</span> {{ sale.sale_number }}</small></div>
        <div><small><span class="fw-semibold">Date/Time:</span> {% if sale.created_at %}{{ sale.created_at.strftime('%d/%m/%Y %H:%M EAT') }}{% endif %}</small></div>
        <div><small><span class="fw-semibold">Pharmacist:</span> {{ sale.pharmacist_name or (sale.user.username if sale.user else '') }}</small></div>
    </div>
    <div class="col-6">
        <div><small><span class="fw-semibold">Name:</span> {{ sale.customer_name }}</small></div>
        <div><small><span class="fw-semibold">Phone:</span> {{ sale.customer_phone }}</small></div>
        <div><small><span class="fw-semibold">Sex:</span> {{ sale.customer_gender[0] if sale.customer_gender else '' }}</small></div>
        {% if sale.customer_age %}<div><small><span class="fw-semibold">Age:</span> {{ sale.customer_age }}</small></div>{% endif %}
        {% if sale.destination %}<div><small><span class="fw-semibold">Destination:</span> {{ sale.destination }}</small></div>{% endif %}
        {% if sale.diagnosis %}<div><small><span class="fw-semibold">Dx:</span> {{ sale.diagnosis }}</small></div>{% endif %}
    </div>
</div>

<hr>

<div class="table-responsive">
    <table class="table table-sm table-striped">
        <thead class="table-light">
            <tr>
                <th style="width: 35%;">Drug</th>
                <th class="text-center" style="width: 15%;">Qty</th>
                <th class="text-end" style="width: 20%;">Unit</th>
                <th class="text-end" style="width: 30%;">Total</th>
            </tr>
        </thead>
        <tbody>
            {% for item in sale.items %}
            <tr>
                <td>
                    <div class="fw-semibold small">{{ item.controlled_drug_name }}</div>
                    {% if item.controlled_drug_specification %}
                        <div class="text-muted" style="font-size: 0.75rem;">{{ item.controlled_drug_specification }}</div>
                    {% endif %}
                </td>
                <td class="text-center">{{ item.quantity }}</td>
                <td class="text-end">Ksh {{ '%.2f'|format(item.unit_price) }}</td>
                <td class="text-end fw-semibold">Ksh {{ '%.2f'|format(item.total_price) }}</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr class="fw-semibold border-top">
                <td colspan="3" class="text-end">TOTAL:</td>
                <td class="text-end">Ksh {{ '%.2f'|format(sale.total_amount) }}</td>
            </tr>
        </tfoot>
    </table>
</div>

<div class="mt-2">
    <div class="fw-semibold mb-1">Payment Summary</div>
    <table class="table table-sm table-bordered mb-0">
        <tbody>
            <tr>
                <th>Total</th>
                <td class="text-end"><strong>Ksh {{ '%.2f'|format(sale.total_amount or 0) }}</strong></td>
            </tr>
            <tr>
                <th>Payment Method</th>
                <td class="text-end">{{ (sale.payment_method or 'cash')|upper }}</td>
            </tr>
            {% if (sale.payment_method or 'cash') == 'cash' and amount_given is defined and amount_given is not none %}
            <tr>
                <th>Amount Given (Cash)</th>
                <td class="text-end">Ksh {{ '%.2f'|format(amount_given) }}</td>
            </tr>
            {% set _bal = (change if (change is defined and change is not none) else ((amount_given or 0) - (sale.total_amount or 0))) %}
            <tr>
                <th>{{ 'Balance' if _bal >= 0 else 'Balance Due' }}</th>
                <td class="text-end">Ksh {{ '%.2f'|format(_bal) }}</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

{% if sale.prescription_image_path %}
<hr>
<div class="text-center">
    <div class="fw-semibold mb-2">Prescription Sheet</div>
    <img src="/{{ sale.prescription_image_path }}" alt="Prescription" style="max-width: 100%; max-height: 300px; border: 1px solid #ddd; border-radius: 4px;">
</div>
{% endif %}

<hr>

<div class="text-center text-muted small">
    <p class="mb-1">Thank you for your purchase.</p>
    <p class="mb-0">Goods sold are not returnable without original receipt.</p>
</div>

