{% extends "base.html" %}

{% block content %}
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<div class="content">
    <h2><i class="fas fa-prescription-bottle-alt"></i> Prescription Sales</h2>
    
    <div class="sales-container">
        <div class="drug-selection">
            <div class="search-box">
                <input type="text" id="drugSearch" placeholder="Search drugs...">
                <i class="fas fa-search"></i>
            </div>
            <div class="drug-list" id="drugList">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i> Loading available drugs...
                </div>
            </div>
        </div>
        
        <div class="cart-container">
            <div class="cart-header">
                <h4><i class="fas fa-shopping-cart"></i> Current Order</h4>
                <div class="cart-actions">
                    <button class="btn btn-sm btn-outline" id="clearCartBtn">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                </div>
            </div>
            <div class="cart-items" id="cartItems">
                <div class="empty-cart">
                    <i class="fas fa-cart-arrow-down"></i>
                    <p>Your cart is empty</p>
                </div>
            </div>
            <div class="cart-footer">
                <div class="customer-info">
                    <div class="form-group">
                        <label for="patientAge">Patient Age</label>
                        <input type="number" id="patientAge" class="form-control" placeholder="Enter patient age" min="0">
                    </div>
                    <div class="form-group">
                        <label for="prescriptionNumber">Prescription Number</label>
                        <input type="text" id="prescriptionNumber" class="form-control" placeholder="Enter prescription number">
                    </div>
                    <div class="form-group">
                        <label>Payment Method</label>
                        <div class="payment-methods">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="cashMethod" value="cash" checked>
                                <label class="form-check-label" for="cashMethod">Cash</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="mpesaMethod" value="mpesa">
                                <label class="form-check-label" for="mpesaMethod">M-Pesa</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="cardMethod" value="credit_card">
                                <label class="form-check-label" for="cardMethod">Credit Card</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="insuranceMethod" value="insurance">
                                <label class="form-check-label" for="insuranceMethod">Insurance</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="cart-total">
                    <span>Total:</span>
                    <span id="cartTotal">Ksh 0.00</span>
                </div>
                <div class="cart-buttons">
                    <button class="btn btn-primary" id="confirmSaleBtn">
                        <i class="fas fa-check"></i> Complete Sale
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Receipt Modal -->
<div class="modal fade" id="receiptModal" tabindex="-1" role="dialog" aria-labelledby="receiptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="receiptModalLabel">Beer Sale Receipt</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="receiptContent">
                <!-- Receipt content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="printReceiptBtn">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize cart
    if (!localStorage.getItem('beerCart')) {
        localStorage.setItem('beerCart', JSON.stringify({ items: [] }));
    }

    // Load available drugs
    loadDrugs();
    renderCartItems();
    updateCartSummary();

    // Load drugs from server
    function loadDrugs() {
        $('#drugList').html('<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Loading drugs...</div>');
        
        $.get('/pharmacist/drugs', function(data) {
            if (data && data.length > 0) {
                let html = '';
                data.forEach(function(drug) {
                    html += `
                        <div class="drug-card" data-id="${drug.id}">
                            <div class="drug-info">
                                <h5>${drug.name}</h5>
                                <p>${drug.specification || 'Prescription drug'}</p>
                                <div class="drug-meta">
                                    <span class="price">Ksh ${drug.selling_price.toFixed(2)}</span>
                                    <span class="stock">${drug.remaining_quantity} in stock</span>
                                </div>
                            </div>
                            <div class="drug-actions">
                                <button class="btn btn-sm btn-add-to-cart" 
                                    data-id="${drug.id}" 
                                    data-name="${drug.name.replace(/"/g, '&quot;')}"
                                    data-price="${drug.selling_price}"
                                    data-stock="${drug.remaining_quantity}">
                                    <i class="fas fa-cart-plus"></i> Add
                                </button>
                            </div>
                        </div>
                    `;
                });
                $('#drugList').html(html);
            } else {
                $('#drugList').html('<div class="empty-list"><i class="fas fa-prescription-bottle-alt"></i> No drugs available</div>');
            }
        }).fail(function() {
            $('#drugList').html('<div class="error-loading"><i class="fas fa-exclamation-circle"></i> Failed to load drugs</div>');
        });
    }

    // Cart management functions
    function getCart() {
        return JSON.parse(localStorage.getItem('beerCart'));
    }

    function saveCart(cart) {
        localStorage.setItem('beerCart', JSON.stringify(cart));
    }

    function updateCartSummary() {
        const cart = getCart();
        let total = 0;
        
        cart.items.forEach(item => {
            total += item.price * item.quantity;
        });
        
        $('#cartTotal').text('Ksh ' + total.toFixed(2));
    }

    function renderCartItems() {
        const cart = getCart();
        const $cartItems = $('#cartItems');
        
        if (cart.items.length === 0) {
            $cartItems.html('<div class="empty-cart"><i class="fas fa-cart-arrow-down"></i><p>Your cart is empty</p></div>');
            return;
        }
        
        let html = '';
        cart.items.forEach(item => {
            html += `
                <div class="cart-item" data-id="${item.beerId}">
                    <div class="item-info">
                        <h5>${item.beerName}</h5>
                        <div class="item-price">Ksh ${item.price.toFixed(2)}</div>
                    </div>
                    <div class="item-controls">
                        <button class="btn btn-sm btn-decrease" data-id="${item.beerId}">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" class="form-control form-control-sm item-quantity" 
                               value="${item.quantity}" min="1" max="${item.currentStock}"
                               data-id="${item.beerId}">
                        <button class="btn btn-sm btn-increase" data-id="${item.beerId}">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="item-total">Ksh ${(item.price * item.quantity).toFixed(2)}</div>
                    <button class="btn btn-sm btn-danger btn-remove" data-id="${item.beerId}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        });
        $cartItems.html(html);
    }

    // Add to cart
    $(document).on('click', '.btn-add-to-cart', function() {
        const drugId = $(this).data('id');
        const drugName = $(this).data('name');
        const price = parseFloat($(this).data('price'));
        const currentStock = parseInt($(this).data('stock'));
        
        let cart = getCart();
        const existingItem = cart.items.find(item => item.drugId == drugId);
        
        if (existingItem) {
            if (existingItem.quantity < currentStock) {
                existingItem.quantity++;
            } else {
                alert(`Cannot add more than available stock (${currentStock})`);
                return;
            }
        } else {
            cart.items.push({
                drugId: drugId,
                drugName: drugName,
                price: price,
                quantity: 1,
                currentStock: currentStock
            });
        }
        
        saveCart(cart);
        renderCartItems();
        updateCartSummary();
    });

    // Cart controls
    $(document).on('click', '.btn-increase', function() {
        const beerId = $(this).data('id');
        const cart = getCart();
        const item = cart.items.find(item => item.beerId == beerId);
        
        if (item.quantity < item.currentStock) {
            item.quantity++;
            $(this).siblings('.item-quantity').val(item.quantity);
            updateCartItem(beerId, item);
        } else {
            alert(`Cannot add more than available stock (${item.currentStock})`);
        }
    });
    
    $(document).on('click', '.btn-decrease', function() {
        const beerId = $(this).data('id');
        const cart = getCart();
        const item = cart.items.find(item => item.beerId == beerId);
        
        if (item.quantity > 1) {
            item.quantity--;
            $(this).siblings('.item-quantity').val(item.quantity);
            updateCartItem(beerId, item);
        }
    });
    
    $(document).on('change', '.item-quantity', function() {
        const beerId = $(this).data('id');
        const newQty = parseInt($(this).val()) || 1;
        const maxQty = parseInt($(this).attr('max')) || 100;
        
        const cart = getCart();
        const item = cart.items.find(item => item.beerId == beerId);
        
        if (newQty > maxQty) {
            $(this).val(maxQty);
            item.quantity = maxQty;
            alert(`Cannot add more than available stock (${maxQty})`);
        } else if (newQty < 1) {
            $(this).val(1);
            item.quantity = 1;
        } else {
            item.quantity = newQty;
        }
        
        saveCart(cart);
        updateCartItem(beerId, item);
    });
    
    function updateCartItem(beerId, item) {
        $(`.cart-item[data-id="${beerId}"] .item-total`).text('Ksh ' + (item.price * item.quantity).toFixed(2));
        saveCart(getCart());
        updateCartSummary();
    }
    
    $(document).on('click', '.btn-remove', function() {
        const beerId = $(this).data('id');
        const cart = getCart();
        cart.items = cart.items.filter(item => item.beerId != beerId);
        
        saveCart(cart);
        renderCartItems();
        updateCartSummary();
    });

    // Clear cart
    $('#clearCartBtn').click(function() {
        saveCart({ items: [] });
        renderCartItems();
        updateCartSummary();
    });

// Confirm sale
$('#confirmSaleBtn').click(function() {
    const patientAge = parseInt($('#patientAge').val()) || 0;
    const prescriptionNumber = $('#prescriptionNumber').val().trim();

    if (!prescriptionNumber) {
        alert('Prescription number is required.');
        $('#prescriptionNumber').focus();
        return;
    }

    const cart = getCart();
    if (cart.items.length === 0) {
        alert('Your cart is empty');
        return;
    }
    
    // Get selected payment method
    const paymentMethod = $('input[name="paymentMethod"]:checked').val();
    
    // Prepare items with unit prices
    const items = cart.items.map(item => ({
        drug_id: item.drugId,
        quantity: item.quantity,
        unit_price: item.price
    }));
    
    const $btn = $(this);
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Processing...');
    
    $.ajax({
        url: '/pharmacist/sale',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            items: items,
            payment_method: paymentMethod,
            patient_age: patientAge,
            prescription_number: prescriptionNumber
        }),
        success: function(response) {
            if (response.success) {
                // Clear cart
                saveCart({ items: [] });
                renderCartItems();
                updateCartSummary();
                $('#patientAge').val('');
                $('#prescriptionNumber').val('');
                
                // Show receipt
                showReceipt(response.sale_id);
            } else {
                alert('Error: ' + (response.error || 'Failed to process sale'));
            }
        },
        error: function(xhr) {
            let errorMsg = 'Failed to process sale';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMsg = xhr.responseJSON.error;
                if (xhr.responseJSON.details) {
                    errorMsg += '\n' + xhr.responseJSON.details;
                }
            }
            alert(errorMsg);
        },
        complete: function() {
            $btn.prop('disabled', false).html('<i class="fas fa-check"></i> Complete Sale');
        }
    });
});
    // Show receipt
    function showReceipt(saleId) {
        $('#receiptContent').html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading receipt...</div>');
        $('#receiptModal').modal({
            backdrop: 'static',
            keyboard: false
        }).modal('show');
        
        $.get(`/pharmacist/sale/${saleId}/receipt`, function(data) {
            $('#receiptContent').html(data);
        }).fail(function() {
            $('#receiptContent').html('<div class="alert alert-danger">Failed to load receipt</div>');
        });
    }

    // Print receipt
    $('#printReceiptBtn').click(function() {
        const printContent = $('#receiptContent').html();
        const originalContent = $('body').html();
        
        $('body').html(printContent);
        window.print();
        $('body').html(originalContent);
    });

    // Close modal handler
    $('#receiptModal').on('hidden.bs.modal', function () {
        // Any cleanup if needed
    });
});
</script>

<style>
.beer-sales-container {
    display: flex;
    gap: 20px;
    margin-top: 20px;
}

.beer-selection {
    flex: 1;
    background: #fff;
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    overflow: hidden;
}

.beer-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
    padding: 15px;
    max-height: 70vh;
    overflow-y: auto;
}

.beer-card {
    background: white;
    border-radius: 5px;
    padding: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    border-left: 4px solid #f0ad4e;
}

.beer-info h5 {
    margin: 0 0 5px 0;
    color: #333;
}

.beer-info p {
    margin: 0 0 10px 0;
    color: #666;
    font-size: 14px;
}

.beer-meta {
    display: flex;
    justify-content: space-between;
    margin-top: auto;
}

.price {
    font-weight: bold;
    color: #28a745;
}

.stock {
    color: #6c757d;
    font-size: 13px;
}

.beer-actions {
    margin-top: 10px;
}

.btn-add-to-cart {
    width: 100%;
    background-color: #f0ad4e;
    border-color: #eea236;
    color: white;
}

.btn-add-to-cart:hover {
    background-color: #ec971f;
    border-color: #d58512;
}

.customer-info {
    margin-bottom: 15px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
}

.payment-methods {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.payment-methods .form-check {
    margin-right: 15px;
    margin-bottom: 5px;
}

.form-check-input {
    margin-top: 0.2rem;
    margin-left: 0;
    margin-right: 0.3rem;
}

.modal {
    z-index: 1050;
}

.modal-backdrop {
    z-index: 1040;
}

@media (max-width: 768px) {
    .beer-sales-container {
        flex-direction: column;
    }
    
    .beer-list {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    }
    
    .payment-methods {
        flex-direction: column;
        gap: 5px;
    }
}
</style>
{% endblock %}