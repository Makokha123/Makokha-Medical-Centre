{% if not is_embed %}
{% extends "base.html" %}

{% block title %}Controlled Drug Inventory{% endblock %}

{% block content %}
{% endif %}
<style>
  /* Match normal Drug Inventory card styling (from pharmacist dashboard) */
  .drug-card {
    transition: all 0.3s ease;
  }

  .drug-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  .price-value {
    font-family: 'Courier New', monospace;
    font-weight: 600;
  }

  /* Controlled drugs grid: 3 columns, 2 visible rows, then scroll */
  .controlled-drugs-grid {
    max-height: 360px; /* ~2 compact rows */
    overflow-y: auto;
    overflow-x: hidden;
    padding-right: 6px;
  }

  /* Make cards compact and left-aligned */
  .controlled-drug-card {
    height: 170px;
  }

  .controlled-drug-card .card-body {
    padding: 10px;
    text-align: left;
  }

  .controlled-drug-card .badge {
    align-self: flex-start;
  }

  /* Stock badge: no background; color indicates status */
  .stock-badge {
    background: transparent !important;
  }

  /* Keep all buttons on a single row */
  .controlled-drug-actions {
    display: flex;
    gap: 8px;
    flex-wrap: nowrap;
    align-items: center;
    justify-content: flex-start;
  }

  @media (min-width: 320px) and (max-width: 480px) {
    /* On smaller screens allow natural height */
    .controlled-drugs-grid { max-height: none; }
    .controlled-drug-card { height: auto; }
    .controlled-drug-actions { flex-wrap: wrap; }
  }
</style>

<div class="container-fluid py-3">
  {# Flash Messages (embed only; base.html already renders flashes) #}
  {% if is_embed %}
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-auto-close" role="alert">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  {% endif %}

  <div class="row g-3">
    <!-- Inventory + Inline Cart (same window) -->
    <div class="col-12">
      <div class="row g-3">
        <div class="col-lg-8">
          <div class="card shadow-sm h-100">
            <div class="card-body">

              {% if controlled_drugs %}
                <div class="controlled-drugs-grid">
                  <div class="row g-3" id="controlledDrugCards">
                  {% for d in controlled_drugs %}
                    {% set rem = d.remaining_quantity %}
                    <div class="col-12 col-md-6 col-lg-4" data-controlled-drug-card
                         data-name="{{ (d.name or '')|lower|e }}"
                         data-number="{{ (d.controlled_drug_number or '')|lower|e }}"
                         data-spec="{{ (d.specification or '')|lower|e }}"
                         data-remaining="{{ rem }}">
                      <div class="card drug-card h-100 controlled-drug-card">
                        <div class="card-body">
                          <div class="fw-semibold" style="font-size: .9rem;">{{ d.name }}</div>
                          <div class="text-muted" style="font-size: .8rem;">{{ d.controlled_drug_number }}</div>
                          <div class="text-muted mt-2" style="font-size: .8rem;">{{ d.specification or '-' }}</div>

                          <div class="mt-2">
                            <span class="badge stock-badge {% if rem <= 0 %}text-danger{% elif rem < 10 %}text-warning{% else %}text-success{% endif %}">Stock: {{ rem }}</span>
                          </div>

                          <div class="mt-2">
                            <span class="price-value" style="font-size: .9rem;">Ksh {{ "%.2f"|format(d.selling_price) }}</span>
                            <span class="text-muted" style="font-size: .8rem;">per unit</span>
                          </div>

                          <div class="controlled-drug-actions mt-3">
                            <button class="btn btn-warning btn-sm" data-action="rx" data-id="{{ d.id }}" data-name="{{ d.name|e }}" style="font-size: .8rem; padding: .2rem .45rem;">
                              <i class="bi bi-journal-medical"></i> Rx
                            </button>
                            <button class="btn btn-info btn-sm" data-action="dosage" data-id="{{ d.id }}" data-name="{{ d.name|e }}" style="font-size: .8rem; padding: .2rem .45rem;">
                              <i class="bi bi-info-circle"></i> Dosage
                            </button>
                            <button class="btn btn-primary btn-sm" data-action="add" data-id="{{ d.id }}" data-name="{{ d.name|e }}" data-number="{{ d.controlled_drug_number }}" data-price="{{ d.selling_price }}" data-remaining="{{ d.remaining_quantity }}" {% if rem <= 0 %}disabled{% endif %} style="font-size: .8rem; padding: .2rem .45rem;">
                              <i class="bi bi-cart-plus"></i> Add
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                  </div>
                </div>
                <div class="text-center text-muted py-4" id="controlledDrugNoMatches" style="display:none;">No matching controlled drugs.</div>
              {% else %}
                <div class="text-center text-muted py-4">No controlled drugs found. Ask admin to add them in Admin.</div>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card shadow-sm h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <div class="fw-semibold"><i class="bi bi-cart"></i> Cart</div>
              <span class="badge bg-primary" id="controlledCartCountInline">0</span>
            </div>
            <div class="card-body">
              <div id="controlledCartInlineTable" class="border rounded p-2" style="max-height: 55vh; overflow: auto;"></div>

              <div class="fw-semibold mt-3">Total: Ksh <span id="controlledCartGrandTotalInline">0.00</span></div>

              <div class="d-flex justify-content-between align-items-center mt-3 gap-2">
                <button class="btn btn-danger btn-sm" type="button" id="clearControlledCartBtnInline" style="font-size: .8rem; padding: .35rem .6rem;">
                  <i class="bi bi-trash"></i> Clear Cart
                </button>
                <button class="btn btn-success btn-sm" type="button" id="openControlledCartBtnInline" style="font-size: .8rem; padding: .35rem .6rem;">
                  <i class="bi bi-check-circle"></i> Proceed to Checkout
                </button>
              </div>
              <div class="text-muted small mt-2">Checkout opens the camera-only capture step.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">Stored Controlled Receipts</h6>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive mt-3">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th>Sale No.</th>
                  <th>Date</th>
                  <th>Customer</th>
                  <th>Phone</th>
                  <th>Total</th>
                  <th style="width: 200px;">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% if controlled_sales %}
                  {% for s in controlled_sales %}
                    <tr>
                      <td class="fw-semibold">{{ s.sale_number }}</td>
                      <td>{{ s.created_at.strftime('%Y-%m-%d %H:%M') if s.created_at else '' }}</td>
                      <td>{{ s.customer_name or (decrypt_data(s.patient.name) if s.patient else 'Walk-in') }}</td>
                      <td>{{ s.customer_phone or (decrypt_data(s.patient.phone) if s.patient else '') }}</td>
                      <td>Ksh {{ '%.2f'|format(s.total_amount or 0) }}</td>
                      <td>
                        <div class="d-flex gap-2">
                          <a class="btn btn-sm btn-outline-primary" href="{{ url_for('pharmacist_controlled_sale_receipt', sale_id=s.id) }}?embed=1"><i class="bi bi-receipt"></i> Receipt</a>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr><td colspan="6" class="text-center text-muted py-4">No receipts found.</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Dosage Modal -->
<div class="modal fade" id="controlledDosageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-info-circle"></i> Dosage</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-muted mb-2" id="controlledDosageSource"></div>
        <div id="controlledDosageBody" class="small text-muted">Loading...</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- In-system controlled prescriptions UI is handled elsewhere (Controlled Prescriptions section). -->

<!-- Rx Modal (per-cart item) -->
<div class="modal fade" id="controlledRxItemModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Rx Instructions</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-light border py-2">
          Drug: <span class="fw-semibold" id="rxItemDrugName">-</span>
        </div>
        <input type="hidden" id="rxItemDrugId" />
        <div class="mb-2">
          <label class="form-label">Dosage</label>
          <input class="form-control" id="rxDosage" placeholder="e.g. 1 tab" />
        </div>
        <div class="mb-2">
          <label class="form-label">Frequency</label>
          <input class="form-control" id="rxFrequency" placeholder="e.g. BID" />
        </div>
        <div class="mb-2">
          <label class="form-label">Duration</label>
          <input class="form-control" id="rxDuration" placeholder="e.g. 5 days" />
        </div>
        <div class="mb-2">
          <label class="form-label">Notes</label>
          <textarea class="form-control" id="rxNotes" rows="3" placeholder="Additional instructions"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" id="saveRxItemBtn">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Cart + Checkout Modal -->
<div class="modal fade" id="controlledCartModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-cart"></i> Controlled Cart</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="controlledCartTable" class="border rounded p-2" style="max-height: 280px; overflow: auto;"></div>
        <div class="d-flex justify-content-between align-items-center mt-2">
          <div class="text-muted">Camera capture is required at checkout.</div>
          <div class="fw-semibold">Grand Total: Ksh <span id="controlledCartGrandTotal">0.00</span></div>
        </div>

        <hr>

        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Payment Method</label>
            <select class="form-select" id="controlledCheckoutPaymentMethod">
              <option value="cash">Cash</option>
              <option value="mpesa">M-Pesa</option>
              <option value="card">Card</option>
              <option value="insurance">Insurance</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Patient (optional)</label>
            <select class="form-select" id="controlled_patient_select" style="width: 100%;">
              <option value="">Walk-in</option>
            </select>
          </div>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-md-4">
            <label class="form-label">Customer Name *</label>
            <input class="form-control" id="controlledCustomerName" required />
          </div>
          <div class="col-md-2">
            <label class="form-label">Age *</label>
            <input class="form-control" type="number" min="0" id="controlledCustomerAge" required />
          </div>
          <div class="col-md-2">
            <label class="form-label">Sex *</label>
            <select class="form-select" id="controlledCustomerGender" required>
              <option value="">Select</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Phone *</label>
            <input class="form-control" id="controlledCustomerPhone" required />
          </div>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-md-6">
            <label class="form-label">Diagnosis (Dx) *</label>
            <input class="form-control" id="controlledDiagnosis" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Destination *</label>
            <input class="form-control" id="controlledDestination" required />
          </div>
        </div>

        <div class="mt-3">
          <div class="d-flex justify-content-between align-items-center">
            <div class="fw-semibold">Prescription Photo (Camera Only) *</div>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary" type="button" id="startControlledCameraBtn"><i class="bi bi-camera-video"></i> Start camera</button>
              <button class="btn btn-sm btn-primary" type="button" id="captureControlledPhotoBtn" disabled><i class="bi bi-camera"></i> Capture</button>
              <button class="btn btn-sm btn-outline-warning" type="button" id="retakeControlledPhotoBtn" disabled><i class="bi bi-arrow-clockwise"></i> Retake</button>
              <button class="btn btn-sm btn-outline-secondary" type="button" id="stopControlledCameraBtn" disabled>Stop</button>
            </div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col-md-6">
              <video id="controlledCameraVideo" class="w-100 border rounded" autoplay playsinline style="max-height: 240px; background: #000;"></video>
            </div>
            <div class="col-md-6">
              <img id="controlledCapturedPreview" class="w-100 border rounded" alt="Captured" style="max-height: 240px; object-fit: contain; display:none;" />
              <div class="text-muted small mt-1" id="controlledCapturedStatus">No photo captured.</div>
            </div>
          </div>
          <canvas id="controlledCaptureCanvas" style="display:none;"></canvas>
        </div>
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <button class="btn btn-outline-danger" type="button" id="clearControlledCartBtnModal"><i class="bi bi-trash"></i> Clear Cart</button>
        <div class="d-flex gap-2">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-primary" id="controlledCheckoutBtn"><i class="bi bi-check2-circle"></i> Sell & Store Receipt</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
  let cart = [];
  const CART_STORAGE_KEY = 'controlledCartV1';
  let cameraStream = null;
  let capturedBlob = null;
  let capturedObjectUrl = null;

  function modal(id) {
    return new bootstrap.Modal(document.getElementById(id));
  }

  function money(n) {
    const num = Number(n || 0);
    return num.toFixed(2);
  }

  function normalizeCartItem(raw) {
    if (!raw) return null;
    const id = Number(raw.id);
    if (!id) return null;
    return {
      id,
      number: raw.number || '',
      name: raw.name || '',
      unit_price: Number(raw.unit_price ?? raw.price ?? 0),
      remaining: Number(raw.remaining ?? 999999),
      quantity: Math.max(1, Number(raw.quantity ?? 1)),
      dosage: raw.dosage || '',
      frequency: raw.frequency || '',
      duration: raw.duration || '',
      notes: raw.notes || ''
    };
  }

  function saveCartToStorage() {
    try {
      localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
    } catch (_) {
      // ignore
    }
  }

  function loadCartFromStorage() {
    try {
      const raw = localStorage.getItem(CART_STORAGE_KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed)) return;
      cart = parsed.map(normalizeCartItem).filter(Boolean);
    } catch (_) {
      // ignore
    }
  }

  function cartCount() {
    return cart.reduce((a, i) => a + (Number(i.quantity) || 0), 0);
  }

  function updateCartBadge() {
    const el = document.getElementById('controlledCartCount');
    if (el) el.textContent = String(cartCount());

    const inline = document.getElementById('controlledCartCountInline');
    if (inline) inline.textContent = String(cartCount());
  }

  function cartGrandTotal() {
    return cart.reduce((a, i) => a + (Number(i.unit_price) || 0) * (Number(i.quantity) || 0), 0);
  }

  function renderCart() {
    renderCartModal();
    renderCartInline();
    updateCartBadge();
    saveCartToStorage();
  }

  function renderCartModal() {
    const container = document.getElementById('controlledCartTable');
    if (!container) return;

    if (!cart.length) {
      container.innerHTML = `
        <div class="text-center py-4 text-muted">
          <i class="bi bi-cart-x" style="font-size: 3rem;"></i>
          <p class="mb-0">Your cart is empty</p>
        </div>
      `;
      document.getElementById('controlledCartGrandTotal').textContent = '0.00';
      return;
    }

    container.innerHTML = cart.map(i => {
      const lineTotal = (Number(i.unit_price) || 0) * (Number(i.quantity) || 0);
      const rxSummary = [i.dosage, i.frequency, i.duration].filter(Boolean).join(' · ');
      return `
        <div class="py-2 border-bottom" data-id="${i.id}">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <div class="fw-semibold">${i.name}</div>
              <div class="text-muted small">${i.number || ''}</div>
              ${rxSummary ? `<div class="text-muted small">Rx: ${rxSummary}</div>` : ''}
              <div class="mt-1">
                <span class="text-muted">Ksh ${money(i.unit_price)}</span> ×
                <input type="number" min="1" value="${i.quantity}" data-cart-qty="${i.id}"
                  class="form-control form-control-sm d-inline-block ms-2" style="max-width: 80px;" />
                = <span class="fw-semibold">Ksh ${money(lineTotal)}</span>
              </div>
            </div>
            <div class="d-flex flex-column gap-2 ms-2">
              <button class="btn btn-sm btn-outline-secondary" data-cart-action="rx" data-id="${i.id}"><i class="bi bi-journal-medical"></i> Rx</button>
              <button class="btn btn-sm btn-outline-danger" data-cart-action="remove" data-id="${i.id}"><i class="bi bi-trash"></i></button>
            </div>
          </div>
        </div>
      `;
    }).join('');

    document.getElementById('controlledCartGrandTotal').textContent = money(cartGrandTotal());
  }

  function renderCartInline() {
    const container = document.getElementById('controlledCartInlineTable');
    if (!container) return;

    if (!cart.length) {
      container.innerHTML = `
        <div class="text-center py-4 text-muted">
          <i class="bi bi-cart-x" style="font-size: 3rem;"></i>
          <p class="mb-0">Your cart is empty</p>
        </div>
      `;
      const totalEl = document.getElementById('controlledCartGrandTotalInline');
      if (totalEl) totalEl.textContent = '0.00';
      return;
    }

    container.innerHTML = cart.map(i => {
      const lineTotal = (Number(i.unit_price) || 0) * (Number(i.quantity) || 0);
      const rxSummary = [i.dosage, i.frequency, i.duration].filter(Boolean).join(' · ');
      return `
        <div class="py-2 border-bottom" data-id="${i.id}">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <div class="fw-semibold">${i.name}</div>
              <div class="text-muted small">${i.number || ''}</div>
              ${rxSummary ? `<div class="text-muted small">Rx: ${rxSummary}</div>` : ''}
              <div class="mt-1">
                <span class="text-muted">Ksh ${money(i.unit_price)}</span> ×
                <input type="number" min="1" value="${i.quantity}" data-inline-cart-qty="${i.id}"
                  class="form-control form-control-sm d-inline-block ms-2" style="max-width: 80px;" />
                = <span class="fw-semibold">Ksh ${money(lineTotal)}</span>
              </div>
            </div>
            <div class="d-flex flex-column gap-2 ms-2">
              <button class="btn btn-sm btn-outline-secondary" data-inline-cart-action="rx" data-id="${i.id}"><i class="bi bi-journal-medical"></i></button>
              <button class="btn btn-sm btn-outline-danger" data-inline-cart-action="remove" data-id="${i.id}"><i class="bi bi-trash"></i></button>
            </div>
          </div>
        </div>
      `;
    }).join('');

    const totalEl = document.getElementById('controlledCartGrandTotalInline');
    if (totalEl) totalEl.textContent = money(cartGrandTotal());
  }

  function upsertCartItem(drug) {
    const existing = cart.find(x => String(x.id) === String(drug.id));
    if (existing) {
      existing.quantity = Math.min((Number(existing.quantity) || 0) + 1, Number(existing.remaining || 999999));
    } else {
      const normalized = normalizeCartItem({
        id: Number(drug.id),
        number: drug.number,
        name: drug.name,
        unit_price: Number(drug.price),
        remaining: Number(drug.remaining),
        quantity: 1
      });
      if (normalized) cart.push(normalized);
    }
    renderCart();
  }

  function clearControlledCart() {
    cart = [];
    saveCartToStorage();
    renderCart();
  }

  function openRxModalForDrug(drugId, drugName) {
    const item = cart.find(x => String(x.id) === String(drugId)) || null;
    document.getElementById('rxItemDrugId').value = String(drugId);
    document.getElementById('rxItemDrugName').textContent = drugName || (item?.name || '-');
    document.getElementById('rxDosage').value = item?.dosage || '';
    document.getElementById('rxFrequency').value = item?.frequency || '';
    document.getElementById('rxDuration').value = item?.duration || '';
    document.getElementById('rxNotes').value = item?.notes || '';
    modal('controlledRxItemModal').show();
  }

  function resetCapturedPhoto() {
    capturedBlob = null;
    const preview = document.getElementById('controlledCapturedPreview');
    const status = document.getElementById('controlledCapturedStatus');
    const retakeBtn = document.getElementById('retakeControlledPhotoBtn');

    if (capturedObjectUrl) {
      try { URL.revokeObjectURL(capturedObjectUrl); } catch (_) {}
      capturedObjectUrl = null;
    }

    if (preview) {
      preview.src = '';
      preview.style.display = 'none';
    }
    if (status) status.textContent = 'No photo captured.';
    if (retakeBtn) retakeBtn.disabled = true;
  }

  async function startCamera() {
    const video = document.getElementById('controlledCameraVideo');
    const startBtn = document.getElementById('startControlledCameraBtn');
    const captureBtn = document.getElementById('captureControlledPhotoBtn');
    const retakeBtn = document.getElementById('retakeControlledPhotoBtn');
    const stopBtn = document.getElementById('stopControlledCameraBtn');

    try {
      if (cameraStream) {
        // Already running
        return;
      }

      cameraStream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: 'environment',
          width: { ideal: 1280 },
          height: { ideal: 720 }
        },
        audio: false
      });
      video.srcObject = cameraStream;
      captureBtn.disabled = false;
      stopBtn.disabled = false;
      startBtn.disabled = true;

      // Retake only makes sense after a capture
      if (retakeBtn && !capturedBlob) retakeBtn.disabled = true;
    } catch (e) {
      const name = e?.name || '';
      let msg = 'Failed to access camera.';
      if (name === 'NotAllowedError') msg = 'Camera permission denied. Please allow camera access.';
      else if (name === 'NotFoundError') msg = 'No camera found on this device.';
      else if (name === 'NotReadableError') msg = 'Camera is busy. Close other apps using the camera and try again.';
      else if (name === 'SecurityError' || name === 'NotSupportedError') msg = 'Camera requires HTTPS (or localhost). Open the app using HTTPS to enable the camera.';
      alert(msg);
    }
  }

  function stopCamera() {
    const video = document.getElementById('controlledCameraVideo');
    const startBtn = document.getElementById('startControlledCameraBtn');
    const captureBtn = document.getElementById('captureControlledPhotoBtn');
    const retakeBtn = document.getElementById('retakeControlledPhotoBtn');
    const stopBtn = document.getElementById('stopControlledCameraBtn');

    if (cameraStream) {
      cameraStream.getTracks().forEach(t => t.stop());
      cameraStream = null;
    }
    video.srcObject = null;
    captureBtn.disabled = true;
    stopBtn.disabled = true;
    startBtn.disabled = false;

    // Keep retake enabled if we already have a captured photo.
    if (retakeBtn) retakeBtn.disabled = !capturedBlob;
  }

  async function capturePhoto() {
    const video = document.getElementById('controlledCameraVideo');
    const canvas = document.getElementById('controlledCaptureCanvas');
    const preview = document.getElementById('controlledCapturedPreview');
    const status = document.getElementById('controlledCapturedStatus');
    const retakeBtn = document.getElementById('retakeControlledPhotoBtn');

    const w = video.videoWidth || 1280;
    const h = video.videoHeight || 720;
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, w, h);

    capturedBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
    if (!capturedBlob) {
      alert('Failed to capture photo.');
      return;
    }

    if (capturedObjectUrl) {
      try { URL.revokeObjectURL(capturedObjectUrl); } catch (_) {}
      capturedObjectUrl = null;
    }

    capturedObjectUrl = URL.createObjectURL(capturedBlob);
    preview.src = capturedObjectUrl;
    preview.style.display = 'block';
    status.textContent = 'Photo captured.';
    if (retakeBtn) retakeBtn.disabled = false;
  }

  async function retakePhoto() {
    resetCapturedPhoto();
    // Ensure camera is running for retake
    await startCamera();
  }

  // In-system controlled prescriptions are handled elsewhere.

  function safeText(v) {
    return (v === null || v === undefined || v === '') ? '-' : String(v);
  }

  function escapeHtml(value) {
    return String(value)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/\"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function splitToBulletItems(text) {
    const raw = (text === null || text === undefined) ? '' : String(text);
    let t = raw.replace(/\r/g, '').trim();
    if (!t) return [];
    t = t.replace(/\s*•\s*/g, '\n• ');
    const lines = t.split('\n').map(s => s.trim()).filter(Boolean);
    const items = [];
    for (const line of lines) {
      const cleaned = line
        .replace(/^([•\u2022\-*]+\s*)/, '')
        .replace(/^\d+[\).]\s*/, '')
        .trim();
      if (cleaned) items.push(cleaned);
    }
    return items.length ? items : [t];
  }

  function renderBullets(text) {
    const items = splitToBulletItems(text);
    if (!items.length) return '<span class="text-muted">-</span>';
    const lis = items.map(i => `<li>${escapeHtml(i)}</li>`).join('');
    return `<ul class="mb-0" style="padding-left: 1.25rem;">${lis}</ul>`;
  }

  function renderDosageBody(payload) {
    const d = payload?.dosage;
    if (!d) {
      return '<div class="text-muted">No dosage information found (DB or index book).</div>';
    }
    const rows = (label, value) => `
      <div class="mb-2">
        <div class="fw-semibold">${label}</div>
        <div class="text-muted">${renderBullets(value)}</div>
      </div>
    `;
    return `
      <div class="mb-2"><span class="fw-semibold">Drug:</span> ${escapeHtml(safeText(payload?.drug?.drug_number))} - ${escapeHtml(safeText(payload?.drug?.name))}</div>
      <hr />
      ${rows('Indication', d.indication)}
      ${rows('Contraindication', d.contraindication)}
      ${rows('Interaction', d.interaction)}
      ${rows('Side Effects', d.side_effects)}
      <hr />
      ${rows('Dosage (Pediatrics)', d.dosage_peds)}
      ${rows('Dosage (Adults)', d.dosage_adults)}
      ${rows('Dosage (Geriatrics)', d.dosage_geriatrics)}
      <hr />
      ${rows('Important Notes', d.important_notes)}
    `;
  }

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action]');
    if (!btn) return;

    if (btn.dataset.action === 'add') {
      const remaining = Number(btn.dataset.remaining || 0);
      if (remaining <= 0) {
        alert('Out of stock.');
        return;
      }
      upsertCartItem({
        id: btn.dataset.id,
        name: btn.dataset.name,
        number: btn.dataset.number,
        price: btn.dataset.price,
        remaining
      });
    }

    if (btn.dataset.action === 'rx') {
      // Ensure item exists in cart before editing Rx
      const id = btn.dataset.id;
      const name = btn.dataset.name;
      if (!cart.find(x => String(x.id) === String(id))) {
        upsertCartItem({
          id,
          name,
          number: btn.dataset.number,
          price: btn.dataset.price,
          remaining: btn.dataset.remaining
        });
      }
      openRxModalForDrug(id, name);
    }

    if (btn.dataset.action === 'dosage') {
      const id = btn.dataset.id;
      const modalEl = document.getElementById('controlledDosageModal');
      const sourceEl = document.getElementById('controlledDosageSource');
      const bodyEl = document.getElementById('controlledDosageBody');
      if (!modalEl || !sourceEl || !bodyEl) return;

      sourceEl.textContent = '';
      bodyEl.innerHTML = '<div class="text-muted">Loading...</div>';
      modal('controlledDosageModal').show();

      fetch(`/pharmacist/controlled-drugs/${id}/dosage`, {
        headers: {
          ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {})
        }
      })
        .then(r => r.json().then(j => ({ ok: r.ok, j })).catch(() => ({ ok: r.ok, j: null })))
        .then(({ ok, j }) => {
          if (!ok || !j) {
            bodyEl.innerHTML = '<div class="text-danger">Failed to load dosage information.</div>';
            return;
          }
          const src = j.source === 'db' ? 'Database' : (j.source === 'index' ? 'Dosage index book' : 'Not available');
          sourceEl.textContent = `Source: ${src}`;
          bodyEl.innerHTML = renderDosageBody(j);
        })
        .catch(() => {
          bodyEl.innerHTML = '<div class="text-danger">Failed to load dosage information.</div>';
        });
    }

    if (btn.dataset.action === 'checkout') {
      // Open checkout. (User can add items first if cart is empty.)
      renderCart();
      modal('controlledCartModal').show();
    }
  });

  document.getElementById('openControlledCartBtn')?.addEventListener('click', () => {
    renderCart();
    modal('controlledCartModal').show();
  });

  document.getElementById('openControlledCartBtnInline')?.addEventListener('click', () => {
    renderCart();
    modal('controlledCartModal').show();
  });

  document.getElementById('clearControlledCartBtnInline')?.addEventListener('click', clearControlledCart);
  document.getElementById('clearControlledCartBtnModal')?.addEventListener('click', clearControlledCart);

  document.getElementById('saveRxItemBtn')?.addEventListener('click', () => {
    const id = document.getElementById('rxItemDrugId').value;
    const item = cart.find(x => String(x.id) === String(id));
    if (!item) return;
    item.dosage = document.getElementById('rxDosage').value || '';
    item.frequency = document.getElementById('rxFrequency').value || '';
    item.duration = document.getElementById('rxDuration').value || '';
    item.notes = document.getElementById('rxNotes').value || '';
    modal('controlledRxItemModal').hide();
    renderCart();
  });

  document.getElementById('controlledCartTable')?.addEventListener('input', (e) => {
    const input = e.target.closest('input[data-cart-qty]');
    if (!input) return;
    const id = input.getAttribute('data-cart-qty');
    const item = cart.find(x => String(x.id) === String(id));
    if (!item) return;
    const v = Math.max(1, Number(input.value || 1));
    item.quantity = Math.min(v, Number(item.remaining || v));
    input.value = String(item.quantity);
    renderCart();
  });

  document.getElementById('controlledCartTable')?.addEventListener('click', (e) => {
    const b = e.target.closest('button[data-cart-action]');
    if (!b) return;
    const id = b.getAttribute('data-id');
    if (b.getAttribute('data-cart-action') === 'remove') {
      cart = cart.filter(x => String(x.id) !== String(id));
      renderCart();
    }
    if (b.getAttribute('data-cart-action') === 'rx') {
      const item = cart.find(x => String(x.id) === String(id));
      openRxModalForDrug(id, item?.name);
    }
  });

  document.getElementById('controlledCartInlineTable')?.addEventListener('input', (e) => {
    const input = e.target.closest('input[data-inline-cart-qty]');
    if (!input) return;
    const id = input.getAttribute('data-inline-cart-qty');
    const item = cart.find(x => String(x.id) === String(id));
    if (!item) return;
    const v = Math.max(1, Number(input.value || 1));
    item.quantity = Math.min(v, Number(item.remaining || v));
    input.value = String(item.quantity);
    renderCart();
  });

  document.getElementById('controlledCartInlineTable')?.addEventListener('click', (e) => {
    const b = e.target.closest('button[data-inline-cart-action]');
    if (!b) return;
    const id = b.getAttribute('data-id');
    if (b.getAttribute('data-inline-cart-action') === 'rx') {
      const item = cart.find(x => String(x.id) === String(id));
      openRxModalForDrug(id, item?.name);
    }
    if (b.getAttribute('data-inline-cart-action') === 'remove') {
      cart = cart.filter(x => String(x.id) !== String(id));
      renderCart();
    }
  });

  // Camera
  document.getElementById('startControlledCameraBtn')?.addEventListener('click', startCamera);
  document.getElementById('stopControlledCameraBtn')?.addEventListener('click', stopCamera);
  document.getElementById('captureControlledPhotoBtn')?.addEventListener('click', capturePhoto);
  document.getElementById('retakeControlledPhotoBtn')?.addEventListener('click', retakePhoto);

  // Auto-start/stop camera with the cart modal lifecycle (camera-only UX)
  const cartModalEl = document.getElementById('controlledCartModal');
  if (cartModalEl) {
    cartModalEl.addEventListener('shown.bs.modal', () => {
      // Triggered by user action (open cart), so should be permitted.
      startCamera();
    });

    cartModalEl.addEventListener('hidden.bs.modal', () => {
      stopCamera();
      resetCapturedPhoto();
    });
  }

  // Patient select2 search
  const controlledPatientSelect = $('#controlled_patient_select');
  if (controlledPatientSelect.length && $.fn.select2) {
    controlledPatientSelect.select2({
      placeholder: 'Search patient (optional)',
      allowClear: true,
      ajax: {
        url: '/api/patients',
        dataType: 'json',
        delay: 250,
        data: params => ({ search: params.term || '', limit: 10 }),
        processResults: (data) => ({
          results: (data || []).map(p => ({
            id: p.id,
            text: `${p.name} (${p.op_number || p.ip_number || 'N/A'})`
          }))
        })
      }
    });
  }

  // Checkout
  document.getElementById('controlledCheckoutBtn')?.addEventListener('click', async () => {
    if (!cart.length) {
      alert('Cart is empty.');
      return;
    }
    const customer_name = (document.getElementById('controlledCustomerName').value || '').trim();
    const customer_age = Number(document.getElementById('controlledCustomerAge').value || 0);
    const customer_gender = (document.getElementById('controlledCustomerGender').value || '').trim();
    const customer_phone = (document.getElementById('controlledCustomerPhone').value || '').trim();
    const diagnosis = (document.getElementById('controlledDiagnosis').value || '').trim();
    const destination = (document.getElementById('controlledDestination').value || '').trim();
    const payment_method = document.getElementById('controlledCheckoutPaymentMethod').value;
    const patient_id = controlledPatientSelect.val() || '';

    if (!customer_name || !customer_gender || !customer_phone || !diagnosis || !destination) {
      alert('Please fill in all required customer fields.');
      return;
    }
    if (!capturedBlob) {
      alert('Prescription photo is required. Start camera and capture a photo.');
      return;
    }

    const payload = {
      items: cart.map(i => ({
        controlled_drug_id: i.id,
        quantity: i.quantity,
        unit_price: i.unit_price,
        dosage: i.dosage,
        frequency: i.frequency,
        duration: i.duration,
        notes: i.notes
      })),
      payment_method,
      patient_id: patient_id ? Number(patient_id) : null,
      customer_name,
      customer_age,
      customer_gender,
      customer_phone,
      diagnosis,
      destination
    };

    const form = new FormData();
    form.append('cart', JSON.stringify(payload));
    form.append('prescription_image', capturedBlob, 'prescription.jpg');

    const res = await fetch('/pharmacist/controlled/cart-sale', {
      method: 'POST',
      headers: csrfToken ? { 'X-CSRFToken': csrfToken } : {},
      body: form
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok || !data.success) {
      alert(data.error || 'Failed to process controlled sale');
      return;
    }

    // Reset
    cart = [];
    saveCartToStorage();
    resetCapturedPhoto();
    stopCamera();
    renderCart();
    modal('controlledCartModal').hide();

    window.location.href = `/pharmacist/controlled/sale/${data.sale_id}/receipt?embed=1`;
  });

  function filterControlledDrugCards(opts) {
    const qRaw = (opts && typeof opts.search === 'string')
      ? opts.search
      : (document.getElementById('controlledDrugSearchInput')?.value || '');
    const filterRaw = (opts && typeof opts.filter === 'string')
      ? opts.filter
      : (document.getElementById('controlledDrugFilterSelect')?.value || 'all');
    const q = (qRaw || '').trim().toLowerCase();
    const filter = (filterRaw || 'all').trim();
    const cards = Array.from(document.querySelectorAll('[data-controlled-drug-card]'));
    const noMatches = document.getElementById('controlledDrugNoMatches');
    let visible = 0;

    for (const el of cards) {
      const name = el.getAttribute('data-name') || '';
      const number = el.getAttribute('data-number') || '';
      const spec = el.getAttribute('data-spec') || '';
      const remaining = Number(el.getAttribute('data-remaining') || '0');

      const matchesText = !q || name.includes(q) || number.includes(q) || spec.includes(q);

      let matchesFilter = true;
      if (filter === 'in') matchesFilter = remaining > 0;
      else if (filter === 'low') matchesFilter = remaining > 0 && remaining < 10;
      else if (filter === 'out') matchesFilter = remaining === 0;

      const show = matchesText && matchesFilter;
      el.style.display = show ? '' : 'none';
      if (show) visible += 1;
    }

    if (noMatches) noMatches.style.display = visible === 0 ? '' : 'none';

    // Keep URL in sync without reloading (useful in iframe/dashboard embed)
    try {
      const url = new URL(window.location.href);
      if (q) url.searchParams.set('search', q);
      else url.searchParams.delete('search');
      if (filter && filter !== 'all') url.searchParams.set('filter', filter);
      else url.searchParams.delete('filter');
      window.history.replaceState({}, '', url.toString());
    } catch (e) {
      // ignore
    }
  }

  function debounce(fn, delayMs) {
    let t;
    return function(...args) {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), delayMs);
    };
  }

  const debouncedFilter = debounce(filterControlledDrugCards, 150);
  document.getElementById('controlledDrugSearchInput')?.addEventListener('input', debouncedFilter);
  document.getElementById('controlledDrugFilterSelect')?.addEventListener('change', filterControlledDrugCards);
  // Initialize from URL (supports dashboard embed controls + direct links)
  try {
    const params = new URLSearchParams(window.location.search);
    const search = params.get('search') || '';
    const filter = params.get('filter') || 'all';
    const searchInput = document.getElementById('controlledDrugSearchInput');
    const filterSelect = document.getElementById('controlledDrugFilterSelect');
    if (searchInput && search) searchInput.value = search;
    if (filterSelect && filter) filterSelect.value = filter;
    filterControlledDrugCards({ search, filter });
  } catch (e) {
    filterControlledDrugCards();
  }

  // Allow dashboard (same-origin) to update search/filter instantly without reloading
  window.addEventListener('message', (event) => {
    if (event.origin !== window.location.origin) return;
    const data = event.data || {};
    if (data.type !== 'controlled_inventory_filter') return;
    const search = typeof data.search === 'string' ? data.search : '';
    const filter = typeof data.filter === 'string' ? data.filter : 'all';
    const searchInput = document.getElementById('controlledDrugSearchInput');
    const filterSelect = document.getElementById('controlledDrugFilterSelect');
    if (searchInput) searchInput.value = search;
    if (filterSelect) filterSelect.value = filter;
    filterControlledDrugCards({ search, filter });
  });

  loadCartFromStorage();
  renderCart();
})();
</script>
{% if not is_embed %}
{% endblock %}
{% endif %}
