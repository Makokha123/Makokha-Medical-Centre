{% extends "base.html" %}

{% block title %}Controlled Drug Inventory{% endblock %}

{% block content %}
<div class="container-fluid py-3">
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <div>
      <h2 class="mb-1"><i class="bi bi-shield-lock"></i> Controlled Drug Inventory</h2>
      <div class="text-muted">Dispense controlled drugs (internal prescriptions) and record external/OTC controlled sales (requires prescription sheet).</div>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-primary" id="refreshControlledPrescriptions">
        <i class="bi bi-arrow-repeat"></i> Refresh
      </button>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="row g-3">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="fw-semibold">Pending Controlled Prescriptions (In-System)</div>
          <span class="badge bg-primary" id="controlledRxCount">0</span>
        </div>
        <div class="card-body table-responsive">
          <table class="table table-hover align-middle mb-0" id="controlledRxTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Patient</th>
                <th>Doctor</th>
                <th>Date</th>
                <th>Items</th>
                <th style="width: 180px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="6" class="text-center text-muted py-4">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="fw-semibold">Controlled Drugs (External/OTC Sales)</div>
          <div class="text-muted small">External/OTC requires prescription sheet upload</div>
        </div>
        <div class="card-body table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead>
              <tr>
                <th>Drug No.</th>
                <th>Name</th>
                <th>Specification</th>
                <th>Price</th>
                <th>Remaining</th>
                <th style="width: 180px;">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for d in controlled_drugs %}
                <tr>
                  <td class="fw-semibold">{{ d.controlled_drug_number }}</td>
                  <td>{{ d.name }}</td>
                  <td class="text-muted">{{ d.specification or '-' }}</td>
                  <td>Ksh {{ "%.2f"|format(d.selling_price) }}</td>
                  <td>
                    {% set rem = d.remaining_quantity %}
                    <span class="badge {% if rem <= 0 %}bg-danger{% elif rem < 10 %}bg-warning text-dark{% else %}bg-success{% endif %}">{{ rem }}</span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="external" data-id="{{ d.id }}" data-name="{{ d.name|e }}">
                      <i class="bi bi-file-earmark-arrow-up"></i> External Sale
                    </button>
                  </td>
                </tr>
              {% endfor %}
              {% if not controlled_drugs %}
                <tr>
                  <td colspan="6" class="text-center text-muted py-4">No controlled drugs found. Ask admin to add them in Controlled Drugs.</td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="controlledRxDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Controlled Prescription Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="controlledRxDetails" class="text-muted">Loading...</div>
      </div>
      <div class="modal-footer">
        <select class="form-select" id="controlledRxPaymentMethod" style="max-width: 220px;">
          <option value="cash">Cash</option>
          <option value="mpesa">M-Pesa</option>
          <option value="card">Card</option>
          <option value="insurance">Insurance</option>
        </select>
        <button type="button" class="btn btn-primary" id="controlledRxDispenseBtn">
          <i class="bi bi-check2-circle"></i> Dispense
        </button>
      </div>
    </div>
  </div>
</div>

<!-- External Sale Modal -->
<div class="modal fade" id="externalControlledSaleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">External / OTC Controlled Sale</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('pharmacist_controlled_external_sale') }}" enctype="multipart/form-data" id="externalControlledSaleForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="controlled_drug_id" id="external_controlled_drug_id">
        <div class="modal-body">
          <div class="alert alert-info py-2">
            Selected: <span class="fw-semibold" id="external_controlled_drug_name">-</span>
          </div>

          <div class="mb-3">
            <label class="form-label">Quantity *</label>
            <input class="form-control" type="number" name="quantity" min="1" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Patient (optional for OTC)</label>
            <select class="form-select" name="patient_id" id="external_patient_select" style="width: 100%;">
              <option value="">Walk-in / OTC</option>
            </select>
            <div class="form-text">Leave blank for OTC. Prescription sheet is still required.</div>
          </div>

          <div class="mb-3">
            <label class="form-label">Payment Method</label>
            <select class="form-select" name="payment_method">
              <option value="cash">Cash</option>
              <option value="mpesa">M-Pesa</option>
              <option value="card">Card</option>
              <option value="insurance">Insurance</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Prescription Sheet (image/pdf) *</label>
            <input class="form-control" type="file" name="prescription_sheet" accept=".jpg,.jpeg,.png,.webp,.pdf" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Record Sale</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function() {
  const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
  let activeControlledPrescriptionId = null;

  function modal(id) {
    return new bootstrap.Modal(document.getElementById(id));
  }

  async function loadControlledPrescriptions() {
    const tbody = document.querySelector('#controlledRxTable tbody');
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">Loading...</td></tr>';

    const res = await fetch('/pharmacist/api/controlled-prescriptions', {
      headers: csrfToken ? { 'X-CSRFToken': csrfToken } : {}
    });

    if (!res.ok) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger py-4">Failed to load controlled prescriptions</td></tr>';
      return;
    }

    const data = await res.json();
    document.getElementById('controlledRxCount').textContent = data.length;

    if (!data.length) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No pending controlled prescriptions.</td></tr>';
      return;
    }

    tbody.innerHTML = data.map(r => `
      <tr>
        <td class="fw-semibold">${r.id}</td>
        <td>${r.patient_name} <div class="text-muted small">${r.patient_number || ''}</div></td>
        <td>${r.doctor_name}</td>
        <td>${r.created_at}</td>
        <td><span class="badge bg-light text-dark">${r.items_count}</span></td>
        <td>
          <button class="btn btn-sm btn-outline-primary" data-action="view-rx" data-id="${r.id}"><i class="bi bi-eye"></i> View</button>
        </td>
      </tr>
    `).join('');
  }

  async function showControlledRxDetails(id) {
    activeControlledPrescriptionId = id;
    document.getElementById('controlledRxDetails').textContent = 'Loading...';

    const res = await fetch(`/pharmacist/api/controlled-prescription/${id}`, {
      headers: csrfToken ? { 'X-CSRFToken': csrfToken } : {}
    });

    if (!res.ok) {
      document.getElementById('controlledRxDetails').innerHTML = '<div class="text-danger">Failed to load details.</div>';
      modal('controlledRxDetailsModal').show();
      return;
    }

    const rx = await res.json();
    const itemsHtml = (rx.items || []).map(i => `
      <tr>
        <td class="fw-semibold">${i.controlled_drug_name}</td>
        <td>${i.controlled_drug_number}</td>
        <td>${i.quantity}</td>
        <td><span class="badge ${i.remaining_quantity < i.quantity ? 'bg-danger' : 'bg-success'}">${i.remaining_quantity}</span></td>
      </tr>
    `).join('');

    document.getElementById('controlledRxDetails').innerHTML = `
      <div class="mb-2"><span class="fw-semibold">Patient:</span> ${rx.patient_name} (${rx.patient_number})</div>
      <div class="mb-2"><span class="fw-semibold">Doctor:</span> ${rx.doctor_name}</div>
      <div class="mb-3"><span class="fw-semibold">Created:</span> ${rx.created_at}</div>
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Drug</th>
              <th>No.</th>
              <th>Qty</th>
              <th>Remaining</th>
            </tr>
          </thead>
          <tbody>${itemsHtml || '<tr><td colspan="4" class="text-muted">No items</td></tr>'}</tbody>
        </table>
      </div>
    `;

    modal('controlledRxDetailsModal').show();
  }

  async function dispenseControlledRx() {
    if (!activeControlledPrescriptionId) return;
    const payment_method = document.getElementById('controlledRxPaymentMethod').value;

    const res = await fetch('/pharmacist/controlled/dispense', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {})
      },
      body: JSON.stringify({
        controlled_prescription_id: activeControlledPrescriptionId,
        payment_method
      })
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok || !data.success) {
      alert(data.error || 'Failed to dispense controlled prescription');
      return;
    }

    modal('controlledRxDetailsModal').hide();
    await loadControlledPrescriptions();
    alert(`Dispensed. Sale: ${data.sale_number} (Ksh ${data.total_amount})`);
  }

  document.getElementById('refreshControlledPrescriptions')?.addEventListener('click', loadControlledPrescriptions);
  document.getElementById('controlledRxDispenseBtn')?.addEventListener('click', dispenseControlledRx);

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action]');
    if (!btn) return;

    if (btn.dataset.action === 'view-rx') {
      showControlledRxDetails(btn.dataset.id);
    }

    if (btn.dataset.action === 'external') {
      document.getElementById('external_controlled_drug_id').value = btn.dataset.id;
      document.getElementById('external_controlled_drug_name').textContent = btn.dataset.name || '-';
      modal('externalControlledSaleModal').show();
    }
  });

  // Patient select2 search
  const patientSelect = $('#external_patient_select');
  if (patientSelect.length && $.fn.select2) {
    patientSelect.select2({
      placeholder: 'Search patient (optional)',
      allowClear: true,
      ajax: {
        url: '/api/patients',
        dataType: 'json',
        delay: 250,
        data: params => ({ search: params.term || '', limit: 10 }),
        processResults: (data) => ({
          results: (data || []).map(p => ({
            id: p.id,
            text: `${p.name} (${p.op_number || p.ip_number || 'N/A'})`
          }))
        })
      }
    });
  }

  loadControlledPrescriptions();
})();
</script>
{% endblock %}
