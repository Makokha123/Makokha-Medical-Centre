{% extends "base.html" %}

{% block content %}
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

<div class="bed-management-container">
    <div class="dashboard-header">
        <div class="header-content">
            <div class="header-title">
                <h1><i class="fas fa-bed"></i> Bed Management</h1>
                <p>Manage wards, beds, and patient assignments</p>
            </div>
            <div class="current-date">
                <span id="current-date"></span>
            </div>
        </div>
    </div>

    {% if is_embed %}
    <div id="alert-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-auto-close" role="alert">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>
    {% endif %}

    <div class="summary-cards-grid">
        <div class="summary-card total-beds">
            <div class="card-icon">
                <i class="fas fa-bed"></i>
            </div>
            <div class="card-content">
                <h3>Total Beds</h3>
                <div class="amount" id="total-beds">{{ total_beds }}</div>
                <p>All beds in hospital</p>
            </div>
        </div>
        
        <div class="summary-card occupied-beds">
            <div class="card-icon">
                <i class="fas fa-user-injured"></i>
            </div>
            <div class="card-content">
                <h3>Occupied Beds</h3>
                <div class="amount" id="occupied-beds">{{ occupied_beds }}</div>
                <p>Currently occupied beds</p>
            </div>
        </div>
        
        <div class="summary-card available-beds">
            <div class="card-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="card-content">
                <h3>Available Beds</h3>
                <div class="amount" id="available-beds">{{ available_beds }}</div>
                <p>Beds ready for patients</p>
            </div>
        </div>
        
        <div class="summary-card total-wards">
            <div class="card-icon">
                <i class="fas fa-hospital"></i>
            </div>
            <div class="card-content">
                <h3>Total Wards</h3>
                <div class="amount" id="total-wards">{{ wards|length }}</div>
                <p>Hospital wards</p>
            </div>
        </div>
    </div>

    <div class="navigation-tabs">
        <div class="tab active" data-tab="wards">
            <i class="fas fa-hospital"></i>
            <span>Wards</span>
        </div>
        <div class="tab" data-tab="beds">
            <i class="fas fa-bed"></i>
            <span>Beds</span>
        </div>
        <div class="tab" data-tab="assignments">
            <i class="fas fa-user-plus"></i>
            <span>Assignments</span>
        </div>
    </div>

    <!-- Wards Tab -->
    <div class="tab-content active" id="wards-tab">
        <div class="section-header">
            <div class="section-title">
                <h2><i class="fas fa-hospital"></i> Ward Management</h2>
                <p>Manage hospital wards and their details</p>
            </div>
            <button class="btn btn-primary btn-with-icon" data-modal-target="add-ward">
                <i class="fas fa-plus"></i> Add Ward
            </button>
        </div>
        <div class="table-container">
            <table id="wards-table" class="modern-table">
                <thead>
                    <tr>
                        <th>Ward Name</th>
                        <th>Description</th>
                        <th>Daily Rate</th>
                        <th>Total Beds</th>
                        <th>Occupied Beds</th>
                        <th>Available Beds</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ward in wards %}
                    {% set ward_beds = beds|selectattr("ward_id", "equalto", ward.id)|list %}
                    {% set occupied_ward_beds = ward_beds|selectattr("status", "equalto", "occupied")|list %}
                    <tr>
                        <td>
                            <div class="ward-info">
                                <i class="fas fa-hospital"></i>
                                <span>{{ ward.name }}</span>
                            </div>
                        </td>
                        <td>{{ ward.description or 'No description' }}</td>
                        <td class="amount-cell">{{ "%.2f"|format(ward.daily_rate or 0) }}</td>
                        <td class="amount-cell">{{ ward_beds|length }}</td>
                        <td class="amount-cell">{{ occupied_ward_beds|length }}</td>
                        <td class="amount-cell">{{ ward_beds|length - occupied_ward_beds|length }}</td>
                        <td class="action-btns">
                            <div class="btn-group">
                                <button class="action-btn btn-primary btn-edit-ward" 
                                        data-ward-id="{{ ward.id }}"
                                        data-ward-name="{{ ward.name }}"
                                        data-ward-description="{{ ward.description if ward.description else '' }}"
                                        data-ward-daily-rate="{{ ward.daily_rate or 0 }}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn btn-danger" 
                                        data-delete-record="{{ ward.id }}" 
                                        data-record-type="ward">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if not wards %}
            <div class="empty-state" id="wards-empty">
                <i class="fas fa-hospital"></i>
                <h3>No wards added yet</h3>
                <p>Add your first ward to get started</p>
                <button class="btn btn-primary" data-modal-target="add-ward">
                    <i class="fas fa-plus"></i> Add Ward
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Beds Tab -->
    <div class="tab-content" id="beds-tab">
        <div class="section-header">
            <div class="section-title">
                <h2><i class="fas fa-bed"></i> Bed Management</h2>
                <p>Manage individual beds and their status</p>
            </div>
            <button class="btn btn-primary btn-with-icon" data-modal-target="add-bed">
                <i class="fas fa-plus"></i> Add Bed
            </button>
        </div>
        <div class="table-container">
            <table id="beds-table" class="modern-table">
                <thead>
                    <tr>
                        <th>Bed Number</th>
                        <th>Ward</th>
                        <th>Status</th>
                        <th>Patient</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bed in beds %}
                    <tr>
                        <td>
                            <div class="bed-info">
                                <i class="fas fa-bed"></i>
                                <span>Bed {{ bed.bed_number }}</span>
                            </div>
                        </td>
                        <td>
                            {% set ward = wards|selectattr("id", "equalto", bed.ward_id)|first %}
                            {{ ward.name if ward else 'Unknown Ward' }}
                        </td>
                        <td>
                            <span class="status-badge {% if bed.status == 'available' %}status-available{% else %}status-occupied{% endif %}">
                                {{ bed.status|title }}
                            </span>
                        </td>
                        <td>
                            {% if bed.patient_id %}
                                {% set patient = patients|selectattr("id", "equalto", bed.patient_id)|first %}
                                {{ patient.decrypted_name if patient else 'Unknown Patient' }}
                            {% else %}
                                <span class="text-muted">Not assigned</span>
                            {% endif %}
                        </td>
                        <td class="action-btns">
                            <div class="btn-group">
                                {% if bed.status == 'available' %}
                                <button class="action-btn btn-success btn-assign-bed" 
                                        data-bed-id="{{ bed.id }}"
                                        data-bed-number="{{ bed.bed_number }}"
                                        data-ward-name="{{ ward.name if ward else 'Unknown' }}">
                                    <i class="fas fa-user-plus"></i>
                                </button>
                                {% else %}
                                <button class="action-btn btn-warning btn-release-bed" 
                                        data-bed-id="{{ bed.id }}"
                                        data-bed-number="{{ bed.bed_number }}"
                                        data-ward-name="{{ ward.name if ward else 'Unknown' }}">
                                    <i class="fas fa-user-minus"></i>
                                </button>
                                {% endif %}
                                <button class="action-btn btn-danger" 
                                        data-delete-record="{{ bed.id }}" 
                                        data-record-type="bed">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if not beds %}
            <div class="empty-state" id="beds-empty">
                <i class="fas fa-bed"></i>
                <h3>No beds added yet</h3>
                <p>Add your first bed to get started</p>
                <button class="btn btn-primary" data-modal-target="add-bed">
                    <i class="fas fa-plus"></i> Add Bed
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Assignments Tab -->
    <div class="tab-content" id="assignments-tab">
        <div class="section-header">
            <div class="section-title">
                <h2><i class="fas fa-user-plus"></i> Patient Assignments</h2>
                <p>Assign and manage patient bed assignments</p>
            </div>
        </div>
        
        <div class="assignments-grid">
            <!-- Available Beds Section -->
            <div class="assignment-section">
                <h3><i class="fas fa-bed text-success"></i> Available Beds</h3>
                <div class="beds-grid">
                    {% for bed in beds if bed.status == 'available' %}
                    {% set ward = wards|selectattr("id", "equalto", bed.ward_id)|first %}
                    <div class="bed-card available bed-card-clickable" data-bed-id="{{ bed.id }}">
                        <div class="bed-header">
                            <i class="fas fa-bed"></i>
                            <span class="bed-number">Bed {{ bed.bed_number }}</span>
                        </div>
                        <div class="bed-details">
                            <span class="ward-name">{{ ward.name if ward else 'Unknown Ward' }}</span>
                            <span class="bed-status available">Available</span>
                        </div>
                        <div class="bed-action">
                            <button class="btn btn-sm btn-success">Assign Patient</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% if not beds|selectattr("status", "equalto", "available") %}
                <div class="empty-section">
                    <i class="fas fa-bed"></i>
                    <p>No available beds</p>
                </div>
                {% endif %}
            </div>

            <!-- Occupied Beds Section -->
            <div class="assignment-section">
                <h3><i class="fas fa-user-injured text-warning"></i> Occupied Beds</h3>
                <div class="beds-grid">
                    {% for bed in beds if bed.status == 'occupied' %}
                    {% set ward = wards|selectattr("id", "equalto", bed.ward_id)|first %}
                    {% set patient = patients|selectattr("id", "equalto", bed.patient_id)|first %}
                    <div class="bed-card occupied">
                        <div class="bed-header">
                            <i class="fas fa-bed"></i>
                            <span class="bed-number">Bed {{ bed.bed_number }}</span>
                        </div>
                        <div class="bed-details">
                            <span class="ward-name">{{ ward.name if ward else 'Unknown Ward' }}</span>
                            <div class="patient-info">
                                <i class="fas fa-user"></i>
                                <span>{{ patient.decrypted_name if patient else 'Unknown Patient' }}</span>
                            </div>
                        </div>
                        <div class="bed-action">
                            <button class="btn btn-sm btn-warning btn-release-bed" 
                                    data-bed-id="{{ bed.id }}"
                                    data-bed-number="{{ bed.bed_number }}"
                                    data-ward-name="{{ ward.name if ward else 'Unknown' }}">
                                Release
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% if not beds|selectattr("status", "equalto", "occupied") %}
                <div class="empty-section">
                    <i class="fas fa-bed"></i>
                    <p>No occupied beds</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Ward Modal -->
<div class="modal" id="add-ward-modal" role="dialog" aria-modal="true" aria-labelledby="add-ward-title">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="add-ward-title">Add New Ward</h2>
            <button class="close-btn" data-modal-target="add-ward">&times;</button>
        </div>
        <form id="add-ward-form" method="POST" action="/admin/beds">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="add_ward">
            <div class="form-group">
                <label for="ward-name">Ward Name *</label>
                <input type="text" id="ward-name" name="ward_name" required>
            </div>
            <div class="form-group">
                <label for="ward-daily-rate">Daily Rate *</label>
                <input type="number" id="ward-daily-rate" name="ward_daily_rate" step="0.01" min="0" value="0" required>
            </div>
            <div class="form-group">
                <label for="ward-description">Description</label>
                <textarea id="ward-description" name="ward_description" placeholder="Optional description of the ward"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn" data-modal-target="add-ward">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Ward</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Ward Modal -->
<div class="modal" id="edit-ward-modal" role="dialog" aria-modal="true" aria-labelledby="edit-ward-title">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="edit-ward-title">Edit Ward</h2>
            <button class="close-btn" data-modal-target="edit-ward">&times;</button>
        </div>
        <form id="edit-ward-form" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="edit_ward">
            <input type="hidden" name="ward_id" id="edit-ward-id">
            <div class="form-group">
                <label for="edit-ward-name">Ward Name *</label>
                <input type="text" id="edit-ward-name" name="ward_name" required>
            </div>
            <div class="form-group">
                <label for="edit-ward-daily-rate">Daily Rate *</label>
                <input type="number" id="edit-ward-daily-rate" name="ward_daily_rate" step="0.01" min="0" required>
            </div>
            <div class="form-group">
                <label for="edit-ward-description">Description</label>
                <textarea id="edit-ward-description" name="ward_description"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn" data-modal-target="edit-ward">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Ward</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Bed Modal -->
<div class="modal" id="add-bed-modal" role="dialog" aria-modal="true" aria-labelledby="add-bed-title">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="add-bed-title">Add New Bed</h2>
            <button class="close-btn" data-modal-target="add-bed">&times;</button>
        </div>
        <form id="add-bed-form" method="POST" action="/admin/beds">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="add_bed">
            <div class="form-group">
                <label for="bed-number">Bed Number *</label>
                <input type="text" id="bed-number" name="bed_number" required placeholder="e.g., 101, A12">
            </div>
            <div class="form-group">
                <label for="ward-select">Ward *</label>
                <select id="ward-select" name="ward_id" required>
                    <option value="">Select a Ward</option>
                    {% for ward in wards %}
                    <option value="{{ ward.id }}">{{ ward.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-actions">
                <button type="button" class="btn" data-modal-target="add-bed">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Bed</button>
            </div>
        </form>
    </div>
</div>

<!-- Assign Bed Modal -->
<div class="modal" id="assign-bed-modal" role="dialog" aria-modal="true" aria-labelledby="assign-bed-title">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="assign-bed-title">Assign Bed to Patient</h2>
            <button class="close-btn" data-modal-target="assign-bed">&times;</button>
        </div>
        <form id="assign-bed-form" method="POST" action="/admin/beds">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="assign_bed">
            <input type="hidden" name="bed_id" id="assign-bed-id">
            <div class="form-group">
                <label>Bed Information</label>
                <div class="info-display">
                    <p id="assign-bed-info">Bed information will appear here</p>
                </div>
            </div>
            <div class="form-group">
                <label for="patient-select">Select Patient *</label>
                <select id="patient-select" name="patient_id" required>
                    <option value="">Select a Patient</option>
                    {% for patient in patients %}
                    <option value="{{ patient.id }}">{{ patient.decrypted_name }} ({{ patient.mrn or 'No MRN' }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-actions">
                <button type="button" class="btn" data-modal-target="assign-bed">Cancel</button>
                <button type="submit" class="btn btn-success">Assign Bed</button>
            </div>
        </form>
    </div>
</div>

<!-- Release Bed Modal -->
<div class="modal" id="release-bed-modal" role="dialog" aria-modal="true" aria-labelledby="release-bed-title">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="release-bed-title">Release Bed</h2>
            <button class="close-btn" data-modal-target="release-bed">&times;</button>
        </div>
        <form id="release-bed-form" method="POST" action="/admin/beds">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="release_bed">
            <input type="hidden" name="bed_id" id="release-bed-id">
            <div class="form-group">
                <label>Bed Information</label>
                <div class="info-display">
                    <p id="release-bed-info">Bed information will appear here</p>
                </div>
            </div>
            <div class="form-group">
                <label>Current Patient</label>
                <div class="info-display">
                    <p id="release-patient-info">Patient information will appear here</p>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn" data-modal-target="release-bed">Cancel</button>
                <button type="submit" class="btn btn-warning">Release Bed</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="delete-confirm-modal" role="dialog" aria-modal="true" aria-labelledby="delete-confirm-title">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="delete-confirm-title">Confirm Deletion</h2>
            <button class="close-btn" data-modal-target="delete-confirm">&times;</button>
        </div>
        <div class="modal-body">
            <p id="delete-confirm-message">Are you sure you want to delete this record?</p>
            <form id="delete-form" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="id" id="delete-record-id">
                <input type="hidden" name="type" id="delete-record-type">
            </form>
        </div>
        <div class="form-actions">
            <button type="button" class="btn" data-modal-target="delete-confirm">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirm-delete-button">Delete</button>
        </div>
    </div>
</div>

<style>
:root {
    --primary: #4361ee;
    --secondary: #6c757d;
    --success: #28a745;
    --danger: #dc3545;
    --warning: #ffc107;
    --info: #17a2b8;
    --light: #f8f9fa;
    --dark: #343a40;
    --white: #ffffff;
    --gray-100: #f8f9fa;
    --gray-200: #e9ecef;
    --gray-300: #dee2e6;
    --gray-400: #ced4da;
    --gray-500: #adb5bd;
    --gray-600: #6c757d;
    --gray-700: #495057;
    --gray-800: #343a40;
    --gray-900: #212529;
    --border-radius: 8px;
    --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    --transition: all 0.3s ease;
}

.bed-management-container {
    padding: 20px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f5f7f9;
    min-height: 100vh;
}

.dashboard-header {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 20px;
    margin-bottom: 24px;
    box-shadow: var(--box-shadow);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-title h1 {
    margin: 0;
    color: var(--gray-800);
    font-size: 28px;
    font-weight: 600;
}

.header-title p {
    margin: 5px 0 0;
    color: var(--gray-600);
    font-size: 16px;
}

.current-date {
    color: var(--gray-600);
    font-weight: 500;
}

.alert {
    padding: 12px 16px;
    border-radius: var(--border-radius);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
}

.alert-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

.alert-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-danger {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.summary-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
}

.summary-card {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 24px;
    box-shadow: var(--box-shadow);
    display: flex;
    align-items: center;
    transition: var(--transition);
}

.summary-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
}

.card-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 16px;
    font-size: 24px;
    color: white;
}

.total-beds .card-icon {
    background: linear-gradient(135deg, #17ead9, #6078ea);
}

.occupied-beds .card-icon {
    background: linear-gradient(135deg, #f5515f, #9f041b);
}

.available-beds .card-icon {
    background: linear-gradient(135deg, #43cea2, #185a9d);
}

.total-wards .card-icon {
    background: linear-gradient(135deg, #ff7e5f, #feb47b);
}

.card-content h3 {
    margin: 0;
    font-size: 16px;
    color: var(--gray-600);
    font-weight: 500;
}

.amount {
    font-size: 24px;
    font-weight: 700;
    margin: 5px 0;
}

.card-content p {
    margin: 0;
    font-size: 14px;
    color: var(--gray-500);
}

.navigation-tabs {
    display: flex;
    background: var(--white);
    border-radius: var(--border-radius);
    margin-bottom: 24px;
    box-shadow: var(--box-shadow);
    overflow: hidden;
}

.tab {
    padding: 16px 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    transition: var(--transition);
    border-bottom: 3px solid transparent;
}

.tab:hover {
    background-color: var(--gray-100);
}

.tab.active {
    border-bottom: 3px solid var(--primary);
    color: var(--primary);
    font-weight: 500;
}

.tab i {
    margin-right: 8px;
    font-size: 18px;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.section-title h2 {
    margin: 0;
    color: var(--gray-800);
    font-size: 24px;
    font-weight: 600;
}

.section-title p {
    margin: 5px 0 0;
    color: var(--gray-600);
    font-size: 14px;
}

.btn {
    padding: 10px 20px;
    border-radius: var(--border-radius);
    border: none;
    cursor: pointer;
    font-weight: 500;
    transition: var(--transition);
}

.btn-primary {
    background: var(--primary);
    color: var(--white);
}

.btn-primary:hover {
    background: #3651d3;
    transform: translateY(-2px);
}

.btn-success {
    background: var(--success);
    color: var(--white);
}

.btn-warning {
    background: var(--warning);
    color: var(--dark);
}

.btn-danger {
    background: var(--danger);
    color: var(--white);
}

.btn-sm {
    padding: 6px 12px;
    font-size: 14px;
}

.btn-with-icon {
    display: flex;
    align-items: center;
    gap: 8px;
}

.modern-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    margin-bottom: 24px;
    overflow: hidden;
}

.modern-table th {
    background-color: #f8f9fa;
    padding: 16px;
    text-align: left;
    font-weight: 600;
    color: var(--gray-700);
    border-bottom: 1px solid var(--gray-300);
}

.modern-table td {
    padding: 16px;
    border-bottom: 1px solid var(--gray-200);
}

.modern-table tr:last-child td {
    border-bottom: none;
}

.modern-table tr:hover {
    background-color: #f8f9fa;
}

.amount-cell {
    font-weight: 600;
    font-family: 'Courier New', monospace;
}

.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
}

.status-available {
    background: #e6f4ea;
    color: #137333;
}

.status-occupied {
    background: #fef7e0;
    color: #b06000;
}

.action-btns {
    white-space: nowrap;
}

.btn-group {
    display: flex;
    gap: 8px;
}

.action-btn {
    width: 36px;
    height: 36px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    transition: var(--transition);
}

.action-btn:hover {
    transform: scale(1.1);
}

.text-center {
    text-align: center;
}

.text-muted {
    color: var(--gray-500);
}

.ward-info, .bed-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.ward-info i, .bed-info i {
    color: var(--primary);
    font-size: 18px;
}

.empty-state {
    padding: 40px 20px;
    text-align: center;
    color: var(--gray-500);
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
}

.empty-state i {
    font-size: 64px;
    margin-bottom: 16px;
    opacity: 0.5;
}

.empty-state h3 {
    margin: 0 0 8px;
    font-size: 20px;
    color: var(--gray-600);
}

.empty-state p {
    margin: 0 0 20px;
}

/* Assignments Grid */
.assignments-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
}

.assignment-section {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 24px;
    box-shadow: var(--box-shadow);
}

.assignment-section h3 {
    margin: 0 0 20px;
    font-size: 18px;
    color: var(--gray-700);
    display: flex;
    align-items: center;
    gap: 10px;
}

.beds-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
}

.bed-card {
    border: 2px solid var(--gray-200);
    border-radius: var(--border-radius);
    padding: 16px;
    transition: var(--transition);
    cursor: pointer;
}

.bed-card.available {
    border-color: var(--success);
}

.bed-card.occupied {
    border-color: var(--warning);
}

.bed-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--box-shadow);
}

.bed-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.bed-header i {
    font-size: 20px;
    color: var(--primary);
}

.bed-number {
    font-weight: 600;
    font-size: 16px;
}

.bed-details {
    display: flex;
    flex-direction: column;
    gap: 5px;
    margin-bottom: 10px;
}

.ward-name {
    font-size: 14px;
    color: var(--gray-600);
}

.bed-status {
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 12px;
    display: inline-block;
    width: fit-content;
}

.bed-status.available {
    background: #e6f4ea;
    color: #137333;
}

.patient-info {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 14px;
}

.patient-info i {
    color: var(--warning);
}

.bed-action {
    text-align: center;
}

.empty-section {
    text-align: center;
    padding: 40px 20px;
    color: var(--gray-500);
}

.empty-section i {
    font-size: 48px;
    margin-bottom: 10px;
    opacity: 0.5;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: var(--white);
    border-radius: var(--border-radius);
    width: 100%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

.modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--gray-200);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    font-size: 20px;
    color: var(--gray-800);
}

.close-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--gray-500);
}

.modal-body {
    padding: 24px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--gray-700);
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--gray-300);
    border-radius: var(--border-radius);
    font-size: 16px;
    transition: var(--transition);
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
}

.info-display {
    background: var(--gray-100);
    padding: 12px;
    border-radius: var(--border-radius);
    border-left: 4px solid var(--primary);
}

.info-display p {
    margin: 0;
    font-weight: 500;
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 24px;
}

/* Responsive Design */
@media (min-width: 481px) and (max-width: 767px) {
    .assignments-grid {
        grid-template-columns: 1fr;
    }
}

@media (min-width: 320px) and (max-width: 480px) {
    .bed-management-container {
        padding: 16px;
    }
    
    .header-content {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }
    
    .summary-cards-grid {
        grid-template-columns: 1fr;
    }
    
    .navigation-tabs {
        flex-wrap: wrap;
    }
    
    .tab {
        flex: 1;
        min-width: 120px;
        justify-content: center;
    }
    
    .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
    }
    
    .beds-grid {
        grid-template-columns: 1fr;
    }
    
    .modal-content {
        width: 95%;
        margin: 20px auto;
    }
    
    .action-btns .btn-group {
        flex-direction: column;
    }
    
    .modern-table {
        display: block;
        overflow-x: auto;
    }
}
</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

<script>
// eslint-disable-next-line no-undef
window.bedManagement = {
    init: function() {
        this.setCurrentDate();
        this.setupEventListeners();
        this.initDataTables();
    },

    setCurrentDate: function() {
        const today = new Date();
        document.getElementById('current-date').textContent = today.toLocaleDateString('en-US', { 
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
        });
    },

    setupEventListeners: function() {
        // Edit ward buttons
        $(document).on('click', '.btn-edit-ward', function() {
            const id = $(this).data('ward-id');
            const name = $(this).data('ward-name');
            const desc = $(this).data('ward-description');
            const rate = $(this).data('ward-daily-rate');
            bedManagement.editWard(id, name, desc, rate);
        });

        // Assign bed buttons
        $(document).on('click', '.btn-assign-bed', function() {
            const id = $(this).data('bed-id');
            const num = $(this).data('bed-number');
            const ward = $(this).data('ward-name');
            bedManagement.assignBed(id, num, ward);
        });

        // Release bed buttons
        $(document).on('click', '.btn-release-bed', function() {
            const id = $(this).data('bed-id');
            const num = $(this).data('bed-number');
            const ward = $(this).data('ward-name');
            bedManagement.releaseBed(id, num, ward);
        });

        // Bed card clicks for assignment
        $(document).on('click', '.bed-card-clickable', function() {
            const bedId = $(this).data('bed-id');
            bedManagement.prepareAssignment(bedId);
        });

        // Tab switching
        $(document).on('click', '.tab', function() {
            const tabId = $(this).data('tab');
            bedManagement.switchTab(tabId);
        });

        // Modal handling
        $(document).on('click', '[data-modal-target]', function() {
            const modalId = $(this).data('modal-target');
            bedManagement.openModal(modalId);
        });

        $(document).on('click', '.close-btn', function() {
            const modal = $(this).closest('.modal');
            const modalId = modal.attr('id').replace('-modal', '');
            bedManagement.closeModal(modalId);
        });

        $(document).on('click', '.modal', function(e) {
            if (e.target === this) {
                const modalId = $(this).attr('id').replace('-modal', '');
                bedManagement.closeModal(modalId);
            }
        });

        // Delete confirmation
        $(document).on('click', '[data-delete-record]', function() {
            const recordId = $(this).data('delete-record');
            const recordType = $(this).data('record-type');
            bedManagement.confirmDeleteRecord(recordId, recordType);
        });

        // Confirm delete button
        $(document).on('click', '#confirm-delete-button', function() {
            bedManagement.confirmDelete();
        });

        // Form submissions
        this.setupFormSubmissions();
    },

    setupFormSubmissions: function() {
        $('form[id$="-form"]').on('submit', function(e) {
            e.preventDefault();
            const form = $(this);
            const action = form.attr('action');
            const method = form.attr('method') || 'POST';
            const formData = new FormData(this);

            fetch(action, {
                method: method,
                body: formData,
                headers: {
                    'X-CSRFToken': bedManagement.getCSRFToken()
                }
            })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                    return;
                }
                return response.json();
            })
            .then(data => {
                if (data && data.error) {
                    bedManagement.showAlert('danger', data.error);
                    return;
                }
                if (data && data.success) {
                    const modalId = form.closest('.modal').attr('id').replace('-modal', '');
                    bedManagement.closeModal(modalId);
                    bedManagement.showAlert('success', 'Operation completed successfully');
                    
                    // Refresh the page to show updated data
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                bedManagement.showAlert('danger', 'An error occurred. Please try again.');
            });
        });
    },

    initDataTables: function() {
        $('.table-container table').each(function() {
            if (!$.fn.DataTable.isDataTable(this)) {
                $(this).DataTable({
                    responsive: true,
                    pageLength: 10,
                    lengthMenu: [5, 10, 25, 50, 100],
                    scrollX: true,
                    language: {
                        search: "_INPUT_",
                        searchPlaceholder: "Search...",
                    }
                });
            }
        });
    },

    switchTab: function(tabId) {
        $('.tab').removeClass('active');
        $(`.tab[data-tab="${tabId}"]`).addClass('active');

        $('.tab-content').removeClass('active');
        $(`#${tabId}-tab`).addClass('active');
    },

    openModal: function(modalId) {
        $(`#${modalId}-modal`).css('display', 'flex');
        $('body').css('overflow', 'hidden');
    },

    closeModal: function(modalId) {
        $(`#${modalId}-modal`).hide();
        $('body').css('overflow', '');
    },

    // Ward functions
    editWard: function(id, name, description, dailyRate) {
        $('#edit-ward-id').val(id);
        $('#edit-ward-name').val(name);
        $('#edit-ward-description').val(description || '');
        $('#edit-ward-daily-rate').val(dailyRate ?? 0);
        $('#edit-ward-form').attr('action', '/admin/beds');
        this.openModal('edit-ward');
    },

    // Bed functions
    assignBed: function(bedId, bedNumber, wardName) {
        $('#assign-bed-id').val(bedId);
        $('#assign-bed-info').text(`Bed ${bedNumber} in ${wardName}`);
        $('#assign-bed-form').attr('action', '/admin/beds');
        this.openModal('assign-bed');
    },

    releaseBed: function(bedId, bedNumber, wardName) {
        $('#release-bed-id').val(bedId);
        $('#release-bed-info').text(`Bed ${bedNumber} in ${wardName}`);
        
        // Find patient info for this bed
        const bedRow = $(`[data-delete-record="${bedId}"]`).closest('tr');
        const patientName = bedRow.find('td:eq(3)').text().trim();
        $('#release-patient-info').text(patientName);
        
        $('#release-bed-form').attr('action', '/admin/beds');
        this.openModal('release-bed');
    },

    prepareAssignment: function(bedId) {
        this.assignBed(bedId, 
            $(`[data-delete-record="${bedId}"]`).closest('tr').find('td:eq(0)').text().replace('Bed ', ''),
            $(`[data-delete-record="${bedId}"]`).closest('tr').find('td:eq(1)').text()
        );
    },

    confirmDeleteRecord: function(id, type) {
        $('#delete-record-id').val(id);
        $('#delete-record-type').val(type);
        
        let message = '';
        switch(type) {
            case 'ward': 
                message = 'Are you sure you want to delete this ward? All beds in this ward will also be deleted.';
                break;
            case 'bed': 
                message = 'Are you sure you want to delete this bed?';
                break;
            default: 
                message = 'Are you sure you want to delete this record?';
        }
        
        $('#delete-confirm-message').text(message);
        $('#delete-form').attr('action', '/admin/beds');
        this.openModal('delete-confirm');
    },

    confirmDelete: function() {
        const form = document.getElementById('delete-form');
        const recordId = $('#delete-record-id').val();
        const recordType = $('#delete-record-type').val();
        const formData = new FormData();
        
        formData.append('csrf_token', bedManagement.getCSRFToken());
        formData.append('action', 'delete_' + recordType);
        formData.append(recordType + '_id', recordId);

        fetch('/admin/beds', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': bedManagement.getCSRFToken()
            }
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
                return;
            }
            return response.json();
        })
        .then(data => {
            if (data && data.error) {
                bedManagement.showAlert('danger', data.error);
                return;
            }
            bedManagement.closeModal('delete-confirm');
            bedManagement.showAlert('success', 'Record deleted successfully');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        })
        .catch(err => {
            console.error(err);
            bedManagement.showAlert('danger', 'An error occurred while deleting the record');
        });
    },
    
    getCSRFToken: function() {
        const meta = document.querySelector('meta[name="csrf-token"]');
        if (meta && meta.content) return meta.content;
        const match = document.cookie.match(/(?:^|; )csrf_token=([^;]*)/);
        if (match) return decodeURIComponent(match[1]);
        const alt = document.cookie.match(/(?:^|; )csrf-access-token=([^;]*)/);
        return alt ? decodeURIComponent(alt[1]) : null;
    },
    
    showAlert: function(type, message) {
        if (typeof window.showAlert === 'function') {
            window.showAlert(String(message ?? ''), type || 'info');
            return;
        }
        window.alert(String(message ?? ''));
    }
};

// Initialize when DOM is ready
$(document).ready(function() {
    bedManagement.init();
});
</script>

{% endblock %}