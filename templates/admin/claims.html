{% extends "base.html" %}

{% block title %}Claims Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mt-4">Claims Management</h1>
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-file-invoice-dollar me-1"></i>
            Manage Claims
            <button type="button" class="btn btn-primary btn-sm float-end" data-bs-toggle="modal" data-bs-target="#createClaimModal">
                <i class="fas fa-plus"></i> Create Claim
            </button>
        </div>
        <div class="card-body">
            <table id="claimsTable" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Claim ID</th>
                        <th>Patient</th>
                        <th>Provider</th>
                        <th>Date Filed</th>
                        <th>Total Amount</th>
                        <th>Amount Paid</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for claim in claims %}
                    <tr>
                        <td>{{ claim.id }}</td>
                        <td>{{ claim.patient_insurance.patient.firstname }} {{ claim.patient_insurance.patient.lastname }}</td>
                        <td>{{ claim.patient_insurance.provider.name }}</td>
                        <td>{{ claim.date_filed.strftime('%Y-%m-%d') }}</td>
                        <td>{{ claim.total_amount }}</td>
                        <td>{{ claim.amount_paid or '0.00' }}</td>
                        <td>
                            <span class="badge bg-{{ 'success' if claim.status == 'Paid' else 'warning' if claim.status == 'Pending' else 'danger' }}">{{ claim.status }}</span>
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#viewClaimModal-{{ claim.id }}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editClaimModal-{{ claim.id }}">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create Claim Modal -->
<div class="modal fade" id="createClaimModal" tabindex="-1" aria-labelledby="createClaimModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createClaimModalLabel">Create New Claim</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('create_claim') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="patient_insurance_id" class="form-label">Patient's Insurance Policy</label>
                        <select class="form-control" id="patient_insurance_id" name="patient_insurance_id" required>
                            {% for pi in patient_insurances %}
                                <option value="{{ pi.id }}">{{ pi.patient.firstname }} {{ pi.patient.lastname }} - {{ pi.provider.name }} ({{ pi.policy_number }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="date_filed" class="form-label">Date Filed</label>
                        <input type="date" class="form-control" id="date_filed" name="date_filed" required>
                    </div>
                    <div class="mb-3">
                        <label for="total_amount" class="form-label">Total Amount</label>
                        <input type="number" step="0.01" class="form-control" id="total_amount" name="total_amount" required>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Create Claim</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit and View Claim Modals -->
{% for claim in claims %}
<!-- View Claim Modal -->
<div class="modal fade" id="viewClaimModal-{{ claim.id }}" tabindex="-1" aria-labelledby="viewClaimModalLabel-{{ claim.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewClaimModalLabel-{{ claim.id }}">Claim Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Patient:</strong> {{ claim.patient_insurance.patient.firstname }} {{ claim.patient_insurance.patient.lastname }}</p>
                <p><strong>Provider:</strong> {{ claim.patient_insurance.provider.name }}</p>
                <p><strong>Policy Number:</strong> {{ claim.patient_insurance.policy_number }}</p>
                <p><strong>Date Filed:</strong> {{ claim.date_filed.strftime('%Y-%m-%d') }}</p>
                <p><strong>Total Amount:</strong> {{ claim.total_amount }}</p>
                <p><strong>Amount Paid:</strong> {{ claim.amount_paid or 'N/A' }}</p>
                <p><strong>Date Paid:</strong> {{ claim.date_paid.strftime('%Y-%m-%d') if claim.date_paid else 'N/A' }}</p>
                <p><strong>Status:</strong> {{ claim.status }}</p>
                <p><strong>Notes:</strong> {{ claim.notes or 'None' }}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Claim Modal -->
<div class="modal fade" id="editClaimModal-{{ claim.id }}" tabindex="-1" aria-labelledby="editClaimModalLabel-{{ claim.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editClaimModalLabel-{{ claim.id }}">Update Claim</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('update_claim', claim_id=claim.id) }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label>Patient: {{ claim.patient_insurance.patient.firstname }} {{ claim.patient_insurance.patient.lastname }}</label><br>
                        <label>Provider: {{ claim.patient_insurance.provider.name }}</label>
                    </div>
                    <div class="mb-3">
                        <label for="total_amount-{{ claim.id }}" class="form-label">Total Amount</label>
                        <input type="number" step="0.01" class="form-control" id="total_amount-{{ claim.id }}" name="total_amount" value="{{ claim.total_amount }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="amount_paid-{{ claim.id }}" class="form-label">Amount Paid</label>
                        <input type="number" step="0.01" class="form-control" id="amount_paid-{{ claim.id }}" name="amount_paid" value="{{ claim.amount_paid or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="date_paid-{{ claim.id }}" class="form-label">Date Paid</label>
                        <input type="date" class="form-control" id="date_paid-{{ claim.id }}" name="date_paid" value="{{ claim.date_paid.strftime('%Y-%m-%d') if claim.date_paid }}">
                    </div>
                    <div class="mb-3">
                        <label for="status-{{ claim.id }}" class="form-label">Status</label>
                        <select class="form-control" id="status-{{ claim.id }}" name="status" required>
                            <option value="Pending" {% if claim.status == 'Pending' %}selected{% endif %}>Pending</option>
                            <option value="Paid" {% if claim.status == 'Paid' %}selected{% endif %}>Paid</option>
                            <option value="Rejected" {% if claim.status == 'Rejected' %}selected{% endif %}>Rejected</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="notes-{{ claim.id }}" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes-{{ claim.id }}" name="notes" rows="3">{{ claim.notes or '' }}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    $('#claimsTable').DataTable();
    
    $('#patient_insurance_id').select2({
        dropdownParent: $('#createClaimModal')
    });
});
</script>
{% endblock %}
