{% extends "base.html" %}

{% block title %}Patient Insurance{% endblock %}

{% block content %}
<style>
    .insurance-header-actions {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
    }

    .insurance-table-scroll {
        border: 2px solid #1f2937;
        border-radius: 12px;
        overflow: auto;
        max-height: 70vh;
        background: #fff;
    }

    .insurance-table-scroll table {
        width: max-content;
        min-width: 100%;
        white-space: nowrap;
    }

    .insurance-table-scroll thead th {
        position: sticky;
        top: 0;
        z-index: 5;
        background: #f8f9fa;
    }

    @media (min-width: 320px) and (max-width: 480px) {
        .insurance-header-actions {
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 2px;
        }

        .insurance-header-actions > * {
            flex: 0 0 auto;
        }
    }
</style>

<div class="container-fluid">
    <h1 class="mt-4">Patient Insurance Policies</h1>
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-user-shield me-1"></i>
            Manage Patient Insurance
            <button type="button" class="btn btn-primary btn-sm float-end" data-bs-toggle="modal" data-bs-target="#addPatientInsuranceModal">
                <i class="fas fa-plus"></i> Add Policy
            </button>
        </div>
        <div class="card-body">
            <table id="patientInsuranceTable" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Patient</th>
                        <th>Insurance Provider</th>
                        <th>Policy Number</th>
                        <th>Valid From</th>
                        <th>Valid To</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p_insurance in patient_insurances %}
                    <tr>
                        <td>{{ p_insurance.patient.firstname }} {{ p_insurance.patient.lastname }}</td>
                        <td>{{ p_insurance.provider.name }}</td>
                        <td>{{ p_insurance.policy_number }}</td>
                        <td>{{ p_insurance.valid_from.strftime('%Y-%m-%d') if p_insurance.valid_from }}</td>
                        <td>{{ p_insurance.valid_to.strftime('%Y-%m-%d') if p_insurance.valid_to }}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editPatientInsuranceModal-{{ p_insurance.id }}">
                                <div class="card shadow">
                                    <div class="card-header bg-primary text-white">
                                        <div class="insurance-header-actions">
                                            <h4 class="mb-0">Patient Insurance Policies</h4>
                                            <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#addPolicyModal">
                                                <i class="fas fa-plus"></i> Add Policy
                                            </button>
                                        </div>
                                    </div>
                            </form>
                                        <div class="insurance-table-scroll">
                                            <table class="table table-striped table-bordered" id="patientInsuranceTable">
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Patient Insurance Modal -->
<div class="modal fade" id="addPatientInsuranceModal" tabindex="-1" aria-labelledby="addPatientInsuranceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addPatientInsuranceModalLabel">Add Patient Insurance Policy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('add_patient_insurance') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="patient_id" class="form-label">Patient</label>
                        <select class="form-control" id="patient_id" name="patient_id" required>
                            {% for patient in patients %}
                                <option value="{{ patient.id }}">{{ patient.firstname }} {{ patient.lastname }} (ID: {{ patient.id }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="provider_id" class="form-label">Insurance Provider</label>
                        <select class="form-control" id="provider_id" name="provider_id" required>
                            {% for provider in providers %}
                                <option value="{{ provider.id }}">{{ provider.name }}</option>
                            {% endfor %}
                                            </table>
                                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="policy_number" class="form-label">Policy Number</label>
                        <input type="text" class="form-control" id="policy_number" name="policy_number" required>
                    </div>
                    <div class="mb-3">
                        <label for="valid_from" class="form-label">Valid From</label>
                        <input type="date" class="form-control" id="valid_from" name="valid_from">
                    </div>
                    <div class="mb-3">
                        <label for="valid_to" class="form-label">Valid To</label>
                        <input type="date" class="form-control" id="valid_to" name="valid_to">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Policy</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Patient Insurance Modals -->
{% for p_insurance in patient_insurances %}
<div class="modal fade" id="editPatientInsuranceModal-{{ p_insurance.id }}" tabindex="-1" aria-labelledby="editPatientInsuranceModalLabel-{{ p_insurance.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPatientInsuranceModalLabel-{{ p_insurance.id }}">Edit Patient Insurance Policy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('edit_patient_insurance', patient_insurance_id=p_insurance.id) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="patient_id-{{ p_insurance.id }}" class="form-label">Patient</label>
                        <select class="form-control" id="patient_id-{{ p_insurance.id }}" name="patient_id" required>
                            {% for patient in patients %}
                                <option value="{{ patient.id }}" {% if patient.id == p_insurance.patient_id %}selected{% endif %}>{{ patient.firstname }} {{ patient.lastname }} (ID: {{ patient.id }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="provider_id-{{ p_insurance.id }}" class="form-label">Insurance Provider</label>
                        <select class="form-control" id="provider_id-{{ p_insurance.id }}" name="provider_id" required>
                            {% for provider in providers %}
                                <option value="{{ provider.id }}" {% if provider.id == p_insurance.provider_id %}selected{% endif %}>{{ provider.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="policy_number-{{ p_insurance.id }}" class="form-label">Policy Number</label>
                        <input type="text" class="form-control" id="policy_number-{{ p_insurance.id }}" name="policy_number" value="{{ p_insurance.policy_number }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="valid_from-{{ p_insurance.id }}" class="form-label">Valid From</label>
                        <input type="date" class="form-control" id="valid_from-{{ p_insurance.id }}" name="valid_from" value="{{ p_insurance.valid_from.strftime('%Y-%m-%d') if p_insurance.valid_from }}">
                    </div>
                    <div class="mb-3">
                        <label for="valid_to-{{ p_insurance.id }}" class="form-label">Valid To</label>
                        <input type="date" class="form-control" id="valid_to-{{ p_insurance.id }}" name="valid_to" value="{{ p_insurance.valid_to.strftime('%Y-%m-%d') if p_insurance.valid_to }}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

{% endblock %}

{% block scripts %}
<script id="insurance-ids-data" type="application/json">{{ patient_insurances | map(attribute='id') | list | tojson }}</script>
<script>
$(document).ready(function() {
    $('#patientInsuranceTable').DataTable();
    
    // Initialize Select2 for patient and provider dropdowns
    $('#patient_id, #provider_id').select2({
        dropdownParent: $('#addPatientInsuranceModal')
    });

    try {
        const insuranceIds = JSON.parse(document.getElementById('insurance-ids-data').textContent);
        insuranceIds.forEach(function(id) {
            $('#patient_id-' + id + ', #provider_id-' + id).select2({
                dropdownParent: $('#editPatientInsuranceModal-' + id)
            });
        });
    } catch(e) { }
});
</script>
{% endblock %}
