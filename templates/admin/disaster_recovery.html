{% extends "base.html" %}

{% block content %}
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<div class="content">
    <div class="page-header">
        <h2><i class="fas fa-fire-extinguisher"></i> Disaster Recovery Plans</h2>
        <div class="page-actions">
            <button class="btn btn-primary" data-toggle="modal" data-target="#createRecoveryPlanModal">
                <i class="fas fa-plus"></i> Create New Plan
            </button>
            <a href="{{ url_for('backup_management') }}" class="btn btn-info">
                <i class="fas fa-database"></i> Backup Management
            </a>
        </div>
    </div>
    
    {# Flash Messages (embed only; base.html already renders flashes) #}
    {% if is_embed %}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-auto-close" role="alert">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    {% endif %}
    
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-list"></i> Recovery Plans
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="recoveryPlansTable">
                            <thead>
                                <tr>
                                    <th>Plan Name</th>
                                    <th>RPO (minutes)</th>
                                    <th>RTO (minutes)</th>
                                    <th>Status</th>
                                    <th>Last Tested</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for plan in recovery_plans %}
                                <tr>
                                    <td>{{ plan.name }}</td>
                                    <td>{{ plan.recovery_point_objective }}</td>
                                    <td>{{ plan.recovery_time_objective }}</td>
                                    <td>
                                        <span class="badge badge-{{ 'success' if plan.is_active else 'secondary' }}">
                                            {{ 'Active' if plan.is_active else 'Inactive' }}
                                        </span>
                                    </td>
                                    <td>{{ plan.last_tested.strftime('%Y-%m-%d %H:%M') if plan.last_tested else 'Never' }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-info" data-toggle="modal" data-target="#viewPlanModal" data-id="{{ plan.id }}">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-warning" data-toggle="modal" data-target="#editPlanModal" data-id="{{ plan.id }}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" data-toggle="modal" data-target="#deletePlanModal" data-id="{{ plan.id }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        <form method="POST" action="{{ url_for('disaster_recovery') }}" style="display: inline;">
                                            <input type="hidden" name="action" value="test_recovery_plan">
                                            <input type="hidden" name="plan_id" value="{{ plan.id }}">
                                            <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Test this recovery plan?')">
                                                <i class="fas fa-vial"></i> Test
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Recovery Plan Modal -->
<div class="modal fade" id="createRecoveryPlanModal" tabindex="-1" role="dialog" aria-labelledby="createRecoveryPlanModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createRecoveryPlanModalLabel">Create New Recovery Plan</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="POST" action="{{ url_for('disaster_recovery') }}">
                <input type="hidden" name="action" value="create_recovery_plan">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="planName">Plan Name</label>
                        <input type="text" class="form-control" id="planName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="planDescription">Description</label>
                        <textarea class="form-control" id="planDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="rpo">Recovery Point Objective (RPO) in minutes</label>
                                <input type="number" class="form-control" id="rpo" name="rpo" value="1440" min="1">
                                <small class="form-text text-muted">Maximum acceptable data loss (default 24 hours)</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="rto">Recovery Time Objective (RTO) in minutes</label>
                                <input type="number" class="form-control" id="rto" name="rto" value="240" min="1">
                                <small class="form-text text-muted">Maximum acceptable downtime (default 4 hours)</small>
                            </div>
                        </div>
                    </div>
                    <div class="form-group form-check">
                        <input type="checkbox" class="form-check-input" id="isActive" name="is_active" checked>
                        <label class="form-check-label" for="isActive">Active Plan</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Plan</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Plan Modal -->
<div class="modal fade" id="viewPlanModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Recovery Plan Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="viewPlanModalBody">
                Loading...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript and CSS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>

<script>
$(document).ready(function() {

    function esc(value) {
        return String(value === null || value === undefined ? '' : value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }
    
    // View Plan Modal Handler
    $('#viewPlanModal').on('show.bs.modal', function(event) {
        const button = $(event.relatedTarget);
        const planId = button.data('id');
        const modal = $(this);
        
        $.get(`/admin/recovery_plan/${planId}`, function(data) {
            const nameHtml = esc(data && data.name ? data.name : '');
            const descriptionHtml = esc((data && data.description) ? data.description : 'None');
            const rpo = Number(data && data.recovery_point_objective ? data.recovery_point_objective : 0);
            const rto = Number(data && data.recovery_time_objective ? data.recovery_time_objective : 0);
            const lastTestedHtml = esc((data && data.last_tested) ? new Date(data.last_tested).toLocaleString() : 'Never');
            const testResultsHtml = esc((data && data.test_results) ? data.test_results : 'No test results available');
            modal.find('#viewPlanModalBody').html(`
                <h4>${nameHtml}</h4>
                <p><strong>Status:</strong> <span class="badge badge-${data.is_active ? 'success' : 'secondary'}">
                    ${data.is_active ? 'Active' : 'Inactive'}
                </span></p>
                <p><strong>Description:</strong> ${descriptionHtml}</p>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <h5>Recovery Objectives</h5>
                        <p><strong>RPO:</strong> ${rpo} minutes (${Math.floor(rpo/60)} hours)</p>
                        <p><strong>RTO:</strong> ${rto} minutes (${Math.floor(rto/60)} hours)</p>
                    </div>
                    <div class="col-md-6">
                        <h5>Testing Information</h5>
                        <p><strong>Last Tested:</strong> ${lastTestedHtml}</p>
                        <p><strong>Test Results:</strong> ${testResultsHtml}</p>
                    </div>
                </div>
            `);
        }).fail(function() {
            modal.find('#viewPlanModalBody').html('<div class="alert alert-danger">Failed to load plan details</div>');
        });
    });
});
</script>

<style>
    .badge {
        font-size: 0.85em;
        font-weight: 500;
        padding: 0.35em 0.65em;
    }
    
    .card-header {
        font-weight: 600;
    }
    
    .table td, .table th {
        vertical-align: middle;
    }
    
    .btn-sm {
        min-width: 30px;
    }
</style>
{% endblock %}