{% extends "base.html" %}

{% block content %}
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<div class="content">
    <div class="page-header">
        <h2><i class="fas fa-database"></i> Backup Management</h2>
        <div class="page-actions">
            <button class="btn btn-primary" data-toggle="modal" data-target="#createBackupModal">
                <i class="fas fa-plus"></i> Create New Backup
            </button>
            <a href="{{ url_for('disaster_recovery') }}" class="btn btn-info">
                <i class="fas fa-fire-extinguisher"></i> Disaster Recovery
            </a>
        </div>
    </div>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-history"></i> Backup History
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="backupTable">
                            <thead>
                                <tr>
                                    <th>Backup ID</th>
                                    <th>Date/Time</th>
                                    <th>Type</th>
                                    <th>Size</th>
                                    <th>Status</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for backup in backups %}
                                <tr data-backup-id="{{ backup.id }}" data-status="{{ backup.status }}">
                                    <td>{{ backup.backup_id }}</td>
                                    <td data-order="{{ backup.timestamp.isoformat() }}">{{ backup.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>
                                        <span class="badge badge-{{ 'primary' if backup.backup_type == 'manual' else 'info' }}">
                                            {{ backup.backup_type|title }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if backup.size_bytes %}
                                            {{ (backup.size_bytes / (1024 * 1024))|round(2) }} MB
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set badge_cls = 'success' if backup.status == 'completed' else 'warning' if backup.status == 'in_progress' else 'danger' %}
                                        <span class="badge badge-{{ badge_cls }}">
                                            {{ backup.status|replace('_', ' ')|title }}
                                        </span>
                                    </td>
                                    <td>{{ backup.notes|default('-', true)|truncate(30) }}</td>
                                    <td>
                                        {% if backup.status == 'completed' %}
                                            <form method="POST" action="{{ url_for('backup_management') }}" style="display: inline;">
                                                {% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
                                                <input type="hidden" name="action" value="download_backup">
                                                <input type="hidden" name="backup_id" value="{{ backup.id }}">
                                                <button type="submit" class="btn btn-sm btn-success" title="Download">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                            </form>
                                            <form method="POST" action="{{ url_for('backup_management') }}" style="display: inline;">
                                                {% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
                                                <input type="hidden" name="action" value="restore_backup">
                                                <input type="hidden" name="backup_id" value="{{ backup.id }}">
                                                <button type="submit" class="btn btn-sm btn-warning" title="Restore" onclick="return confirm('Are you sure you want to restore this backup? This will overwrite current data.')">
                                                    <i class="fas fa-redo"></i>
                                                </button>
                                            </form>
                                        {% endif %}
                                        <form method="POST" action="{{ url_for('backup_management') }}" style="display: inline;">
                                            {% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
                                            <input type="hidden" name="action" value="delete_backup">
                                            <input type="hidden" name="backup_id" value="{{ backup.id }}">
                                            <button type="submit" class="btn btn-sm btn-danger" title="Delete" onclick="return confirm('Are you sure you want to delete this backup?')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <i class="fas fa-info-circle"></i> Backup Configuration
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Storage Location
                            <span class="badge badge-secondary">
                                {% if storage_label is defined %}
                                    {{ storage_label }}
                                {% elif backup_config is defined %}
                                    {% if s3_client %}
                                        S3: {{ backup_config.get('s3_bucket', '-') }}
                                    {% else %}
                                        Local: {{ backup_config.get('local_storage_path', '-') }}
                                    {% endif %}
                                {% else %}
                                    Unknown
                                {% endif %}
                            </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Tables Included
                            <span class="badge badge-primary">
                                {% if backup_config is defined and backup_config.get('tables_to_backup') %}
                                    {{ backup_config['tables_to_backup']|length }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Next Scheduled Backup
                            <span class="badge badge-success">Daily at 2:00 AM</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-warning text-white">
                    <i class="fas fa-exclamation-triangle"></i> Quick Actions
                </div>
                <div class="card-body">
                    <div class="d-flex flex-column">
                        <form method="POST" action="{{ url_for('backup_management') }}" class="mb-2">
                            {% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
                            <input type="hidden" name="action" value="create_backup">
                            <button type="submit" class="btn btn-primary btn-block">
                                <i class="fas fa-plus-circle"></i> Create Immediate Backup
                            </button>
                        </form>
                        
                        <button class="btn btn-info btn-block mb-2" data-toggle="modal" data-target="#verifyBackupModal">
                            <i class="fas fa-check-circle"></i> Verify Latest Backup
                        </button>
                        
                        <a href="{{ url_for('disaster_recovery') }}" class="btn btn-danger btn-block">
                            <i class="fas fa-fire"></i> Disaster Recovery Plans
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Backup Modal -->
<div class="modal fade" id="createBackupModal" tabindex="-1" role="dialog" aria-labelledby="createBackupModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createBackupModalLabel">Create New Backup</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="POST" action="{{ url_for('backup_management') }}">
                {% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
                <input type="hidden" name="action" value="create_backup">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="backupNotes">Backup Notes</label>
                        <textarea class="form-control" id="backupNotes" name="notes" rows="3" placeholder="Optional description of this backup"></textarea>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> This will create a backup of all configured tables. The process may take several minutes.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Backup</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Verify Backup Modal -->
<div class="modal fade" id="verifyBackupModal" tabindex="-1" role="dialog" aria-labelledby="verifyBackupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="verifyBackupModalLabel">Verify Latest Backup</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="verificationResults" role="status" aria-live="polite">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-2">Verifying latest backup...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Status Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Backup Status</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="statusModalBody">
                Loading...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Vendor scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize DataTable (sort by Date/Time desc)
    $('#backupTable').DataTable({
        order: [[1, 'desc']],
        responsive: true
    });

    function renderVerification(latest) {
        const ok = latest.status === 'completed';
        const $card = $('<div>', { class: 'card mb-3' });
        const $hdr = $('<div>', { class: 'card-header text-white ' + (ok ? 'bg-success' : 'bg-danger') }).text('Backup Verification Results');
        const $body = $('<div>', { class: 'card-body' });
        $body.append($('<h5>', { class: 'card-title' }).text('Backup ID: ' + String(latest.backup_id || '')));
        const $tbl = $('<table>', { class: 'table table-sm' });
        $tbl.append($('<tr>').append($('<th>').text('Timestamp:'), $('<td>').text(new Date(latest.timestamp).toLocaleString())));
        $tbl.append($('<tr>').append($('<th>').text('Type:'), $('<td>').text(String(latest.type || ''))));
        $tbl.append($('<tr>').append($('<th>').text('Status:'), $('<td>').append($('<span>', { class: 'badge ' + (ok ? 'badge-success' : 'badge-danger') }).text(String(latest.status || '')))));
        $tbl.append($('<tr>').append($('<th>').text('Size:'), $('<td>').text(latest.size_mb ? (latest.size_mb + ' MB') : 'N/A')));
        $tbl.append($('<tr>').append($('<th>').text('Initiated By:'), $('<td>').text(String(latest.user || ''))));
        $body.append($tbl);
        $body.append($('<div>', { class: 'alert ' + (ok ? 'alert-success' : 'alert-danger') })
            .append($('<i>', { class: 'fas ' + (ok ? 'fa-check-circle' : 'fa-exclamation-triangle') }))
            .append(document.createTextNode(' ' + (ok ? 'Backup verified successfully' : 'Backup verification failed'))));
        $card.append($hdr).append($body);
        $('#verificationResults').empty().append($card);
    }

    // Load verification results when modal is shown, with robust response handling
    $('#verifyBackupModal').on('show.bs.modal', function() {
        $('#verificationResults').html(
            '<div class="text-center py-4">' +
            '  <div class="spinner-border text-primary" role="status"><span class="sr-only">Loading...</span></div>' +
            '  <p class="mt-2">Verifying latest backup...</p>' +
            '</div>'
        );
        $.get("{{ url_for('backup_logs') }}", function(res) {
            const data = (res && res.success === true && Array.isArray(res.data)) ? res.data
                       : (Array.isArray(res) ? res : []);
            if (data.length) {
                renderVerification(data[0]);
            } else {
                $('#verificationResults').html(
                    '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> No backup records found</div>'
                );
            }
        }).fail(function(xhr) {
            const msg = (xhr.responseJSON && xhr.responseJSON.error) || 'Failed to load backup verification data';
            $('#verificationResults').html('<div class="alert alert-danger"><i class="fas fa-times-circle"></i> ' + msg + '</div>');
        });
    });
    
    // Poll only in-progress rows
    function checkInProgressBackups() {
        $('#backupTable tbody tr').each(function() {
            const $tr = $(this);
            if ($tr.data('status') !== 'in_progress') return;
            const backupId = $tr.data('backup-id');
            if (!backupId) return;
            $.get('/admin/backup/status/' + backupId, function(data) {
                if (data && data.status && data.status !== 'in_progress') {
                    // Ideally update just this row; simplest is to refresh
                    location.reload();
                }
            });
        });
    }
    setInterval(checkInProgressBackups, 10000);
    
    // Show status modal for in-progress backups (uses safe text insertion)
    $(document).on('click', '.badge-warning', function() {
        const $tr = $(this).closest('tr');
        const backupId = $tr.data('backup-id');
        if (!backupId) return;
        $.get('/admin/backup/status/' + backupId, function(data) {
            const ok = data && data.status === 'completed';
            const $wrap = $('<div>');
            $wrap.append($('<h5>').text('Backup ID: ' + String(data.id || backupId)));
            $wrap.append(
                $('<p>').append(
                    document.createTextNode('Status: '),
                    $('<span>', { class: 'badge ' + (ok ? 'badge-success' : 'badge-warning') })
                        .text(String((data.status || '').replace('_', ' ')))
                )
            );
            if (data && data.timestamp) {
                $wrap.append($('<p>').text('Started: ' + new Date(data.timestamp).toLocaleString()));
            }
            const sizeText = (data && data.size_bytes) ? ((data.size_bytes / (1024 * 1024)).toFixed(2) + ' MB') : 'Calculating...';
            $wrap.append($('<p>').text('Size: ' + sizeText));
            $wrap.append($('<p>').text('Notes: ' + String(data && data.notes ? data.notes : 'None')));
            $('#statusModalBody').empty().append($wrap);
            $('#statusModal').modal('show');
        });
    });
});
</script>

<style>
    .badge {
        font-size: 0.85em;
        font-weight: 500;
        padding: 0.35em 0.65em;
    }
    .card-header {
        font-weight: 600;
    }
    .table td, .table th {
        vertical-align: middle;
    }
    .btn-sm {
        min-width: 30px;
    }
    #backupTable tbody tr {
        cursor: pointer;
    }
    #backupTable tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.03);
    }
</style>
{% endblock %}