{% extends "base.html" %}

{% block content %}
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

<div class="medical-tests-container">
    <div class="dashboard-header">
        <div class="header-content">
            <div class="header-title">
                <h1><i class="fas fa-flask"></i> Medical Tests Management</h1>
                <p>Manage services, lab tests, and imaging tests</p>
            </div>
            <div class="current-date">
                <span id="current-date"></span>
            </div>
        </div>
    </div>

    <div id="alert-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} animate__animated animate__fadeIn">
                        <div class="alert-content">
                            <span class="alert-message">{{ message }}</span>
                            <button class="close-alert">&times;</button>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <div class="summary-cards-grid">
        <div class="summary-card services">
            <div class="card-icon">
                <i class="fas fa-stethoscope"></i>
            </div>
            <div class="card-content">
                <h3>Total Services</h3>
                <div class="amount" id="total-services">{{ services|length }}</div>
                <p>Medical services available</p>
            </div>
        </div>
        
        <div class="summary-card lab-tests">
            <div class="card-icon">
                <i class="fas fa-microscope"></i>
            </div>
            <div class="card-content">
                <h3>Lab Tests</h3>
                <div class="amount" id="total-lab-tests">{{ lab_tests|length }}</div>
                <p>Laboratory tests available</p>
            </div>
        </div>
        
        <div class="summary-card imaging-tests">
            <div class="card-icon">
                <i class="fas fa-x-ray"></i>
            </div>
            <div class="card-content">
                <h3>Imaging Tests</h3>
                <div class="amount" id="total-imaging-tests">{{ imaging_tests|length }}</div>
                <p>Imaging and radiology tests</p>
            </div>
        </div>
        
        <div class="summary-card active-tests">
            <div class="card-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="card-content">
                <h3>Active Tests</h3>
                <div class="amount" id="active-tests">{{ imaging_tests|selectattr("is_active")|list|length }}</div>
                <p>Currently active imaging tests</p>
            </div>
        </div>
    </div>

    <div class="navigation-tabs">
        <div class="tab active" data-tab="services">
            <i class="fas fa-stethoscope"></i>
            <span>Services</span>
        </div>
        <div class="tab" data-tab="lab-tests">
            <i class="fas fa-microscope"></i>
            <span>Lab Tests</span>
        </div>
        <div class="tab" data-tab="imaging-tests">
            <i class="fas fa-x-ray"></i>
            <span>Imaging Tests</span>
        </div>
    </div>

    <!-- Services Tab -->
    <div class="tab-content active" id="services-tab">
        <div class="section-header">
            <div class="section-title">
                <h2><i class="fas fa-stethoscope"></i> Medical Services</h2>
                <p>Manage medical services and their pricing</p>
            </div>
            <button class="btn btn-primary btn-with-icon" data-modal-target="add-service">
                <i class="fas fa-plus"></i> Add Service
            </button>
        </div>
        <div class="table-container">
            <table id="services-table" class="modern-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Price (Ksh)</th>
                        <th>Description</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for service in services %}
                    <tr>
                        <td>{{ service.name }}</td>
                        <td class="amount-cell">Ksh {{ "%.2f"|format(service.price) }}</td>
                        <td>{{ service.description or 'No description' }}</td>
                        <td class="action-btns">
                            <div class="btn-group">
                                <button class="action-btn btn-primary" 
                                        onclick="medicalTests.editService({{ service.id }}, '{{ service.name | replace("'", "\\'") }}', {{ service.price }}, '{{ service.description | replace("'", "\\'") if service.description else '' }}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn btn-danger" 
                                        data-delete-record="{{ service.id }}" 
                                        data-record-type="service">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if not services %}
            <div class="empty-state" id="services-empty">
                <i class="fas fa-stethoscope"></i>
                <h3>No services added yet</h3>
                <p>Add your first medical service to get started</p>
                <button class="btn btn-primary" data-modal-target="add-service">
                    <i class="fas fa-plus"></i> Add Service
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Lab Tests Tab -->
    <div class="tab-content" id="lab-tests-tab">
        <div class="section-header">
            <div class="section-title">
                <h2><i class="fas fa-microscope"></i> Laboratory Tests</h2>
                <p>Manage laboratory tests and their pricing</p>
            </div>
            <button class="btn btn-primary btn-with-icon" data-modal-target="add-lab-test">
                <i class="fas fa-plus"></i> Add Lab Test
            </button>
        </div>
        <div class="table-container">
            <table id="lab-tests-table" class="modern-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Price (Ksh)</th>
                        <th>Description</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for test in lab_tests %}
                    <tr>
                        <td>{{ test.name }}</td>
                        <td class="amount-cell">Ksh {{ "%.2f"|format(test.price) }}</td>
                        <td>{{ test.description or 'No description' }}</td>
                        <td class="action-btns">
                            <div class="btn-group">
                                <button class="action-btn btn-primary" 
                                        onclick="medicalTests.editLabTest({{ test.id }}, '{{ test.name | replace("'", "\\'") }}', {{ test.price }}, '{{ test.description | replace("'", "\\'") if test.description else '' }}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn btn-danger" 
                                        data-delete-record="{{ test.id }}" 
                                        data-record-type="lab-test">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if not lab_tests %}
            <div class="empty-state" id="lab-tests-empty">
                <i class="fas fa-microscope"></i>
                <h3>No lab tests added yet</h3>
                <p>Add your first laboratory test to get started</p>
                <button class="btn btn-primary" data-modal-target="add-lab-test">
                    <i class="fas fa-plus"></i> Add Lab Test
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Imaging Tests Tab -->
    <div class="tab-content" id="imaging-tests-tab">
        <div class="section-header">
            <div class="section-title">
                <h2><i class="fas fa-x-ray"></i> Imaging Tests</h2>
                <p>Manage imaging tests and their status</p>
            </div>
            <button class="btn btn-primary btn-with-icon" data-modal-target="add-imaging-test">
                <i class="fas fa-plus"></i> Add Imaging Test
            </button>
        </div>
        <div class="table-container">
            <table id="imaging-tests-table" class="modern-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Price (Ksh)</th>
                        <th>Status</th>
                        <th>Description</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for test in imaging_tests %}
                    <tr>
                        <td>{{ test.name }}</td>
                        <td class="amount-cell">Ksh {{ "%.2f"|format(test.price) }}</td>
                        <td>
                            <span class="status-badge {% if test.is_active %}status-active{% else %}status-inactive{% endif %}">
                                {% if test.is_active %}Active{% else %}Inactive{% endif %}
                            </span>
                        </td>
                        <td>{{ test.description or 'No description' }}</td>
                        <td class="action-btns">
                            <div class="btn-group">
                                <button class="action-btn btn-primary" 
                                        onclick="medicalTests.editImagingTest({{ test.id }}, '{{ test.name | replace("'", "\\'") }}', {{ test.price }}, '{{ test.description | replace("'", "\\'") if test.description else '' }}', {{ 'true' if test.is_active else 'false' }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn btn-danger" 
                                        data-delete-record="{{ test.id }}" 
                                        data-record-type="imaging-test">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if not imaging_tests %}
            <div class="empty-state" id="imaging-tests-empty">
                <i class="fas fa-x-ray"></i>
                <h3>No imaging tests added yet</h3>
                <p>Add your first imaging test to get started</p>
                <button class="btn btn-primary" data-modal-target="add-imaging-test">
                    <i class="fas fa-plus"></i> Add Imaging Test
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Service Modal -->
<div class="modal" id="add-service-modal" role="dialog" aria-modal="true" aria-labelledby="add-service-title">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="add-service-title">Add Medical Service</h2>
            <button class="close-btn" data-modal-target="add-service">&times;</button>
        </div>
        <form id="add-service-form" method="POST" action="/admin/services/add">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="form-group">
                <label for="service-name">Service Name *</label>
                <input type="text" id="service-name" name="name" required>
            </div>
            <div class="form-group">
                <label for="service-price">Price (Ksh) *</label>
                <input type="number" step="0.01" id="service-price" name="price" required min="0">
            </div>
            <div class="form-group">
                <label for="service-description">Description</label>
                <textarea id="service-description" name="description"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn" data-modal-target="add-service">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Service Modal -->
<div class="modal" id="edit-service-modal" role="dialog" aria-modal="true" aria-labelledby="edit-service-title">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="edit-service-title">Edit Medical Service</h2>
            <button class="close-btn" data-modal-target="edit-service">&times;</button>
        </div>
        <form id="edit-service-form" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="id" id="edit-service-id">
            <div class="form-group">
                <label for="edit-service-name">Service Name *</label>
                <input type="text" id="edit-service-name" name="name" required>
            </div>
            <div class="form-group">
                <label for="edit-service-price">Price (Ksh) *</label>
                <input type="number" step="0.01" id="edit-service-price" name="price" required min="0">
            </div>
            <div class="form-group">
                <label for="edit-service-description">Description</label>
                <textarea id="edit-service-description" name="description"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn" data-modal-target="edit-service">Cancel</button>
                <button type="submit" class="btn btn-primary">Update</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Lab Test Modal -->
<div class="modal" id="add-lab-test-modal" role="dialog" aria-modal="true" aria-labelledby="add-lab-test-title">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="add-lab-test-title">Add Laboratory Test</h2>
            <button class="close-btn" data-modal-target="add-lab-test">&times;</button>
        </div>
        <form id="add-lab-test-form" method="POST" action="/admin/lab-tests/add">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="form-group">
                <label for="lab-test-name">Test Name *</label>
                <input type="text" id="lab-test-name" name="name" required>
            </div>
            <div class="form-group">
                <label for="lab-test-price">Price (Ksh) *</label>
                <input type="number" step="0.01" id="lab-test-price" name="price" required min="0">
            </div>
            <div class="form-group">
                <label for="lab-test-description">Description</label>
                <textarea id="lab-test-description" name="description"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn" data-modal-target="add-lab-test">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Lab Test Modal -->
<div class="modal" id="edit-lab-test-modal" role="dialog" aria-modal="true" aria-labelledby="edit-lab-test-title">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="edit-lab-test-title">Edit Laboratory Test</h2>
            <button class="close-btn" data-modal-target="edit-lab-test">&times;</button>
        </div>
        <form id="edit-lab-test-form" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="id" id="edit-lab-test-id">
            <div class="form-group">
                <label for="edit-lab-test-name">Test Name *</label>
                <input type="text" id="edit-lab-test-name" name="name" required>
            </div>
            <div class="form-group">
                <label for="edit-lab-test-price">Price (Ksh) *</label>
                <input type="number" step="0.01" id="edit-lab-test-price" name="price" required min="0">
            </div>
            <div class="form-group">
                <label for="edit-lab-test-description">Description</label>
                <textarea id="edit-lab-test-description" name="description"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn" data-modal-target="edit-lab-test">Cancel</button>
                <button type="submit" class="btn btn-primary">Update</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Imaging Test Modal -->
<div class="modal" id="add-imaging-test-modal" role="dialog" aria-modal="true" aria-labelledby="add-imaging-test-title">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="add-imaging-test-title">Add Imaging Test</h2>
            <button class="close-btn" data-modal-target="add-imaging-test">&times;</button>
        </div>
        <form id="add-imaging-test-form" method="POST" action="/admin/imaging-tests/add">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="form-group">
                <label for="imaging-test-name">Test Name *</label>
                <input type="text" id="imaging-test-name" name="name" required>
            </div>
            <div class="form-group">
                <label for="imaging-test-price">Price (Ksh) *</label>
                <input type="number" step="0.01" id="imaging-test-price" name="price" required min="0">
            </div>
            <div class="form-group">
                <label for="imaging-test-description">Description</label>
                <textarea id="imaging-test-description" name="description"></textarea>
            </div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="imaging-test-active" name="is_active" value="true" checked>
                    <span class="checkmark"></span>
                    Active
                </label>
            </div>
            <div class="form-actions">
                <button type="button" class="btn" data-modal-target="add-imaging-test">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Imaging Test Modal -->
<div class="modal" id="edit-imaging-test-modal" role="dialog" aria-modal="true" aria-labelledby="edit-imaging-test-title">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="edit-imaging-test-title">Edit Imaging Test</h2>
            <button class="close-btn" data-modal-target="edit-imaging-test">&times;</button>
        </div>
        <form id="edit-imaging-test-form" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="id" id="edit-imaging-test-id">
            <div class="form-group">
                <label for="edit-imaging-test-name">Test Name *</label>
                <input type="text" id="edit-imaging-test-name" name="name" required>
            </div>
            <div class="form-group">
                <label for="edit-imaging-test-price">Price (Ksh) *</label>
                <input type="number" step="0.01" id="edit-imaging-test-price" name="price" required min="0">
            </div>
            <div class="form-group">
                <label for="edit-imaging-test-description">Description</label>
                <textarea id="edit-imaging-test-description" name="description"></textarea>
            </div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="edit-imaging-test-active" name="is_active" value="true">
                    <span class="checkmark"></span>
                    Active
                </label>
            </div>
            <div class="form-actions">
                <button type="button" class="btn" data-modal-target="edit-imaging-test">Cancel</button>
                <button type="submit" class="btn btn-primary">Update</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="delete-confirm-modal" role="dialog" aria-modal="true" aria-labelledby="delete-confirm-title">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="delete-confirm-title">Confirm Deletion</h2>
            <button class="close-btn" data-modal-target="delete-confirm">&times;</button>
        </div>
        <div class="modal-body">
            <p id="delete-confirm-message">Are you sure you want to delete this record?</p>
            <form id="delete-form" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="id" id="delete-record-id">
                <input type="hidden" name="type" id="delete-record-type">
            </form>
        </div>
        <div class="form-actions">
            <button type="button" class="btn" data-modal-target="delete-confirm">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirm-delete-button">Delete</button>
        </div>
    </div>
</div>

<style>
:root {
    --primary: #4361ee;
    --secondary: #6c757d;
    --success: #28a745;
    --danger: #dc3545;
    --warning: #ffc107;
    --info: #17a2b8;
    --light: #f8f9fa;
    --dark: #343a40;
    --white: #ffffff;
    --gray-100: #f8f9fa;
    --gray-200: #e9ecef;
    --gray-300: #dee2e6;
    --gray-400: #ced4da;
    --gray-500: #adb5bd;
    --gray-600: #6c757d;
    --gray-700: #495057;
    --gray-800: #343a40;
    --gray-900: #212529;
    --border-radius: 8px;
    --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    --transition: all 0.3s ease;
}

.medical-tests-container {
    padding: 20px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f5f7f9;
    min-height: 100vh;
}

.dashboard-header {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 20px;
    margin-bottom: 24px;
    box-shadow: var(--box-shadow);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-title h1 {
    margin: 0;
    color: var(--gray-800);
    font-size: 28px;
    font-weight: 600;
}

.header-title p {
    margin: 5px 0 0;
    color: var(--gray-600);
    font-size: 16px;
}

.current-date {
    color: var(--gray-600);
    font-weight: 500;
}

.alert {
    padding: 12px 16px;
    border-radius: var(--border-radius);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
}

.alert-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

.alert-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-danger {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.close-alert {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: inherit;
}

.summary-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
}

.summary-card {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 24px;
    box-shadow: var(--box-shadow);
    display: flex;
    align-items: center;
    transition: var(--transition);
}

.summary-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
}

.card-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 16px;
    font-size: 24px;
    color: white;
}

.services .card-icon {
    background: linear-gradient(135deg, #17ead9, #6078ea);
}

.lab-tests .card-icon {
    background: linear-gradient(135deg, #43cea2, #185a9d);
}

.imaging-tests .card-icon {
    background: linear-gradient(135deg, #ff7e5f, #feb47b);
}

.active-tests .card-icon {
    background: linear-gradient(135deg, #f5515f, #9f041b);
}

.card-content h3 {
    margin: 0;
    font-size: 16px;
    color: var(--gray-600);
    font-weight: 500;
}

.amount {
    font-size: 24px;
    font-weight: 700;
    margin: 5px 0;
}

.card-content p {
    margin: 0;
    font-size: 14px;
    color: var(--gray-500);
}

.navigation-tabs {
    display: flex;
    background: var(--white);
    border-radius: var(--border-radius);
    margin-bottom: 24px;
    box-shadow: var(--box-shadow);
    overflow: hidden;
}

.tab {
    padding: 16px 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    transition: var(--transition);
    border-bottom: 3px solid transparent;
}

.tab:hover {
    background-color: var(--gray-100);
}

.tab.active {
    border-bottom: 3px solid var(--primary);
    color: var(--primary);
    font-weight: 500;
}

.tab i {
    margin-right: 8px;
    font-size: 18px;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.section-title h2 {
    margin: 0;
    color: var(--gray-800);
    font-size: 24px;
    font-weight: 600;
}

.section-title p {
    margin: 5px 0 0;
    color: var(--gray-600);
    font-size: 14px;
}

.btn {
    padding: 10px 20px;
    border-radius: var(--border-radius);
    border: none;
    cursor: pointer;
    font-weight: 500;
    transition: var(--transition);
}

.btn-primary {
    background: var(--primary);
    color: var(--white);
}

.btn-primary:hover {
    background: #3651d3;
    transform: translateY(-2px);
}

.btn-success {
    background: var(--success);
    color: var(--white);
}

.btn-danger {
    background: var(--danger);
    color: var(--white);
}

.btn-with-icon {
    display: flex;
    align-items: center;
    gap: 8px;
}

.modern-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    margin-bottom: 24px;
    overflow: hidden;
}

.modern-table th {
    background-color: #f8f9fa;
    padding: 16px;
    text-align: left;
    font-weight: 600;
    color: var(--gray-700);
    border-bottom: 1px solid var(--gray-300);
}

.modern-table td {
    padding: 16px;
    border-bottom: 1px solid var(--gray-200);
}

.modern-table tr:last-child td {
    border-bottom: none;
}

.modern-table tr:hover {
    background-color: #f8f9fa;
}

.amount-cell {
    font-weight: 600;
    font-family: 'Courier New', monospace;
}

.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
}

.status-active {
    background: #e6f4ea;
    color: #137333;
}

.status-inactive {
    background: #fef7e0;
    color: #b06000;
}

.action-btns {
    white-space: nowrap;
}

.btn-group {
    display: flex;
    gap: 8px;
}

.action-btn {
    width: 36px;
    height: 36px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    transition: var(--transition);
}

.action-btn:hover {
    transform: scale(1.1);
}

.text-center {
    text-align: center;
}

.empty-state {
    padding: 40px 20px;
    text-align: center;
    color: var(--gray-500);
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
}

.empty-state i {
    font-size: 64px;
    margin-bottom: 16px;
    opacity: 0.5;
}

.empty-state h3 {
    margin: 0 0 8px;
    font-size: 20px;
    color: var(--gray-600);
}

.empty-state p {
    margin: 0 0 20px;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: var(--white);
    border-radius: var(--border-radius);
    width: 100%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

.modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--gray-200);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    font-size: 20px;
    color: var(--gray-800);
}

.close-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--gray-500);
}

.modal-body {
    padding: 24px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--gray-700);
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--gray-300);
    border-radius: var(--border-radius);
    font-size: 16px;
    transition: var(--transition);
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
}

.checkbox-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-weight: normal;
}

.checkbox-label input[type="checkbox"] {
    width: auto;
    margin-right: 10px;
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 24px;
}

/* Responsive Design */
@media (max-width: 768px) {
    .medical-tests-container {
        padding: 16px;
    }
    
    .header-content {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }
    
    .summary-cards-grid {
        grid-template-columns: 1fr;
    }
    
    .navigation-tabs {
        flex-wrap: wrap;
    }
    
    .tab {
        flex: 1;
        min-width: 120px;
        justify-content: center;
    }
    
    .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
    }
    
    .modal-content {
        width: 95%;
        margin: 20px auto;
    }
    
    .action-btns .btn-group {
        flex-direction: column;
    }
    
    .modern-table {
        display: block;
        overflow-x: auto;
    }
}
</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

<script>

window.medicalTests = {
    init: function() {
        this.setCurrentDate();
        this.setupEventListeners();
        this.initDataTables();
    },

    setCurrentDate: function() {
        const today = new Date();
        document.getElementById('current-date').textContent = today.toLocaleDateString('en-US', { 
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
        });
    },

    setupEventListeners: function() {
        // Close alert buttons
        $(document).on('click', '.close-alert', function() {
            $(this).closest('.alert').remove();
        });

        // Tab switching
        $(document).on('click', '.tab', function() {
            const tabId = $(this).data('tab');
            medicalTests.switchTab(tabId);
        });

        // Modal handling
        $(document).on('click', '[data-modal-target]', function() {
            const modalId = $(this).data('modal-target');
            medicalTests.openModal(modalId);
        });

        $(document).on('click', '.close-btn', function() {
            const modal = $(this).closest('.modal');
            const modalId = modal.attr('id').replace('-modal', '');
            medicalTests.closeModal(modalId);
        });

        $(document).on('click', '.modal', function(e) {
            if (e.target === this) {
                const modalId = $(this).attr('id').replace('-modal', '');
                medicalTests.closeModal(modalId);
            }
        });

        // Delete confirmation
        $(document).on('click', '[data-delete-record]', function() {
            const recordId = $(this).data('delete-record');
            const recordType = $(this).data('record-type');
            medicalTests.confirmDeleteRecord(recordId, recordType);
        });

        // Confirm delete button
        $(document).on('click', '#confirm-delete-button', function() {
            medicalTests.confirmDelete();
        });

        // Form submissions
        this.setupFormSubmissions();
    },

    setupFormSubmissions: function() {
        $('form[id$="-form"]').on('submit', function(e) {
            e.preventDefault();
            const form = $(this);
            const action = form.attr('action');
            const method = form.attr('method') || 'POST';
            const formData = new FormData(this);
            const currentTab = $('.tab.active').data('tab');

            fetch(action, {
                method: method,
                body: formData,
                headers: {
                    'X-CSRFToken': medicalTests.getCSRFToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    medicalTests.showAlert('danger', data.error);
                    return;
                }
                if (data.success) {
                    const modalId = form.closest('.modal').attr('id').replace('-modal', '');
                    medicalTests.closeModal(modalId);
                    medicalTests.showAlert('success', 'Saved successfully');
                    
                    // Refresh the page to show updated data
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                medicalTests.showAlert('danger', 'An error occurred. Please try again.');
            });
        });
    },

    initDataTables: function() {
        $('.table-container table').each(function() {
            if (!$.fn.DataTable.isDataTable(this)) {
                $(this).DataTable({
                    responsive: true,
                    pageLength: 10,
                    lengthMenu: [5, 10, 25, 50, 100],
                    scrollX: true,
                    language: {
                        search: "_INPUT_",
                        searchPlaceholder: "Search...",
                    }
                });
            }
        });
    },

    switchTab: function(tabId) {
        $('.tab').removeClass('active');
        $(`.tab[data-tab="${tabId}"]`).addClass('active');

        $('.tab-content').removeClass('active');
        $(`#${tabId}-tab`).addClass('active');
    },

    openModal: function(modalId) {
        $(`#${modalId}-modal`).css('display', 'flex');
        $('body').css('overflow', 'hidden');
    },

    closeModal: function(modalId) {
        $(`#${modalId}-modal`).hide();
        $('body').css('overflow', '');
    },

    // Edit functions
    editService: function(id, name, price, description) {
        $('#edit-service-id').val(id);
        $('#edit-service-name').val(name);
        $('#edit-service-price').val(price);
        $('#edit-service-description').val(description || '');
        $('#edit-service-form').attr('action', `/admin/services/${id}/update`);
        this.openModal('edit-service');
    },

    editLabTest: function(id, name, price, description) {
        $('#edit-lab-test-id').val(id);
        $('#edit-lab-test-name').val(name);
        $('#edit-lab-test-price').val(price);
        $('#edit-lab-test-description').val(description || '');
        $('#edit-lab-test-form').attr('action', `/admin/lab-tests/${id}/update`);
        this.openModal('edit-lab-test');
    },

    editImagingTest: function(id, name, price, description, isActive) {
        $('#edit-imaging-test-id').val(id);
        $('#edit-imaging-test-name').val(name);
        $('#edit-imaging-test-price').val(price);
        $('#edit-imaging-test-description').val(description || '');
        $('#edit-imaging-test-active').prop('checked', isActive === 'true');
        $('#edit-imaging-test-form').attr('action', `/admin/imaging-tests/${id}/update`);
        this.openModal('edit-imaging-test');
    },

    confirmDeleteRecord: function(id, type) {
        $('#delete-record-id').val(id);
        $('#delete-record-type').val(type);
        
        let message = '';
        switch(type) {
            case 'service': message = 'Are you sure you want to delete this service?'; break;
            case 'lab-test': message = 'Are you sure you want to delete this lab test?'; break;
            case 'imaging-test': message = 'Are you sure you want to delete this imaging test?'; break;
            default: message = 'Are you sure you want to delete this record?';
        }
        
        $('#delete-confirm-message').text(message);
        $('#delete-form').attr('action', `/admin/${type}s/${id}/delete`);
        this.openModal('delete-confirm');
    },

    confirmDelete: function() {
        const form = document.getElementById('delete-form');
        const action = form.getAttribute('action');
        const formData = new FormData(form);
        const headers = {};
        const token = medicalTests.getCSRFToken();
        if (token) headers['X-CSRFToken'] = token;
        fetch(action, { method: 'POST', body: formData, headers })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    medicalTests.closeModal('delete-confirm');
                    medicalTests.showAlert('success', 'Record deleted successfully');
                    // Refresh the page to show updated data
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    medicalTests.showAlert('danger', data.error || 'Failed to delete record');
                }
            })
            .catch(err => {
                console.error(err);
                medicalTests.showAlert('danger', 'An error occurred while deleting the record');
            });
    },
    
    getCSRFToken: function() {
        const meta = document.querySelector('meta[name="csrf-token"]');
        if (meta && meta.content) return meta.content;
        const match = document.cookie.match(/(?:^|; )csrf_token=([^;]*)/);
        if (match) return decodeURIComponent(match[1]);
        const alt = document.cookie.match(/(?:^|; )csrf-access-token=([^;]*)/);
        return alt ? decodeURIComponent(alt[1]) : null;
    },
    
    showAlert: function(type, message) {
        const container = document.getElementById('alert-container');
        if (!container) return alert(message);
        const div = document.createElement('div');
        div.className = `alert alert-${type} animate__animated animate__fadeIn`;
        div.innerHTML = `
            <div class="alert-content">
                <span class="alert-message">${message}</span>
                <button class="close-alert">&times;</button>
            </div>
        `;
        container.prepend(div);
        setTimeout(() => {
            if (div && div.parentNode) div.parentNode.removeChild(div);
        }, 4000);
    }
};

// Initialize when DOM is ready
$(document).ready(function() {
    medicalTests.init();
});
</script>

{% endblock %}