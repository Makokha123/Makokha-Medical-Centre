{% extends "base.html" %}

{% block content %}
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    .dosage-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .dosage-header h2 {
        margin: 0;
        flex: 1;
        min-width: 300px;
    }
    
    .header-actions-left, .header-actions-right {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .ai-toggle {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    /* Toggle Switch Styles */
    .toggle-switch {
        position: relative;
        display: inline-flex;
        width: 50px;
        height: 26px;
        cursor: pointer;
    }
    
    .toggle-switch input {
        display: none;
    }
    
    .toggle-slider {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        border-radius: 26px;
        transition: all 0.3s ease;
    }
    
    .toggle-slider::before {
        content: '';
        position: absolute;
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        border-radius: 50%;
        transition: all 0.3s ease;
    }
    
    .toggle-switch input:checked + .toggle-slider {
        background-color: #4A90E2;
    }
    
    .toggle-switch input:checked + .toggle-slider::before {
        transform: translateX(24px);
    }
    
    .toggle-switch.disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .toggle-switch.disabled input {
        cursor: not-allowed;
    }
    
    .ai-toggle label {
        margin: 0;
        cursor: pointer;
        font-weight: 500;
        user-select: none;
    }
    
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 0.75rem;
        padding: 1.5rem;
        color: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }
    
    .stat-card.total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-card.with-dosage { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-card.missing { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    .stat-card.ai-generated { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    
    .stat-card .stat-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .stat-card .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
        font-weight: 500;
    }
    
    .table-scrollable {
        max-height: none;
        transition: max-height 0.3s ease;
    }
    
    .table-scrollable.has-scroll {
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
    }
    
    .data-table {
        margin-bottom: 0;
    }
    
    .data-table thead {
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .action-buttons {
        display: flex;
        gap: 0.25rem;
    }
    
    .btn-view, .btn-edit, .btn-delete {
        padding: 0.35rem 0.5rem;
        font-size: 0.85rem;
        border-radius: 0.375rem;
        border: none;
        transition: all 0.2s;
    }
    
    .btn-view {
        background-color: #17a2b8;
        color: white;
    }
    
    .btn-view:hover {
        background-color: #138496;
        transform: scale(1.05);
    }
    
    .btn-edit {
        background-color: #ffc107;
        color: white;
    }
    
    .btn-edit:hover {
        background-color: #e0a800;
        transform: scale(1.05);
    }
    
    .btn-delete {
        background-color: #dc3545;
        color: white;
    }
    
    .btn-delete:hover {
        background-color: #c82333;
        transform: scale(1.05);
    }
    
    .btn-add-dosage {
        padding: 0.35rem 0.75rem;
        font-size: 0.85rem;
    }
    
    .ai-buttons-disabled {
        opacity: 0.5;
        pointer-events: none;
        cursor: not-allowed;
    }
    
    .auto-close-alert {
        animation: slideOut 0.3s ease-out 3s forwards;
    }
    
    @keyframes slideOut {
        0% {
            opacity: 1;
            transform: translateY(0);
        }
        100% {
            opacity: 0;
            transform: translateY(-20px);
        }
    }
</style>

<div class="content">
    <!-- Header -->
    <div class="dosage-header">
        <h2><i class="fas fa-pills"></i> Drug Dosage Information</h2>
        <div class="header-actions-left">
            <a class="btn btn-outline-primary btn-sm" href="{{ url_for('admin_dosage_dashboard') }}" title="Go to Dashboard">
                <i class="fas fa-th-large"></i> Dashboard
            </a>
            <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#addDosageModal" title="Add new drug dosage">
                <i class="fas fa-plus"></i> Add Dosage
            </button>
        </div>
        <div class="header-actions-right">
            <div class="ai-toggle">
                <label class="toggle-switch" id="aiToggleDrug">
                    <input type="checkbox" id="aiToggleDrugInput" {{ 'checked' if ai_dosage_agent_enabled else '' }} onchange="handleAIToggleDrug(this)">
                    <span class="toggle-slider"></span>
                </label>
                <label for="aiToggleDrugInput">Enable AI</label>
            </div>
            <button type="button" class="btn btn-outline-info btn-sm ai-control-btn" id="runNowBtn" {{ 'disabled' if not ai_dosage_agent_enabled else '' }} onclick="runAIAgent()" title="Run AI agent once">
                <i class="fas fa-play"></i> Run Now
            </button>
            <button type="button" class="btn btn-outline-success btn-sm ai-control-btn" id="fillFieldsBtn" {{ 'disabled' if not ai_dosage_agent_enabled else '' }} onclick="fillMissingFields()" title="Fill missing fields with AI">
                <i class="fas fa-magic"></i> Fill Missing
            </button>
        </div>
    </div>

    <!-- Flash Messages (embed only; base.html already renders flashes) -->
    {% if is_embed %}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-auto-close" role="alert">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    {% endif %}

    <!-- Stats Cards -->
    <div class="stats-container">
        <div class="stat-card total">
            <div class="stat-value">{{ stats.total_drugs }}</div>
            <div class="stat-label">Total Drugs</div>
        </div>
        <div class="stat-card with-dosage">
            <div class="stat-value">{{ stats.with_dosage }}</div>
            <div class="stat-label">With Dosage Info</div>
        </div>
        <div class="stat-card missing">
            <div class="stat-value">{{ stats.without_dosage }}</div>
            <div class="stat-label">Missing Dosage</div>
        </div>
        <div class="stat-card ai-generated">
            <div class="stat-value">{{ stats.ai_generated }}</div>
            <div class="stat-label">AI-Generated (50/run)</div>
        </div>

        <!-- Hidden AI Progress (appears only while running) -->
        <div class="stat-card ai-generated" id="aiProgressCard" style="display:none;">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-value" id="aiProgressCounts">0/0</div>
                    <div class="stat-label" id="aiProgressText">Starting...</div>
                </div>
                <button type="button" class="btn btn-sm btn-light" onclick="hideAIProgressCard()" title="Hide">
                    Hide
                </button>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="table-scrollable" id="tableContainer">
        <table class="data-table" id="dosageTable">
            <thead>
                <tr>
                    <th>Drug No.</th>
                    <th>Drug Name</th>
                    <th>Indication</th>
                    <th>Dosage (Adults)</th>
                    <th>Dosage (Peds)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for drug in drugs %}
                {% set dosage = (drug.dosage[0] if drug.dosage else None) %}
                <tr id="drug-row-{{ drug.id }}" data-drug-id="{{ drug.id }}" data-has-dosage="{{ 1 if dosage else 0 }}">
                    <td>{{ drug.drug_number }}</td>
                    <td>{{ drug.name }}</td>
                    <td class="col-indication">{{ dosage.indication|truncate(50) if dosage and dosage.indication else '-' }}</td>
                    <td class="col-adults">{{ dosage.dosage_adults|truncate(50) if dosage and dosage.dosage_adults else '-' }}</td>
                    <td class="col-peds">{{ dosage.dosage_peds|truncate(50) if dosage and dosage.dosage_peds else '-' }}</td>
                    <td class="col-actions">
                        <div class="action-buttons">
                            {% if dosage %}
                                <button class="btn btn-view" data-id="{{ dosage.id }}" data-toggle="modal" data-target="#viewDosageModal" title="View dosage">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-edit" data-id="{{ dosage.id }}" data-toggle="modal" data-target="#editDosageModal" title="Edit dosage">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-delete" data-id="{{ dosage.id }}" data-toggle="modal" data-target="#deleteDosageModal" title="Delete dosage">
                                    <i class="fas fa-trash"></i>
                                </button>
                            {% else %}
                                <button class="btn btn-sm btn-primary btn-add-dosage" type="button" data-drug-id="{{ drug.id }}" data-toggle="modal" data-target="#addDosageModal" title="Add dosage for this drug">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
function handleAIToggleDrug(checkbox) {
    // Check if master toggle is disabled
    const isMasterDisabled = !localStorage.getItem('ai_dosage_master_enabled') || localStorage.getItem('ai_dosage_master_enabled') === 'false';
    
    if (isMasterDisabled && checkbox.checked) {
        checkbox.checked = false;
        alert('AI must be enabled in the Dosage Management dashboard first.');
        return;
    }
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("admin_toggle_ai_dosage_agent") }}';
    
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrf_token';
    csrfInput.value = '{{ csrf_token() }}';
    
    const enabledInput = document.createElement('input');
    enabledInput.type = 'hidden';
    enabledInput.name = 'enabled';
    enabledInput.value = checkbox.checked ? '1' : '0';
    
    form.appendChild(csrfInput);
    form.appendChild(enabledInput);
    document.body.appendChild(form);
    form.submit();
}

function updateDrugToggleState() {
    const isMasterDisabled = !localStorage.getItem('ai_dosage_master_enabled') || localStorage.getItem('ai_dosage_master_enabled') === 'false';
    const toggle = document.getElementById('aiToggleDrug');
    const input = document.getElementById('aiToggleDrugInput');
    
    if (isMasterDisabled) {
        toggle.classList.add('disabled');
        input.disabled = true;
    } else {
        toggle.classList.remove('disabled');
        input.disabled = false;
    }
}

function runAIAgent() {
    startAIDosageJob({ kind: 'drug', mode: 'full', limit: 50 });
}

function fillMissingFields() {
    startAIDosageJob({ kind: 'drug', mode: 'fill', limit: 50 });
}

let _aiJobPollTimer = null;
let _aiJobLastSeq = 0;
let _aiProgressCardDismissed = false;

function showAIProgressCard() {
    if (_aiProgressCardDismissed) return;
    const el = document.getElementById('aiProgressCard');
    if (el) el.style.display = '';
}

function hideAIProgressCard() {
    _aiProgressCardDismissed = true;
    const el = document.getElementById('aiProgressCard');
    if (el) el.style.display = 'none';
}

function resetAIProgressCard() {
    _aiProgressCardDismissed = false;
    const el = document.getElementById('aiProgressCard');
    if (el) el.style.display = '';
}

function _setProgressText(text) {
    const el = document.getElementById('aiProgressText');
    if (el) el.textContent = text;
}

function _applyDrugRowUpdate(u) {
    if (!u || !u.drug_id) return;
    const row = document.getElementById(`drug-row-${u.drug_id}`);
    if (!row) return;

    const indication = (u.indication || '-');
    const adults = (u.dosage_adults || '-');
    const peds = (u.dosage_peds || '-');

    const c1 = row.querySelector('.col-indication');
    const c2 = row.querySelector('.col-adults');
    const c3 = row.querySelector('.col-peds');
    if (c1) c1.textContent = indication;
    if (c2) c2.textContent = adults;
    if (c3) c3.textContent = peds;

    if (u.dosage_id) {
        row.setAttribute('data-has-dosage', '1');
        const actions = row.querySelector('.col-actions');
        if (actions) {
            actions.innerHTML = `
                <div class="action-buttons">
                    <button class="btn btn-view" data-id="${u.dosage_id}" data-toggle="modal" data-target="#viewDosageModal" title="View dosage">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-edit" data-id="${u.dosage_id}" data-toggle="modal" data-target="#editDosageModal" title="Edit dosage">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-delete" data-id="${u.dosage_id}" data-toggle="modal" data-target="#deleteDosageModal" title="Delete dosage">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }
    }
}

function startAIDosageJob(opts) {
    const kind = (opts && opts.kind) ? opts.kind : 'drug';
    const mode = (opts && opts.mode) ? opts.mode : 'full';
    const limit = (opts && opts.limit) ? opts.limit : 50;
    if (_aiJobPollTimer) {
        clearTimeout(_aiJobPollTimer);
        _aiJobPollTimer = null;
    }
    _aiJobLastSeq = 0;

    resetAIProgressCard();
    showAIProgressCard();
    _setProgressText('Starting generation...');
    $('#aiProgressCounts').text('0/0');

    $.post('{{ url_for("admin_start_ai_dosage_agent_job") }}', {
        csrf_token: '{{ csrf_token() }}',
        kind: kind,
        mode: mode,
        limit: String(limit || 10),
    }).done(function(resp) {
        const jobId = resp && resp.job_id ? resp.job_id : null;
        if (!jobId) {
            _setProgressText('Failed to start AI job.');
            return;
        }
        pollAIDosageJob(jobId);
    }).fail(function(xhr) {
        const msg = (xhr && xhr.responseJSON && xhr.responseJSON.error) ? xhr.responseJSON.error : 'Failed to start AI job';
        _setProgressText(msg);
        $('#aiProgressCounts').text('');
    });
}

function pollAIDosageJob(jobId) {
    $.getJSON(`/admin/dosage/ai-agent/job/${jobId}/status?since=${_aiJobLastSeq}`, function(s) {
        const total = parseInt(s.total || 0, 10);
        const processed = parseInt(s.processed || 0, 10);
        const remaining = parseInt(s.remaining || 0, 10);
        const completed = parseInt(s.completed || 0, 10);
        const failed = parseInt(s.failed || 0, 10);

        const counts = `${processed}/${total} (remaining: ${remaining})`;
        $('#aiProgressCounts').text(counts);
        _setProgressText(`Generating... Completed: ${completed}/${total}. Failed: ${failed}.`);

        const updates = s.updates || [];
        updates.forEach(function(u) {
            const seq = parseInt(u.seq || 0, 10);
            if (seq > _aiJobLastSeq) _aiJobLastSeq = seq;
            if (u.kind === 'drug') _applyDrugRowUpdate(u);
        });

        if (s.status === 'running' || s.status === 'starting') {
            _aiJobPollTimer = setTimeout(function() { pollAIDosageJob(jobId); }, 1200);
            return;
        }

        if (s.status === 'complete') {
            _setProgressText('Generation complete.');
        } else {
            _setProgressText('Generation stopped with errors.');
        }

        setTimeout(function() {
            const el = document.getElementById('aiProgressCard');
            if (el) el.style.display = 'none';
            if (s.complete_url) {
                window.location.href = s.complete_url;
            }
        }, 700);
    }).fail(function() {
        _setProgressText('Lost connection while polling.');
        _aiJobPollTimer = setTimeout(function() { pollAIDosageJob(jobId); }, 2000);
    });
}

function checkTableHeight() {
    const tableContainer = document.getElementById('tableContainer');
    const tbody = document.querySelector('#dosageTable tbody');
    const rowCount = tbody.querySelectorAll('tr').length;
    
    if (rowCount > 5) {
        tableContainer.classList.add('has-scroll');
    } else {
        tableContainer.classList.remove('has-scroll');
    }
}

function autoCloseAlerts() {
    const alerts = document.querySelectorAll('.auto-close-alert');
    alerts.forEach(alert => {
        setTimeout(() => {
            alert.remove();
        }, 2000);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    updateDrugToggleState();
    checkTableHeight();
    autoCloseAlerts();
});

// Listen for storage changes from dashboard
window.addEventListener('storage', function(e) {
    if (e.key === 'ai_dosage_master_enabled') {
        updateDrugToggleState();
    }
});

</script>

<!-- Add Dosage Modal -->
<div class="modal fade" id="addDosageModal" tabindex="-1" role="dialog" aria-labelledby="addDosageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addDosageModalLabel">Add New Dosage Information</h5>
                <button type="button" class="close" data-dismiss="modal" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="POST" action="{{ url_for('manage_dosage') }}">  {# Changed to match error endpoint #}
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>  {# Added CSRF token #}
                <input type="hidden" name="action" value="add">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="drug_id">Select Drug</label>
                        <select class="form-control" id="drug_id" name="drug_id" required>
                            <option value="">-- Select Drug --</option>
                            {% for drug in drugs %}
                                {% if not drug.dosage %}
                                    <option value="{{ drug.id }}">{{ drug.drug_number }} - {{ drug.name }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Only drugs without existing dosage information are listed</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="indication">Indication</label>
                        <textarea class="form-control" id="indication" name="indication" rows="3" placeholder="Medical conditions this drug is used to treat"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="contraindication">Contraindication</label>
                        <textarea class="form-control" id="contraindication" name="contraindication" rows="3" placeholder="Conditions where this drug should not be used"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="interaction">Drug Interaction</label>
                        <textarea class="form-control" id="interaction" name="interaction" rows="3" placeholder="Other drugs that interact with this medication"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="side_effects">Side Effects</label>
                        <textarea class="form-control" id="side_effects" name="side_effects" rows="3" placeholder="Potential adverse effects of this drug"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="dosage_peds">Dosage (Pediatrics)</label>
                                <textarea class="form-control" id="dosage_peds" name="dosage_peds" rows="3" placeholder="Dosage instructions for children"></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="dosage_adults">Dosage (Adults)</label>
                                <textarea class="form-control" id="dosage_adults" name="dosage_adults" rows="3" placeholder="Dosage instructions for adults"></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="dosage_geriatrics">Dosage (Geriatrics)</label>
                                <textarea class="form-control" id="dosage_geriatrics" name="dosage_geriatrics" rows="3" placeholder="Dosage instructions for elderly patients"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="important_notes">Important Notes</label>
                        <textarea class="form-control" id="important_notes" name="important_notes" rows="3" placeholder="Special instructions, warnings, or precautions"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Dosage Information</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Dosage Modal -->
<div class="modal fade" id="editDosageModal" tabindex="-1" role="dialog" aria-labelledby="editDosageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editDosageModalLabel">Edit Dosage Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('manage_dosage') }}">  {# Changed to match error endpoint #}
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>  {# Added CSRF token #}
                <input type="hidden" name="action" value="edit">
                <input type="hidden" id="edit_dosage_id" name="dosage_id">
                <input type="hidden" id="edit_drug_id" value="">
                <div class="modal-body">
                    <div class="alert alert-info" style="font-size: 0.95rem;">
                        <strong>AI Suggest:</strong> fills only empty fields using AI-only generation. Please review before saving.
                    </div>
                    <div class="form-group">
                        <label>Drug</label>
                        <p class="form-control-static" id="edit_drug_info"></p>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit_indication">Indication</label>
                        <textarea class="form-control" id="edit_indication" name="indication" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit_contraindication">Contraindication</label>
                        <textarea class="form-control" id="edit_contraindication" name="contraindication" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit_interaction">Drug Interaction</label>
                        <textarea class="form-control" id="edit_interaction" name="interaction" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit_side_effects">Side Effects</label>
                        <textarea class="form-control" id="edit_side_effects" name="side_effects" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit_dosage_peds">Dosage (Pediatrics)</label>
                                <textarea class="form-control" id="edit_dosage_peds" name="dosage_peds" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit_dosage_adults">Dosage (Adults)</label>
                                <textarea class="form-control" id="edit_dosage_adults" name="dosage_adults" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit_dosage_geriatrics">Dosage (Geriatrics)</label>
                                <textarea class="form-control" id="edit_dosage_geriatrics" name="dosage_geriatrics" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit_important_notes">Important Notes</label>
                        <textarea class="form-control" id="edit_important_notes" name="important_notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-outline-success" id="btn_ai_suggest_drug">
                        <i class="fas fa-magic"></i> AI Suggest
                    </button>
                    <button type="submit" class="btn btn-primary">Update Dosage Information</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Dosage Modal -->
<div class="modal fade" id="viewDosageModal" tabindex="-1" role="dialog" aria-labelledby="viewDosageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewDosageModalLabel">Dosage Information Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Basic Information</h5>
                        <table class="table table-bordered">
                            <tr>
                                <th>Drug Number</th>
                                <td id="view_drug_number"></td>
                            </tr>
                            <tr>
                                <th>Drug Name</th>
                                <td id="view_drug_name"></td>
                            </tr>
                        </table>
                        
                        <h5>Medical Information</h5>
                        <table class="table table-bordered">
                            <tr>
                                <th>Indication</th>
                                <td id="view_indication"></td>
                            </tr>
                            <tr>
                                <th>Contraindication</th>
                                <td id="view_contraindication"></td>
                            </tr>
                            <tr>
                                <th>Drug Interaction</th>
                                <td id="view_interaction"></td>
                            </tr>
                            <tr>
                                <th>Side Effects</th>
                                <td id="view_side_effects"></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5>Dosage Information</h5>
                        <div class="card mb-3">
                            <div class="card-header bg-info text-white">
                                Pediatrics
                            </div>
                            <div class="card-body">
                                <div id="view_dosage_peds" class="card-text dosage-points"></div>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-primary text-white">
                                Adults
                            </div>
                            <div class="card-body">
                                <div id="view_dosage_adults" class="card-text dosage-points"></div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header bg-secondary text-white">
                                Geriatrics
                            </div>
                            <div class="card-body">
                                <div id="view_dosage_geriatrics" class="card-text dosage-points"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h5>Important Notes</h5>
                    <div class="card">
                        <div class="card-body">
                            <div id="view_important_notes" class="card-text dosage-points"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteDosageModal" tabindex="-1" role="dialog" aria-labelledby="deleteDosageModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteDosageModalLabel">Confirm Deletion</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="POST" action="{{ url_for('manage_dosage') }}">  {# Changed to match error endpoint #}
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>  {# Added CSRF token #}
                <input type="hidden" name="action" value="delete">
                <input type="hidden" id="delete_dosage_id" name="dosage_id">
                <div class="modal-body">
                    <p>Are you sure you want to delete this dosage information? This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete Information</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>

<!-- JavaScript for handling modals -->
<script>
$(document).ready(function() { 
    function escapeHtml(value) {
        return String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function splitToBulletItems(text) {
        const raw = (text === null || text === undefined) ? '' : String(text);
        let t = raw.replace(/\r/g, '').trim();
        if (!t) return [];

        // Make bullet character a reliable splitter.
        t = t.replace(/\s*•\s*/g, '\n• ');

        const lines = t.split('\n').map(s => s.trim()).filter(Boolean);
        const items = [];
        for (const line of lines) {
            const cleaned = line
                .replace(/^([•\u2022\-*]+\s*)/, '')
                .replace(/^\d+[\).]\s*/, '')
                .trim();
            if (cleaned) items.push(cleaned);
        }
        return items.length ? items : [t];
    }

    function renderBullets(text, emptyLabel) {
        const items = splitToBulletItems(text);
        if (!items.length) {
            return `<span class="text-muted">${escapeHtml(emptyLabel || 'Not specified')}</span>`;
        }
        const lis = items.map(i => `<li>${escapeHtml(i)}</li>`).join('');
        return `<ul class="mb-0 pl-3">${lis}</ul>`;
    }

    $(document).on('click', '.btn-add-dosage', function() {
        const drugId = $(this).data('drug-id');
        if (!drugId) return;
        $('#drug_id').val(String(drugId));
    });

    // Edit dosage modal handler
    $(document).on('click', '.btn-edit', function() {
        const dosageId = $(this).data('id');
        $.get('/admin/dosage/' + dosageId, function(data) {
            $('#edit_dosage_id').val(data.id);
            $('#edit_drug_id').val(data.drug.id);
            $('#edit_drug_info').text(data.drug.drug_number + ' - ' + data.drug.name);
            $('#edit_indication').val(data.indication || '');
            $('#edit_contraindication').val(data.contraindication || '');
            $('#edit_interaction').val(data.interaction || '');
            $('#edit_side_effects').val(data.side_effects || '');
            $('#edit_dosage_peds').val(data.dosage_peds || '');
            $('#edit_dosage_adults').val(data.dosage_adults || '');
            $('#edit_dosage_geriatrics').val(data.dosage_geriatrics || '');
            $('#edit_important_notes').val(data.important_notes || '');
        }).fail(function() {
            alert('Failed to load dosage information');
        });
    });

    function fillIfEmpty($el, value) {
        if (!$el.length) return;
        const current = ($el.val() || '').trim();
        if (current) return;
        if (value === null || value === undefined) return;
        const v = String(value).trim();
        if (!v) return;
        $el.val(v);
    }

    $('#btn_ai_suggest_drug').on('click', function() {
        const drugId = parseInt($('#edit_drug_id').val() || '0', 10);
        if (!drugId) {
            alert('Missing drug id for AI suggestion');
            return;
        }

        const $btn = $(this);
        $btn.prop('disabled', true).text('Suggesting...');
        $.get(`/admin/dosage/ai-suggest?kind=drug&drug_id=${drugId}`, function(resp) {
            const s = resp && resp.suggested ? resp.suggested : null;
            if (!s) {
                alert('No suggestion available for this drug.');
                return;
            }
            fillIfEmpty($('#edit_indication'), s.indication);
            fillIfEmpty($('#edit_contraindication'), s.contraindication);
            fillIfEmpty($('#edit_interaction'), s.interaction);
            fillIfEmpty($('#edit_side_effects'), s.side_effects);
            fillIfEmpty($('#edit_dosage_peds'), s.dosage_peds);
            fillIfEmpty($('#edit_dosage_adults'), s.dosage_adults);
            fillIfEmpty($('#edit_dosage_geriatrics'), s.dosage_geriatrics);
            fillIfEmpty($('#edit_important_notes'), s.important_notes);
        }).fail(function(xhr) {
            const msg = (xhr && xhr.responseJSON && xhr.responseJSON.error) ? xhr.responseJSON.error : 'AI suggestion failed';
            alert(msg);
        }).always(function() {
            $btn.prop('disabled', false).html('<i class="fas fa-magic"></i> AI Suggest');
        });
    });
    
    // View dosage modal handler
    $(document).on('click', '.btn-view', function() {
        const dosageId = $(this).data('id');
        $.get('/admin/dosage/' + dosageId, function(data) {
            $('#view_drug_number').text(data.drug.drug_number);
            $('#view_drug_name').text(data.drug.name);
            $('#view_indication').html(renderBullets(data.indication, 'Not specified'));
            $('#view_contraindication').html(renderBullets(data.contraindication, 'Not specified'));
            $('#view_interaction').html(renderBullets(data.interaction, 'Not specified'));
            $('#view_side_effects').html(renderBullets(data.side_effects, 'Not specified'));
            $('#view_dosage_peds').html(renderBullets(data.dosage_peds, 'Not specified'));
            $('#view_dosage_adults').html(renderBullets(data.dosage_adults, 'Not specified'));
            $('#view_dosage_geriatrics').html(renderBullets(data.dosage_geriatrics, 'Not specified'));
            $('#view_important_notes').html(renderBullets(data.important_notes, 'Not specified'));
        }).fail(function() {
            alert('Failed to load dosage information');
        });
    });
    
    // Delete dosage modal handler
    $(document).on('click', '.btn-delete', function() {
        $('#delete_dosage_id').val($(this).data('id'));
    });
    
    // Show only drugs without dosage info in add modal
    $('#addDosageModal').on('show.bs.modal', function() {
        $.get('/admin/drugs/without-dosage', function(data) {
            $('#drug_id').empty().append('<option value="">-- Select Drug --</option>');
            data.forEach(function(drug) {
                $('#drug_id').append(`<option value="${drug.id}">${drug.drug_number} - ${drug.name}</option>`);
            });
        }).fail(function() {
            alert('Failed to load drugs without dosage information');
        });
    });
});
</script>

<style>
    .dosage-points ul {
        padding-left: 1.25rem;
        margin-bottom: 0;
    }
    .dosage-points li {
        margin-bottom: 0.25rem;
    }
    /* Table styling */
    .data-table {
        width: 100%;
        margin-bottom: 1rem;
        background-color: transparent;
    }
    
    .data-table th {
        background-color: #116cc2;
        color: white;
        padding: 0.75rem;
    }
    
    .data-table td {
        padding: 0.5rem;
        vertical-align: middle;
    }
    
    .data-table tbody tr:nth-child(odd) {
        background-color: rgba(0, 0, 0, 0.05);
    }
    
    /* Button styling */
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        line-height: 1.5;
    }
    
    .btn-view {
        color: #17a2b8;
        background-color: transparent;
        border-color: #17a2b8;
    }
    
    .btn-view:hover {
        color: #fff;
        background-color: #17a2b8;
        border-color: #17a2b8;
    }
    
    /* Modal styling */
    .modal-lg {
        max-width: 900px;
    }
    
    /* Card styling for view modal */
    .card-header {
        font-weight: bold;
    }
    
    .card-text {
        white-space: pre-line;
    }
    
    /* Responsive table */
    .table-responsive {
        display: block;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
</style>
{% endblock %}