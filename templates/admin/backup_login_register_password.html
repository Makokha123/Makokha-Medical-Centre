{% extends "base.html" %}

{% block title %}Register Backup Access - Step 3 - {{ config['APP_NAME'] }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-key"></i> Register Backup Access
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Step Indicator -->
                    <div class="row mb-4">
                        <div class="col-md-4 text-center">
                            <div class="step-circle completed">✓</div>
                            <small class="text-muted">Email</small>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="step-circle completed">✓</div>
                            <small class="text-muted">OTP</small>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="step-circle active">3</div>
                            <small class="text-primary"><strong>Password</strong></small>
                        </div>
                    </div>

                    <h5 class="mb-3">Step 3: Create Backup Access Password</h5>
                    <p class="text-muted">Set a strong, unique password for backup access</p>

                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="close" data-dismiss="alert">
                                        <span>&times;</span>
                                    </button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <form method="POST" class="needs-validation" novalidate id="passwordForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <div class="form-group">
                            <label for="password">
                                <strong>Password</strong>
                            </label>
                            <input 
                                type="password" 
                                class="form-control form-control-lg" 
                                id="password" 
                                name="password"
                                placeholder="Enter strong password" 
                                required
                                autofocus
                            >
                            <small class="form-text text-muted">
                                Must be at least 8 characters with uppercase, lowercase, digit, and symbol
                            </small>
                            <div class="invalid-feedback" id="passwordFeedback">
                                Please enter a valid password.
                            </div>

                            <!-- Password Strength Indicator -->
                            <div class="mt-2">
                                <small>Password Strength:</small>
                                <div class="progress" style="height: 5px;">
                                    <div id="strengthBar" class="progress-bar" style="width: 0%"></div>
                                </div>
                                <small id="strengthText" class="text-muted"></small>
                            </div>

                            <!-- Password Requirements Checklist -->
                            <div class="mt-3 small">
                                <div class="requirement" id="req-length">
                                    <i class="fas fa-circle text-muted"></i> At least 8 characters
                                </div>
                                <div class="requirement" id="req-upper">
                                    <i class="fas fa-circle text-muted"></i> One uppercase letter (A-Z)
                                </div>
                                <div class="requirement" id="req-lower">
                                    <i class="fas fa-circle text-muted"></i> One lowercase letter (a-z)
                                </div>
                                <div class="requirement" id="req-digit">
                                    <i class="fas fa-circle text-muted"></i> One digit (0-9)
                                </div>
                                <div class="requirement" id="req-symbol">
                                    <i class="fas fa-circle text-muted"></i> One special character (!@#$%)
                                </div>
                            </div>
                        </div>

                        <div class="form-group mt-4">
                            <label for="confirm_password">
                                <strong>Confirm Password</strong>
                            </label>
                            <input 
                                type="password" 
                                class="form-control form-control-lg" 
                                id="confirm_password" 
                                name="confirm_password"
                                placeholder="Re-enter your password" 
                                required
                            >
                            <small class="form-text text-muted" id="matchFeedback">
                                Passwords must match
                            </small>
                            <div class="invalid-feedback">
                                Passwords do not match.
                            </div>
                        </div>

                        <div class="alert alert-info" role="alert">
                            <h6>Password Requirements:</h6>
                            <ul class="mb-0">
                                <li>Minimum 8 characters</li>
                                <li>Must include uppercase, lowercase, number, and special character</li>
                                <li>This password is <strong>separate</strong> from your admin account password</li>
                                <li>Store it securely - you'll need it to access backups</li>
                            </ul>
                        </div>

                        <button type="submit" class="btn btn-success btn-lg btn-block" id="submitBtn">
                            <i class="fas fa-check"></i> Complete Registration
                        </button>

                        <a href="{{ url_for('backup_login_register_email') }}" class="btn btn-secondary btn-block mt-2">
                            <i class="fas fa-arrow-left"></i> Start Over
                        </a>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .step-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 20px;
        margin: 0 auto 10px;
        border: 2px solid #ddd;
        background-color: #f8f9fa;
        color: #6c757d;
    }

    .step-circle.active {
        background-color: #0069d9;
        color: white;
        border-color: #0069d9;
    }

    .step-circle.completed {
        background-color: #28a745;
        color: white;
        border-color: #28a745;
        font-size: 24px;
    }

    .requirement {
        padding: 4px 0;
        color: #6c757d;
    }

    .requirement i {
        margin-right: 6px;
        width: 16px;
        text-align: center;
    }

    .requirement.met {
        color: #28a745;
    }

    .requirement.met i {
        color: #28a745;
    }
</style>

<script>
    const passwordInput = document.getElementById('password');
    const confirmInput = document.getElementById('confirm_password');
    const strengthBar = document.getElementById('strengthBar');
    const strengthText = document.getElementById('strengthText');
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('passwordForm');

    function checkPasswordStrength(password) {
        let strength = 0;
        const requirements = {
            'length': password.length >= 8,
            'upper': /[A-Z]/.test(password),
            'lower': /[a-z]/.test(password),
            'digit': /\d/.test(password),
            'symbol': /[^A-Za-z0-9]/.test(password)
        };

        Object.values(requirements).forEach(req => {
            if (req) strength += 20;
        });

        // Update requirement indicators
        document.getElementById('req-length').classList.toggle('met', requirements.length);
        document.getElementById('req-upper').classList.toggle('met', requirements.upper);
        document.getElementById('req-lower').classList.toggle('met', requirements.lower);
        document.getElementById('req-digit').classList.toggle('met', requirements.digit);
        document.getElementById('req-symbol').classList.toggle('met', requirements.symbol);

        // Update strength bar
        strengthBar.style.width = strength + '%';
        if (strength < 40) {
            strengthBar.className = 'progress-bar bg-danger';
            strengthText.textContent = 'Weak';
            strengthText.className = 'text-danger';
        } else if (strength < 80) {
            strengthBar.className = 'progress-bar bg-warning';
            strengthText.textContent = 'Fair';
            strengthText.className = 'text-warning';
        } else {
            strengthBar.className = 'progress-bar bg-success';
            strengthText.textContent = 'Strong';
            strengthText.className = 'text-success';
        }

        return requirements;
    }

    passwordInput.addEventListener('input', function() {
        const reqs = checkPasswordStrength(this.value);
        const allMet = Object.values(reqs).every(r => r);
        
        // Enable/disable submit button based on all requirements met
        const passwordsMatch = this.value === confirmInput.value && this.value.length > 0;
        submitBtn.disabled = !(allMet && passwordsMatch);
    });

    confirmInput.addEventListener('input', function() {
        const match = passwordInput.value === this.value;
        const reqs = checkPasswordStrength(passwordInput.value);
        const allMet = Object.values(reqs).every(r => r);
        
        if (this.value.length > 0) {
            document.getElementById('matchFeedback').textContent = match ? 
                '✓ Passwords match' : 
                '✗ Passwords do not match';
            document.getElementById('matchFeedback').className = match ? 
                'form-text text-success' : 
                'form-text text-danger';
        }
        
        submitBtn.disabled = !(allMet && match);
    });

    form.addEventListener('submit', function(e) {
        const reqs = checkPasswordStrength(passwordInput.value);
        const allMet = Object.values(reqs).every(r => r);
        const passwordsMatch = passwordInput.value === confirmInput.value;

        if (!allMet || !passwordsMatch) {
            e.preventDefault();
            e.stopPropagation();
            form.classList.add('was-validated');
        }
    });

    // Initialize submit button state
    submitBtn.disabled = true;
</script>
{% endblock %}
