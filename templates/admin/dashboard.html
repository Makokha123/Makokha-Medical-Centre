{% extends "base.html" %}

{% block content %}
<!-- Add this to the head section of all your base templates -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<div class="content">
    <div class="section-content active" id="dashboard-section">
        <h2>Admin Dashboard</h2>
        
        <div class="dashboard-widgets">
            <div class="widget">
                <div class="widget-header">
                    <h3><i class="fas fa-pills"></i> Drug Inventory</h3>
                </div>
                <div class="widget-body">
                    <div class="widget-item">
                        <span class="widget-label">Total Drugs:</span>
                        <span class="widget-value">{{ total_drugs }}</span>
                    </div>
                    <div class="widget-item">
                        <span class="widget-label">Low Stock:</span>
                        <span class="widget-value">{{ low_stock }}</span>
                    </div>
                    <div class="widget-item">
                        <span class="widget-label">Expiring Soon:</span>
                        <span class="widget-value">{{ expiring_soon }}</span>
                    </div>
                </div>
            </div>
            
            <div class="widget">
                <div class="widget-header">
                    <h3><i class="fas fa-chart-line"></i> Financial Summary</h3>
                </div>
                <div class="widget-body">
                    <div class="widget-item">
                        <span class="widget-label">Today's Sales:</span>
                        <span class="widget-value">Ksh.{{ "%.2f"|format(today_sales) }}</span>
                    </div>
                    <div class="widget-item">
                        <span class="widget-label">Monthly Sales:</span>
                        <span class="widget-value">Ksh.{{ "%.2f"|format(monthly_sales) }}</span>
                    </div>
                    <div class="widget-item">
                        <span class="widget-label">Pending Bills:</span>
                        <span class="widget-value">Ksh.{{ "%.2f"|format(pending_bills) }}</span>
                    </div>
                </div>
            </div>
            
            <div class="widget">
                <div class="widget-header">
                    <h3><i class="fas fa-server"></i> System Status</h3>
                </div>
                <div class="widget-body">
                    <div class="widget-item">
                        <span class="widget-label">Last Backup:</span>
                        <span class="widget-value">
                            {% if last_backup_time != 'Never' %}
                                {{ last_backup_time.strftime('%Y-%m-%d %H:%M') }}
                            {% else %}
                                Never
                            {% endif %}
                        </span>
                    </div>
                    <div class="widget-item">
                        <span class="widget-label">Active Users:</span>
                        <span class="widget-value">{{ active_users }}</span>
                    </div>
                    <div class="widget-actions">
                        <a href="{{ url_for('backup_management') }}" class="btn btn-primary">
                            <i class="fas fa-database"></i> Backup Now
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Doctor Statistics Section -->
        <div class="doctor-stats-section">
            <h3><i class="fas fa-user-md"></i> Doctor Statistics</h3>
            
            <div class="timeframe-tabs">
                <button class="timeframe-tab active" onclick="showTimeframe('daily')">Daily</button>
                <button class="timeframe-tab" onclick="showTimeframe('monthly')">Monthly</button>
                <button class="timeframe-tab" onclick="showTimeframe('yearly')">Yearly</button>
            </div>
            
            <!-- Daily Stats -->
            <div id="daily-stats" class="timeframe-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">{{ daily_stats.inpatients }}</div>
                        <div class="stat-label">Inpatients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ daily_stats.outpatients }}</div>
                        <div class="stat-label">Outpatients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ daily_stats.discharged }}</div>
                        <div class="stat-label">Discharged</div>
                    </div>
                    <div class="stat-card">
                        <div class="bed-stat-value">
                            {% if daily_stats.total_beds > 0 %}
                                {{ ((daily_stats.occupied_beds / daily_stats.total_beds) * 100) | round(1) }}%
                            {% else %}
                                0%
                            {% endif %}
                        </div>
                        <div class="stat-label">Beds Occupied</div>
                    </div>
                </div>
                <div class="stats-date">Date: {{ daily_stats.start_date.strftime('%Y-%m-%d') }}</div>
            </div>
            
            <!-- Monthly Stats -->
            <div id="monthly-stats" class="timeframe-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">{{ monthly_stats.inpatients }}</div>
                        <div class="stat-label">Inpatients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ monthly_stats.outpatients }}</div>
                        <div class="stat-label">Outpatients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ monthly_stats.discharged }}</div>
                        <div class="stat-label">Discharged</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ monthly_stats.occupied_beds }}/{{ monthly_stats.total_beds }}</div>
                        <div class="stat-label">Avg Beds Occupied</div>
                    </div>
                </div>
                <div class="stats-date">
                    Period: {{ monthly_stats.start_date.strftime('%Y-%m-%d') }} to {{ monthly_stats.end_date.strftime('%Y-%m-%d') }}
                </div>
            </div>
            
            <!-- Yearly Stats -->
            <div id="yearly-stats" class="timeframe-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">{{ yearly_stats.inpatients }}</div>
                        <div class="stat-label">Inpatients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ yearly_stats.outpatients }}</div>
                        <div class="stat-label">Outpatients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ yearly_stats.discharged }}</div>
                        <div class="stat-label">Discharged</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ yearly_stats.occupied_beds }}/{{ yearly_stats.total_beds }}</div>
                        <div class="stat-label">Avg Beds Occupied</div>
                    </div>
                </div>
                <div class="stats-date">
                    Period: {{ yearly_stats.start_date.strftime('%Y-%m-%d') }} to {{ yearly_stats.end_date.strftime('%Y-%m-%d') }}
                </div>
            </div>
        </div>
        
        <!-- Bed Status Summary -->
        <div class="bed-status-section">
            <h3><i class="fas fa-bed"></i> Bed Status Summary</h3>
            <div class="bed-stats-grid">
                <div class="bed-stat-card">
                    <div class="bed-stat-value">{{ daily_stats.total_beds }}</div>
                    <div class="bed-stat-label">Total Beds</div>
                    <a href="{{ url_for('manage_beds') }}" class="bed-stat-link">View All</a>
                </div>
                <div class="bed-stat-card">
                    <div class="bed-stat-value">{{ daily_stats.occupied_beds }}</div>
                    <div class="bed-stat-label">Occupied</div>
                    <a href="{{ url_for('manage_beds') }}?status=occupied" class="bed-stat-link">View Occupied</a>
                </div>
                <div class="bed-stat-card">
                    <div class="bed-stat-value">{{ daily_stats.available_beds }}</div>
                    <div class="bed-stat-label">Available</div>
                    <a href="{{ url_for('manage_beds') }}?status=available" class="bed-stat-link">View Available</a>
                </div>
                <div class="bed-stat-card">
                    <div class="bed-stat-value">
                        {% if daily_stats.total_beds > 0 %}
                            {{ ((daily_stats.occupied_beds / daily_stats.total_beds) * 100) | round(1) }}%
                        {% else %}
                            0%
                        {% endif %}
                    </div>
                    <div class="bed-stat-label">Occupancy Rate</div>
                    <a href="{{ url_for('manage_beds') }}" class="bed-stat-link">Manage Beds</a>
                </div>
            </div>
        </div>
        
        <div class="recent-activity">
            <h3><i class="fas fa-history"></i> Recent Activity</h3>
            <table class="activity-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>User</th>
                        <th>Action</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in recent_activity %}
                    <tr>
                        <td>{{ log.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>{{ log.user.username if log.user else 'System' }}</td>
                        <td>{{ log.action }}</td>
                        <td>
                            {% if log.table_name and log.record_id %}
                                {{ log.table_name }} #{{ log.record_id }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

<style>
/* Dashboard Widgets */
.dashboard-widgets {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.widget {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
}

.widget-header {
    padding: 15px;
    background: #3498db;
    color: white;
}

.widget-header h3 {
    margin: 0;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.widget-body {
    padding: 15px;
}

.widget-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.widget-item:last-child {
    border-bottom: none;
}

.widget-label {
    font-weight: 500;
    color: #555;
}

.widget-value {
    font-weight: bold;
    color: #2c3e50;
}

.widget-actions {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 8px 15px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    font-size: 14px;
}

.btn-primary {
    background: #3498db;
}

.btn:hover {
    opacity: 0.9;
}

/* Doctor Statistics Section */
.doctor-stats-section {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.timeframe-tabs {
    display: flex;
    margin-bottom: 20px;
    border-bottom: 1px solid #eee;
}

.timeframe-tab {
    padding: 8px 16px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    color: #666;
    border-bottom: 2px solid transparent;
}

.timeframe-tab.active {
    color: #3498db;
    border-bottom: 2px solid #3498db;
    font-weight: 500;
}

.timeframe-content {
    display: none;
}

.timeframe-content.active {
    display: block;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    margin-bottom: 15px;
}

.stat-card {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 15px;
    text-align: center;
}

.stat-value {
    font-size: 24px;
    font-weight: bold;
    color: #2c3e50;
}

.stat-label {
    font-size: 14px;
    color: #7f8c8d;
}

.stats-date {
    font-size: 13px;
    color: #95a5a6;
    text-align: right;
    font-style: italic;
}

/* Bed Status Section */
.bed-status-section {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.bed-stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
}

.bed-stat-card {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 15px;
    text-align: center;
    position: relative;
}

.bed-stat-value {
    font-size: 28px;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 5px;
}

.bed-stat-label {
    font-size: 14px;
    color: #7f8c8d;
    margin-bottom: 10px;
}

.bed-stat-link {
    display: block;
    font-size: 12px;
    color: #3498db;
    text-decoration: none;
    margin-top: 10px;
}

.bed-stat-link:hover {
    text-decoration: underline;
}

/* Recent Activity */
.recent-activity {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.activity-table {
    width: 100%;
    border-collapse: collapse;
}

.activity-table th, .activity-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.activity-table th {
    background: #f5f5f5;
    font-weight: 500;
    color: #555;
}

.activity-table tr:hover {
    background: #f9f9f9;
}

/* Responsive adjustments */
@media (max-width: 1200px) {
    .stats-grid, .bed-stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .dashboard-widgets {
        grid-template-columns: 1fr;
    }
    
    .stats-grid, .bed-stats-grid {
        grid-template-columns: 1fr;
    }
    
    .activity-table {
        display: block;
        overflow-x: auto;
    }
}
</style>

<!-- DataTables and other JS libraries -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>

<script>
function toggleSidebar() {
    const sidebar = document.querySelector('.sidebar');
    sidebar.classList.toggle('collapsed');
    
    // Update all section contents
    document.querySelectorAll('.section-content').forEach(section => {
        section.classList.remove('active');
    });
    document.getElementById('dashboard-section').classList.add('active');
}

// Handle menu item clicks
document.querySelectorAll('.sidebar-menu a').forEach(item => {
    item.addEventListener('click', function(e) {
        // Collapse sidebar when menu item is clicked
        document.querySelector('.sidebar').classList.add('collapsed');
        
        // Update active menu item
        document.querySelectorAll('.sidebar-menu a').forEach(link => {
            link.classList.remove('active');
        });
        this.classList.add('active');
    });
});

// Initialize DataTables
$(document).ready(function() {
    $('.activity-table').DataTable({
        "order": [[0, "desc"]],
        "pageLength": 5
    });
});

function showTimeframe(timeframe) {
    // Hide all timeframe contents
    document.querySelectorAll('.timeframe-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Show selected timeframe content
    document.getElementById(`${timeframe}-stats`).classList.add('active');
    
    // Update active tab
    document.querySelectorAll('.timeframe-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
}
</script>
{% endblock %}