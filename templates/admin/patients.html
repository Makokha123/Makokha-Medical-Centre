{% extends "base.html" %}

{% block content %}
<!-- Add this to the head section of all your base templates -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
            
            <!-- Date Filter Form -->
            <div class="card mb-4">
                <div class="card-body">
                    <form id="dateFilterForm" class="form-inline">
                        <div class="form-group mr-3">
                            <label for="startDate" class="mr-2">From:</label>
                            <input type="date" class="form-control" id="startDate" name="start_date">
                        </div>
                        <div class="form-group mr-3">
                            <label for="endDate" class="mr-2">To:</label>
                            <input type="date" class="form-control" id="endDate" name="end_date">
                        </div>
                        <button type="submit" class="btn btn-primary mr-2">Filter</button>
                        <button type="button" id="resetFilter" class="btn btn-secondary">Reset</button>
                    </form>
                </div>
            </div>
            
            <!-- Summary Box -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Financial Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="summary-box bg-light p-3">
                                <h6>Total Lab Amount</h6>
                                <p id="totalLabAmount">$0.00</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-box bg-light p-3">
                                <h6>Total Service Amount</h6>
                                <p id="totalServiceAmount">$0.00</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-box bg-light p-3">
                                <h6>Total Drug Amount</h6>
                                <p id="totalDrugAmount">$0.00</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-box bg-light p-3">
                                <h6>Total Amount</h6>
                                <p id="totalAmount">$0.00</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="data-table" id="patientsTable">
                    <thead>
                        <tr>
                            <th>Patient No.</th>
                            <th>Config.decrypt_data_staticName</th>
                            <th>Chief Complain</th>
                            <th>Diagnosis</th>
                            <th>Lab Done</th>
                            <th>Lab Amount</th>
                            <th>Services Done</th>
                            <th>Services Amount</th>
                            <th>Drug Name</th>
                            <th>Quantity</th>
                            <th>Drug Amount</th>
                            <th>Total Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for patient in patients %}
                        <tr>
                            <td>{{ patient.op_number or patient.ip_number }}</td>
                            <td>{{ patient.name }}</td>
                            <td>{{ patient.chief_complaints|default('-', true)|truncate(30) }}</td>
                            <td>{{ patient.diagnosis|default('-', true)|truncate(30) }}</td>
                            <td>
                                {% if patient.labs %}
                                    {% for lab in patient.labs %}
                                        {{ lab.test.name }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if patient.labs %}
                                    ${% for lab in patient.labs %}{{ lab.test.price }}{% if not loop.last %} + {% endif %}{% endfor %}
                                {% else %}
                                    $0.00
                                {% endif %}
                            </td>
                            <td>
                                {% if patient.services %}
                                    {% for service in patient.services %}
                                        {{ service.service.name }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if patient.services %}
                                    ${% for service in patient.services %}{{ service.service.price }}{% if not loop.last %} + {% endif %}{% endfor %}
                                {% else %}
                                    $0.00
                                {% endif %}
                            </td>
                            <td>
                                {% if patient.prescriptions %}
                                    {% for prescription in patient.prescriptions %}
                                        {% for item in prescription.items %}
                                            {{ item.drug.name }}{% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if patient.prescriptions %}
                                    {% for prescription in patient.prescriptions %}
                                        {% for item in prescription.items %}
                                            {{ item.quantity }}{% if not loop.last %} + {% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if patient.prescriptions %}
                                    ${% for prescription in patient.prescriptions %}
                                        {% for item in prescription.items %}
                                            {{ item.drug.selling_price * item.quantity }}{% if not loop.last %} + {% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                {% else %}
                                    $0.00
                                {% endif %}
                            </td>
                            <td>
                                {% set total_amount = 0 %}
                                {% if patient.labs %}
                                    {% for lab in patient.labs %}
                                        {% set total_amount = total_amount + lab.test.price %}
                                    {% endfor %}
                                {% endif %}
                                {% if patient.services %}
                                    {% for service in patient.services %}
                                        {% set total_amount = total_amount + service.service.price %}
                                    {% endfor %}
                                {% endif %}
                                {% if patient.prescriptions %}
                                    {% for prescription in patient.prescriptions %}
                                        {% for item in prescription.items %}
                                            {% set total_amount = total_amount + (item.drug.selling_price * item.quantity) %}
                                        {% endfor %}
                                    {% endfor %}
                                {% endif %}
                                ${{ "%.2f"|format(total_amount) }}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-view" data-id="{{ patient.id }}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-edit" data-id="{{ patient.id }}" data-toggle="modal" data-target="#editPatientModal">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Patient Modal -->
<div class="modal fade" id="addPatientModal" tabindex="-1" role="dialog" aria-labelledby="addPatientModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addPatientModalLabel">Add New Patient</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="addPatientForm" method="POST" action="{{ url_for('manage_patients') }}">
                <input type="hidden" name="action" value="add">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="patient_type">Patient Type</label>
                                <select class="form-control" id="patient_type" name="patient_type" required>
                                    <option value="OP">Outpatient (OP)</option>
                                    <option value="IP">Inpatient (IP)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="name">Full Name</label>
                                <input type="text" class="form-control" id="name" name="name" required>
                            </div>
                            <div class="form-group">
                                <label for="age">Age</label>
                                <input type="number" class="form-control" id="age" name="age">
                            </div>
                            <div class="form-group">
                                <label for="gender">Gender</label>
                                <select class="form-control" id="gender" name="gender">
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="address">Address</label>
                                <textarea class="form-control" id="address" name="address" rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone Number</label>
                                <input type="text" class="form-control" id="phone" name="phone">
                            </div>
                            <div class="form-group">
                                <label for="nok_name">Next of Kin Name</label>
                                <input type="text" class="form-control" id="nok_name" name="nok_name">
                            </div>
                            <div class="form-group">
                                <label for="nok_contact">Next of Kin Contact</label>
                                <input type="text" class="form-control" id="nok_contact" name="nok_contact">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="chief_complaints">Chief Complaints</label>
                        <textarea class="form-control" id="chief_complaints" name="chief_complaints" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="diagnosis">Diagnosis</label>
                        <textarea class="form-control" id="diagnosis" name="diagnosis" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="tca">To Come Again (TCA) Date</label>
                        <input type="date" class="form-control" id="tca" name="tca">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Patient</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Patient Modal -->
<div class="modal fade" id="editPatientModal" tabindex="-1" role="dialog" aria-labelledby="editPatientModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPatientModalLabel">Edit Patient</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="editPatientForm" method="POST" action="{{ url_for('manage_patients') }}">
                <input type="hidden" name="action" value="edit">
                <input type="hidden" id="edit_patient_id" name="patient_id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Patient Number</label>
                                <p class="form-control-static" id="edit_patient_number"></p>
                            </div>
                            <div class="form-group">
                                <label for="edit_name">Full Name</label>
                                <input type="text" class="form-control" id="edit_name" name="name" required>
                            </div>
                            <div class="form-group">
                                <label for="edit_age">Age</label>
                                <input type="number" class="form-control" id="edit_age" name="age">
                            </div>
                            <div class="form-group">
                                <label for="edit_gender">Gender</label>
                                <select class="form-control" id="edit_gender" name="gender">
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="edit_address">Address</label>
                                <textarea class="form-control" id="edit_address" name="address" rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="edit_phone">Phone Number</label>
                                <input type="text" class="form-control" id="edit_phone" name="phone">
                            </div>
                            <div class="form-group">
                                <label for="edit_nok_name">Next of Kin Name</label>
                                <input type="text" class="form-control" id="edit_nok_name" name="nok_name">
                            </div>
                            <div class="form-group">
                                <label for="edit_nok_contact">Next of Kin Contact</label>
                                <input type="text" class="form-control" id="edit_nok_contact" name="nok_contact">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="edit_chief_complaints">Chief Complaints</label>
                        <textarea class="form-control" id="edit_chief_complaints" name="chief_complaints" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="edit_diagnosis">Diagnosis</label>
                        <textarea class="form-control" id="edit_diagnosis" name="diagnosis" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="edit_tca">To Come Again (TCA) Date</label>
                        <input type="date" class="form-control" id="edit_tca" name="tca">
                    </div>
                    <div class="form-group">
                        <label for="edit_status">Status</label>
                        <select class="form-control" id="edit_status" name="status">
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Patient</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Patient Modal -->
<div class="modal fade" id="viewPatientModal" tabindex="-1" role="dialog" aria-labelledby="viewPatientModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewPatientModalLabel">Patient Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Basic Information</h5>
                        <table class="table table-bordered">
                            <tr>
                                <th>Patient Number</th>
                                <td id="view_patient_number"></td>
                            </tr>
                            <tr>
                                <th>Name</th>
                                <td id="view_name"></td>
                            </tr>
                            <tr>
                                <th>Age</th>
                                <td id="view_age"></td>
                            </tr>
                            <tr>
                                <th>Gender</th>
                                <td id="view_gender"></td>
                            </tr>
                            <tr>
                                <th>Type</th>
                                <td id="view_type"></td>
                            </tr>
                        </table>
                        
                        <h5>Contact Information</h5>
                        <table class="table table-bordered">
                            <tr>
                                <th>Address</th>
                                <td id="view_address"></td>
                            </tr>
                            <tr>
                                <th>Phone</th>
                                <td id="view_phone"></td>
                            </tr>
                            <tr>
                                <th>Next of Kin</th>
                                <td id="view_nok_name"></td>
                            </tr>
                            <tr>
                                <th>NOK Contact</th>
                                <td id="view_nok_contact"></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5>Medical Information</h5>
                        <table class="table table-bordered">
                            <tr>
                                <th>Chief Complaints</th>
                                <td id="view_complaints"></td>
                            </tr>
                            <tr>
                                <th>Diagnosis</th>
                                <td id="view_diagnosis"></td>
                            </tr>
                            <tr>
                                <th>Treatment</th>
                                <td id="view_treatment"></td>
                            </tr>
                            <tr>
                                <th>TCA Date</th>
                                <td id="view_tca"></td>
                            </tr>
                            <tr>
                                <th>Status</th>
                                <td id="view_status"></td>
                            </tr>
                        </table>
                        
                        <h5>Financial Summary</h5>
                        <table class="table table-bordered">
                            <tr>
                                <th>Total Lab Amount</th>
                                <td id="view_total_lab_amount"></td>
                            </tr>
                            <tr>
                                <th>Total Service Amount</th>
                                <td id="view_total_service_amount"></td>
                            </tr>
                            <tr>
                                <th>Total Drug Amount</th>
                                <td id="view_total_drug_amount"></td>
                            </tr>
                            <tr>
                                <th>Total Amount</th>
                                <td id="view_total_amount"></td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h5>Lab Tests</h5>
                        <div class="table-responsive">
                            <table class="table table-sm" id="view_lab_tests">
                                <thead>
                                    <tr>
                                        <th>Test</th>
                                        <th>Price</th>
                                        <th>Results</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <button class="btn btn-sm btn-primary mt-2" id="addLabTestBtn" data-patient-id="">
                            <i class="fas fa-plus"></i> Add Lab Test
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h5>Services</h5>
                        <div class="table-responsive">
                            <table class="table table-sm" id="view_services">
                                <thead>
                                    <tr>
                                        <th>Service</th>
                                        <th>Price</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <button class="btn btn-sm btn-primary mt-2" id="addServiceBtn" data-patient-id="">
                            <i class="fas fa-plus"></i> Add Service
                        </button>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-12">
                        <h5>Prescriptions</h5>
                        <div class="table-responsive">
                            <table class="table table-sm" id="view_prescriptions">
                                <thead>
                                    <tr>
                                        <th>Drug</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                        <th>Total</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Lab Test Modal -->
<div class="modal fade" id="addLabTestModal" tabindex="-1" role="dialog" aria-labelledby="addLabTestModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addLabTestModalLabel">Add Lab Test</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="addLabTestForm">
                <input type="hidden" id="lab_patient_id" name="patient_id">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="lab_test_id">Test</label>
                        <select class="form-control" id="lab_test_id" name="test_id" required>
                            {% for test in lab_tests %}
                                <option value="{{ test.id }}">{{ test.name }} - ${{ test.price }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="lab_results">Results</label>
                        <textarea class="form-control" id="lab_results" name="results" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="lab_comments">Comments</label>
                        <textarea class="form-control" id="lab_comments" name="comments" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Lab Test</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Service Modal -->
<div class="modal fade" id="addServiceModal" tabindex="-1" role="dialog" aria-labelledby="addServiceModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addServiceModalLabel">Add Service</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="addServiceForm">
                <input type="hidden" id="service_patient_id" name="patient_id">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="service_id">Service</label>
                        <select class="form-control" id="service_id" name="service_id" required>
                            {% for service in services %}
                                <option value="{{ service.id }}">{{ service.name }} - ${{ service.price }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="service_notes">Notes</label>
                        <textarea class="form-control" id="service_notes" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Service</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- DataTables and other JS libraries -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize DataTable
    $('#patientsTable').DataTable({
        responsive: true,
        dom: '<"top"lf>rt<"bottom"ip>',
        pageLength: 25,
        order: [[0, 'desc']]
    });
    
    // Date filter form submission
    $('#dateFilterForm').submit(function(e) {
        e.preventDefault();
        const startDate = $('#startDate').val();
        const endDate = $('#endDate').val();
        
        // Reload the page with date parameters
        window.location.href = `?start_date=${startDate}&end_date=${endDate}`;
    });
    
    // Reset filter button
    $('#resetFilter').click(function() {
        window.location.href = window.location.pathname;
    });
    
    // Calculate and display summary totals
    function calculateSummaryTotals() {
        let totalLab = 0;
        let totalService = 0;
        let totalDrug = 0;
        
        $('#patientsTable tbody tr').each(function() {
            const labAmount = parseFloat($(this).find('td:eq(5)').text().replace(/[^0-9.]/g, '')) || 0;
            const serviceAmount = parseFloat($(this).find('td:eq(7)').text().replace(/[^0-9.]/g, '')) || 0;
            const drugAmount = parseFloat($(this).find('td:eq(10)').text().replace(/[^0-9.]/g, '')) || 0;
            
            totalLab += labAmount;
            totalService += serviceAmount;
            totalDrug += drugAmount;
        });
        
        $('#totalLabAmount').text('Ksh.' + totalLab.toFixed(2));
        $('#totalServiceAmount').text('Ksh.' + totalService.toFixed(2));
        $('#totalDrugAmount').text('Ksh.' + totalDrug.toFixed(2));
        $('#totalAmount').text('Ksh.' + (totalLab + totalService + totalDrug).toFixed(2));
    }
    
    // Call the function on page load
    calculateSummaryTotals();
    
    // Edit patient modal handler
    $('.btn-edit').click(function() {
        const patientId = $(this).data('id');
        $.get(`/admin/patients/${patientId}`, function(patient) {
            $('#edit_patient_id').val(patient.id);
            $('#edit_patient_number').text(patient.op_number || patient.ip_number);
            $('#edit_name').val(patient.name);
            $('#edit_age').val(patient.age);
            $('#edit_gender').val(patient.gender);
            $('#edit_address').val(patient.address);
            $('#edit_phone').val(patient.phone);
            $('#edit_nok_name').val(patient.nok_name);
            $('#edit_nok_contact').val(patient.nok_contact);
            $('#edit_chief_complaints').val(patient.chief_complaints);
            $('#edit_diagnosis').val(patient.diagnosis);
            $('#edit_tca').val(patient.tca);
            $('#edit_status').val(patient.status);
            $('#editPatientModal').modal('show');
        });
    });
    
    // View patient modal handler
    $('.btn-view').click(function() {
        const patientId = $(this).data('id');
        $('#addLabTestBtn').data('patient-id', patientId);
        $('#addServiceBtn').data('patient-id', patientId);
        
        $.get(`/admin/patients/${patientId}/details`, function(data) {
            $('#view_patient_number').text(data.patient_number);
            $('#view_name').text(data.name);
            $('#view_age').text(data.age);
            $('#view_gender').text(data.gender);
            $('#view_type').text(data.type);
            $('#view_address').text(data.address || '-');
            $('#view_phone').text(data.phone || '-');
            $('#view_nok_name').text(data.nok_name || '-');
            $('#view_nok_contact').text(data.nok_contact || '-');
            $('#view_complaints').text(data.complaints || '-');
            $('#view_diagnosis').text(data.diagnosis || '-');
            $('#view_treatment').text(data.treatment || '-');
            $('#view_tca').text(data.tca || '-');
            $('#view_status').html(`<span class="status-badge ${data.status === 'active' ? 'active' : 'completed'}">${data.status}</span>`);
            
            // Financial summary
            $('#view_total_lab_amount').text('Ksh.' + data.total_lab_amount.toFixed(2));
            $('#view_total_service_amount').text('Ksh.' + data.total_service_amount.toFixed(2));
            $('#view_total_drug_amount').text('Ksh.' + data.total_drug_amount.toFixed(2));
            $('#view_total_amount').text('Ksh.' + data.total_amount.toFixed(2));
            
            // Populate lab tests
            const labTestsTable = $('#view_lab_tests tbody');
            labTestsTable.empty();
            data.lab_tests.forEach(test => {
                labTestsTable.append(`
                    <tr data-id="${test.id}">
                        <td>${test.name}</td>
                        <td>Ksh.${test.price.toFixed(2)}</td>
                        <td>${test.results || '-'}</td>
                        <td>${test.date}</td>
                        <td>
                            <button class="btn btn-sm btn-edit-lab" data-id="${test.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-delete-lab" data-id="${test.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });
            
            // Populate services
            const servicesTable = $('#view_services tbody');
            servicesTable.empty();
            data.services.forEach(service => {
                servicesTable.append(`
                    <tr data-id="${service.id}">
                        <td>${service.name}</td>
                        <td>Ksh.${service.price.toFixed(2)}</td>
                        <td>${service.date}</td>
                        <td>
                            <button class="btn btn-sm btn-edit-service" data-id="${service.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-delete-service" data-id="${service.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });
            
            // Populate prescriptions
            const prescriptionsTable = $('#view_prescriptions tbody');
            prescriptionsTable.empty();
            data.prescriptions.forEach(prescription => {
                prescriptionsTable.append(`
                    <tr>
                        <td>${prescription.drug_name}</td>
                        <td>${prescription.quantity}</td>
                        <td>Ksh.${prescription.unit_price.toFixed(2)}</td>
                        <td>Ksh.${(prescription.unit_price * prescription.quantity).toFixed(2)}</td>
                        <td>${prescription.date}</td>
                        <td><span class="status-badge ${prescription.status}">${prescription.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-edit-prescription" data-id="${prescription.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });
            
            $('#viewPatientModal').modal('show');
        });
    });
    
    // Add Lab Test button handler
    $('#addLabTestBtn').click(function() {
        const patientId = $(this).data('patient-id');
        $('#lab_patient_id').val(patientId);
        $('#addLabTestModal').modal('show');
    });
    
    // Add Service button handler
    $('#addServiceBtn').click(function() {
        const patientId = $(this).data('patient-id');
        $('#service_patient_id').val(patientId);
        $('#addServiceModal').modal('show');
    });
    
    // Add Lab Test form submission
    $('#addLabTestForm').submit(function(e) {
        e.preventDefault();
        const formData = $(this).serialize();
        
        $.post('/admin/patient/lab/add', formData, function(response) {
            if (response.success) {
                $('#addLabTestModal').modal('hide');
                $('#addLabTestForm')[0].reset();
                // Refresh the view
                $('.btn-view[data-id="' + $('#lab_patient_id').val() + '"]').click();
            } else {
                alert(response.message || 'Error adding lab test');
            }
        }).fail(function() {
            alert('Error adding lab test');
        });
    });
    
    // Add Service form submission
    $('#addServiceForm').submit(function(e) {
        e.preventDefault();
        const formData = $(this).serialize();
        
        $.post('/admin/patient/service/add', formData, function(response) {
            if (response.success) {
                $('#addServiceModal').modal('hide');
                $('#addServiceForm')[0].reset();
                // Refresh the view
                $('.btn-view[data-id="' + $('#service_patient_id').val() + '"]').click();
            } else {
                alert(response.message || 'Error adding service');
            }
        }).fail(function() {
            alert('Error adding service');
        });
    });
    
    // Edit Lab Test button handler (delegate to dynamic elements)
    $(document).on('click', '.btn-edit-lab', function() {
        const labId = $(this).data('id');
        // Implement edit functionality here
        alert('Edit lab test with ID: ' + labId);
    });
    
    // Delete Lab Test button handler (delegate to dynamic elements)
    $(document).on('click', '.btn-delete-lab', function() {
        const labId = $(this).data('id');
        if (confirm('Are you sure you want to delete this lab test?')) {
            $.post('/admin/patient/lab/delete', { lab_id: labId }, function(response) {
                if (response.success) {
                    // Refresh the view
                    $('.btn-view[data-id="' + $('#lab_patient_id').val() + '"]').click();
                } else {
                    alert(response.message || 'Error deleting lab test');
                }
            }).fail(function() {
                alert('Error deleting lab test');
            });
        }
    });
    
    // Edit Service button handler (delegate to dynamic elements)
    $(document).on('click', '.btn-edit-service', function() {
        const serviceId = $(this).data('id');
        // Implement edit functionality here
        alert('Edit service with ID: ' + serviceId);
    });
    
    // Delete Service button handler (delegate to dynamic elements)
    $(document).on('click', '.btn-delete-service', function() {
        const serviceId = $(this).data('id');
        if (confirm('Are you sure you want to delete this service?')) {
            $.post('/admin/patient/service/delete', { service_id: serviceId }, function(response) {
                if (response.success) {
                    // Refresh the view
                    $('.btn-view[data-id="' + $('#service_patient_id').val() + '"]').click();
                } else {
                    alert(response.message || 'Error deleting service');
                }
            }).fail(function() {
                alert('Error deleting service');
            });
        }
    });
    
    // Form validation
    $('#addPatientForm, #editPatientForm').submit(function(e) {
        const name = $('#name').val() || $('#edit_name').val();
        if (!name) {
            alert('Patient name is required');
            e.preventDefault();
            return false;
        }
        return true;
    });
});
</script>
{% endblock %}