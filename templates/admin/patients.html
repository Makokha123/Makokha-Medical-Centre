{% extends "base.html" %}

{% block content %}
<!-- Add this to the head section of all your base templates -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    .summary-box {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 15px;
        background-color: #f8f9fa;
        transition: transform 0.2s;
    }
    
    .summary-box:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .data-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-bottom: 1rem;
    }

    .data-table th {
        background-color: #f8f9fa;
        padding: 12px;
        font-weight: 600;
        text-align: left;
        border-bottom: 2px solid #dee2e6;
    }

    .data-table td {
        padding: 12px;
        border-bottom: 1px solid #dee2e6;
        vertical-align: middle;
    }

    .data-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .btn-view-details {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .btn-view-details:hover {
        background-color: #0056b3;
    }

    .modal-content {
        border-radius: 8px;
    }

    .modal-header {
        background-color: #f8f9fa;
        border-radius: 8px 8px 0 0;
    }

    .modal-body h6 {
        color: #495057;
        margin-bottom: 1rem;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 0.5rem;
    }

    .detail-section {
        margin-bottom: 1.5rem;
    }

    .detail-label {
        font-weight: 600;
        color: #495057;
    }

    .detail-value {
        color: #212529;
    }
</style>
            
            <!-- Date Filter Form -->
            <div class="card mb-4">
                <div class="card-body">
                    <form id="dateFilterForm" class="form-inline">
                        <div class="form-group mr-3">
                            <label for="startDate" class="mr-2">From:</label>
                            <input type="date" class="form-control" id="startDate" name="start_date">
                        </div>
                        <div class="form-group mr-3">
                            <label for="endDate" class="mr-2">To:</label>
                            <input type="date" class="form-control" id="endDate" name="end_date">
                        </div>
                        <button type="submit" class="btn btn-primary mr-2">Filter</button>
                        <button type="button" id="resetFilter" class="btn btn-secondary">Reset</button>
                    </form>
                </div>
            </div>
            
            <!-- Summary Box -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Financial Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="summary-box bg-light p-3">
                                <h6>Total Lab Amount</h6>
                                <p id="totalLabAmount">Ksh.0.00</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-box bg-light p-3">
                                <h6>Total Service Amount</h6>
                                <p id="totalServiceAmount">Ksh.0.00</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-box bg-light p-3">
                                <h6>Total Drug Amount</h6>
                                <p id="totalDrugAmount">Ksh.0.00</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-box bg-light p-3">
                                <h6>Total Amount</h6>
                                <p id="totalAmount">Ksh.0.00</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="data-table" id="patientsTable">
                    <thead>
                        <tr>
                            <th>Patient No.</th>
                            <th>Name</th>
                            <th>Chief Complain</th>
                            <th>Diagnosis</th>
                            <th>Lab Done</th>
                            <th>Lab Amount</th>
                            <th>Services Done</th>
                            <th>Services Amount</th>
                            <th>Drug Name</th>
                            <th>Quantity</th>
                            <th>Drug Amount</th>
                            <th>Total Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for patient in patients %}
                        <tr>
                            <td>{{ patient.op_number or patient.ip_number }}</td>
                            <td>{{ patient.name|decrypt }}</td>
                            <td>{{ patient.chief_complaint|default('-', true)|truncate(30) }}</td>
                            <td>{{ patient.patient_Diagnosis[0].diagnosis if patient.patient_Diagnosis else '-' }}</td>
                            <td>
                                {% if patient.labs %}
                                    {% for lab in patient.labs %}
                                        {{ lab.test.name }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% set lab_total = namespace(amount=0) %}
                                {% if patient.labs %}
                                    {% for lab in patient.labs %}
                                        {% set lab_total.amount = lab_total.amount + lab.test.price %}
                                    {% endfor %}
                                    Ksh.{{ "%.2f"|format(lab_total.amount) }}
                                {% else %}
                                    Ksh.0.00
                                {% endif %}
                            </td>
                            <td>
                                {% if patient.services %}
                                    {% for service in patient.services %}
                                        {{ service.service.name }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% set service_total = namespace(amount=0) %}
                                {% if patient.services %}
                                    {% for service in patient.services %}
                                        {% set service_total.amount = service_total.amount + service.service.price %}
                                    {% endfor %}
                                    Ksh.{{ "%.2f"|format(service_total.amount) }}
                                {% else %}
                                    Ksh.0.00
                                {% endif %}
                            </td>
                            <td>
                                {% if patient.prescriptions %}
                                    {% for prescription in patient.prescriptions %}
                                        {% for item in prescription.item %}
                                            {{ item.drug.name }}{% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if patient.prescriptions %}
                                    {% for prescription in patient.prescriptions %}
                                        {% for item in prescription.item %}
                                            {{ item.quantity }}{% if not loop.last %} + {% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if patient.prescriptions %}
                                    ${% for prescription in patient.prescriptions %}
                                        {% for item in prescription.item %}
                                            {{ item.drug.selling_price * item.quantity }}{% if not loop.last %} + {% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                {% else %}
                                    Ksh.0.00
                                {% endif %}
                            </td>
                            <td>
                                {% set total_amount = 0 %}
                                {% if patient.labs %}
                                    {% for lab in patient.labs %}
                                        {% set total_amount = total_amount + lab.test.price %}
                                    {% endfor %}
                                {% endif %}
                                {% if patient.services %}
                                    {% for service in patient.services %}
                                        {% set total_amount = total_amount + service.service.price %}
                                    {% endfor %}
                                {% endif %}
                                {% if patient.prescriptions %}
                                    {% for prescription in patient.prescriptions %}
                                        {% for item in prescription.items %}
                                            {% set total_amount = total_amount + (item.drug.selling_price * item.quantity) %}
                                        {% endfor %}
                                    {% endfor %}
                                {% endif %}
                                Ksh.{{ "%.2f"|format(total_amount) }}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-primary view-details" data-id="{{ patient.id }}" data-toggle="modal" data-target="#viewPatientModal">
                                    <i class="fas fa-eye"></i> View Details
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- View Patient Modal -->
<div class="modal fade" id="viewPatientModal" tabindex="-1" role="dialog" aria-labelledby="viewPatientModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewPatientModalLabel">Patient Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-6 detail-section">
                            <h6>Patient Information</h6>
                            <p><span class="detail-label">Patient No:</span> <span class="detail-value" id="modal-patient-no"></span></p>
                            <p><span class="detail-label">Name:</span> <span class="detail-value" id="modal-patient-name"></span></p>
                            <p><span class="detail-label">Chief Complaint:</span> <span class="detail-value" id="modal-chief-complaint"></span></p>
                            <p><span class="detail-label">Diagnosis:</span> <span class="detail-value" id="modal-diagnosis"></span></p>
                        </div>
                        <div class="col-md-6 detail-section">
                            <h6>Laboratory Tests</h6>
                            <div id="modal-lab-tests" class="detail-value"></div>
                            <p><span class="detail-label">Total Lab Amount:</span> <span class="detail-value" id="modal-lab-amount"></span></p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 detail-section">
                            <h6>Services Provided</h6>
                            <div id="modal-services" class="detail-value"></div>
                            <p><span class="detail-label">Total Services Amount:</span> <span class="detail-value" id="modal-services-amount"></span></p>
                        </div>
                        <div class="col-md-6 detail-section">
                            <h6>Prescribed Medications</h6>
                            <div id="modal-prescriptions" class="detail-value"></div>
                            <p><span class="detail-label">Total Drug Amount:</span> <span class="detail-value" id="modal-drug-amount"></span></p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 detail-section">
                            <h6>Total Bill</h6>
                            <p><span class="detail-label">Total Amount:</span> <span class="detail-value" id="modal-total-amount"></span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Function to format currency
    function formatCurrency(amount) {
        return 'Ksh.' + parseFloat(amount).toFixed(2);
    }

    // Handle view details button click
    document.querySelectorAll('.view-details').forEach(button => {
        button.addEventListener('click', function() {
            const row = this.closest('tr');
            
            // Fill in patient information
            document.getElementById('modal-patient-no').textContent = row.cells[0].textContent;
            document.getElementById('modal-patient-name').textContent = row.cells[1].textContent;
            document.getElementById('modal-chief-complaint').textContent = row.cells[2].textContent;
            document.getElementById('modal-diagnosis').textContent = row.cells[3].textContent;
            
            // Fill in lab tests with formatting
            const labTests = row.cells[4].textContent.trim();
            const labAmount = row.cells[5].textContent.trim();
            document.getElementById('modal-lab-tests').innerHTML = `<p>${labTests === '-' ? 'No lab tests' : labTests}</p>`;
            document.getElementById('modal-lab-amount').textContent = labAmount;
            
            // Fill in services with formatting
            const services = row.cells[6].textContent.trim();
            const servicesAmount = row.cells[7].textContent.trim();
            document.getElementById('modal-services').innerHTML = `<p>${services === '-' ? 'No services' : services}</p>`;
            document.getElementById('modal-services-amount').textContent = servicesAmount;
            
            // Fill in prescriptions with formatting
            const medications = row.cells[8].textContent.trim();
            const quantities = row.cells[9].textContent.trim();
            const drugAmount = row.cells[10].textContent.trim();
            document.getElementById('modal-prescriptions').innerHTML = `
                <p>${medications === '-' ? 'No prescriptions' : 'Medications: ' + medications}</p>
                ${quantities !== '-' ? '<p>Quantities: ' + quantities + '</p>' : ''}
            `;
            document.getElementById('modal-drug-amount').textContent = drugAmount;
            
            // Fill in total amount
            document.getElementById('modal-total-amount').textContent = row.cells[11].textContent.trim();
        });
    });

    // Handle date filter form
    const dateFilterForm = document.getElementById('dateFilterForm');
    if (dateFilterForm) {
        dateFilterForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            window.location.href = `/admin/patients?start_date=${startDate}&end_date=${endDate}`;
        });

        // Handle reset button
        document.getElementById('resetFilter').addEventListener('click', function() {
            window.location.href = '/admin/patients';
        });
    }

    // Initialize DataTable with better formatting
    if ($.fn.DataTable) {
        $('.data-table').DataTable({
            responsive: true,
            order: [[0, 'desc']],
            pageLength: 25,
            language: {
                search: "Search patients:",
                lengthMenu: "Show _MENU_ patients per page",
                info: "Showing _START_ to _END_ of _TOTAL_ patients"
            }
        });
    }
});
</script>
{% endblock %}
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Patient Information</h6>
                            <p><strong>Patient No:</strong> <span id="modal-patient-no"></span></p>
                            <p><strong>Name:</strong> <span id="modal-patient-name"></span></p>
                            <p><strong>Chief Complaint:</strong> <span id="modal-chief-complaint"></span></p>
                            <p><strong>Diagnosis:</strong> <span id="modal-diagnosis"></span></p>
                        </div>
                        <div class="col-md-6">
                            <h6>Laboratory Tests</h6>
                            <div id="modal-lab-tests"></div>
                            <p><strong>Total Lab Amount:</strong> <span id="modal-lab-amount"></span></p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6>Services Provided</h6>
                            <div id="modal-services"></div>
                            <p><strong>Total Services Amount:</strong> <span id="modal-services-amount"></span></p>
                        </div>
                        <div class="col-md-6">
                            <h6>Prescribed Medications</h6>
                            <div id="modal-prescriptions"></div>
                            <p><strong>Total Drug Amount:</strong> <span id="modal-drug-amount"></span></p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Total Bill</h6>
                            <p><strong>Total Amount:</strong> <span id="modal-total-amount"></span></p>
                        </div>
                    </div>
                </div>
                    <div class="col-md-6">
                        <h5>Basic Information</h5>
                        <table class="table table-bordered">
                            <tr>
                                <th>Patient Number</th>
                                <td id="view_patient_number"></td>
                            </tr>
                            <tr>
                                <th>Name</th>
                                <td id="view_name"></td>
                            </tr>
                            <tr>
                                <th>Age</th>
                                <td id="view_age"></td>
                            </tr>
                            <tr>
                                <th>Gender</th>
                                <td id="view_gender"></td>
                            </tr>
                            <tr>
                                <th>Type</th>
                                <td id="view_type"></td>
                            </tr>
                        </table>
                        
                        <h5>Contact Information</h5>
                        <table class="table table-bordered">
                            <tr>
                                <th>Address</th>
                                <td id="view_address"></td>
                            </tr>
                            <tr>
                                <th>Phone</th>
                                <td id="view_phone"></td>
                            </tr>
                            <tr>
                                <th>Next of Kin</th>
                                <td id="view_nok_name"></td>
                            </tr>
                            <tr>
                                <th>NOK Contact</th>
                                <td id="view_nok_contact"></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5>Medical Information</h5>
                        <table class="table table-bordered">
                            <tr>
                                <th>Chief Complaints</th>
                                <td id="view_complaints"></td>
                            </tr>
                            <tr>
                                <th>Diagnosis</th>
                                <td id="view_diagnosis"></td>
                            </tr>
                            <tr>
                                <th>Treatment</th>
                                <td id="view_treatment"></td>
                            </tr>
                            <tr>
                                <th>TCA Date</th>
                                <td id="view_tca"></td>
                            </tr>
                            <tr>
                                <th>Status</th>
                                <td id="view_status"></td>
                            </tr>
                        </table>
                        
                        <h5>Financial Summary</h5>
                        <table class="table table-bordered">
                            <tr>
                                <th>Total Lab Amount</th>
                                <td id="view_total_lab_amount"></td>
                            </tr>
                            <tr>
                                <th>Total Service Amount</th>
                                <td id="view_total_service_amount"></td>
                            </tr>
                            <tr>
                                <th>Total Drug Amount</th>
                                <td id="view_total_drug_amount"></td>
                            </tr>
                            <tr>
                                <th>Total Amount</th>
                                <td id="view_total_amount"></td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h5>Lab Tests</h5>
                        <div class="table-responsive">
                            <table class="table table-sm" id="view_lab_tests">
                                <thead>
                                    <tr>
                                        <th>Test</th>
                                        <th>Price</th>
                                        <th>Results</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <button class="btn btn-sm btn-primary mt-2" id="addLabTestBtn" data-patient-id="">
                            <i class="fas fa-plus"></i> Add Lab Test
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h5>Services</h5>
                        <div class="table-responsive">
                            <table class="table table-sm" id="view_services">
                                <thead>
                                    <tr>
                                        <th>Service</th>
                                        <th>Price</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <button class="btn btn-sm btn-primary mt-2" id="addServiceBtn" data-patient-id="">
                            <i class="fas fa-plus"></i> Add Service
                        </button>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-12">
                        <h5>Prescriptions</h5>
                        <div class="table-responsive">
                            <table class="table table-sm" id="view_prescriptions">
                                <thead>
                                    <tr>
                                        <th>Drug</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                        <th>Total</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Lab Test Modal -->
<div class="modal fade" id="addLabTestModal" tabindex="-1" role="dialog" aria-labelledby="addLabTestModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addLabTestModalLabel">Add Lab Test</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="addLabTestForm">
                <input type="hidden" id="lab_patient_id" name="patient_id">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="lab_test_id">Test</label>
                        <select class="form-control" id="lab_test_id" name="test_id" required>
                            {% for test in lab_tests %}
                                <option value="{{ test.id }}">{{ test.name }} - ${{ test.price }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="lab_results">Results</label>
                        <textarea class="form-control" id="lab_results" name="results" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="lab_comments">Comments</label>
                        <textarea class="form-control" id="lab_comments" name="comments" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Lab Test</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Service Modal -->
<div class="modal fade" id="addServiceModal" tabindex="-1" role="dialog" aria-labelledby="addServiceModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addServiceModalLabel">Add Service</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="addServiceForm">
                <input type="hidden" id="service_patient_id" name="patient_id">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="service_id">Service</label>
                        <select class="form-control" id="service_id" name="service_id" required>
                            {% for service in services %}
                                <option value="{{ service.id }}">{{ service.name }} - ${{ service.price }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="service_notes">Notes</label>
                        <textarea class="form-control" id="service_notes" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Service</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- DataTables and other JS libraries -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize DataTable
    $('#patientsTable').DataTable({
        responsive: true,
        dom: '<"top"lf>rt<"bottom"ip>',
        pageLength: 25,
        order: [[0, 'desc']]
    });
    
    // Date filter form submission
    $('#dateFilterForm').submit(function(e) {
        e.preventDefault();
        const startDate = $('#startDate').val();
        const endDate = $('#endDate').val();
        
        // Reload the page with date parameters
        window.location.href = `?start_date=${startDate}&end_date=${endDate}`;
    });
    
    // Reset filter button
    $('#resetFilter').click(function() {
        window.location.href = window.location.pathname;
    });
    
    // Calculate and display summary totals
    function calculateSummaryTotals() {
        let totalLab = 0;
        let totalService = 0;
        let totalDrug = 0;
        
        $('#patientsTable tbody tr').each(function() {
            const labAmount = parseFloat($(this).find('td:eq(5)').text().replace(/[^0-9.]/g, '')) || 0;
            const serviceAmount = parseFloat($(this).find('td:eq(7)').text().replace(/[^0-9.]/g, '')) || 0;
            const drugAmount = parseFloat($(this).find('td:eq(10)').text().replace(/[^0-9.]/g, '')) || 0;
            
            totalLab += labAmount;
            totalService += serviceAmount;
            totalDrug += drugAmount;
        });
        
        $('#totalLabAmount').text('Ksh.' + totalLab.toFixed(2));
        $('#totalServiceAmount').text('Ksh.' + totalService.toFixed(2));
        $('#totalDrugAmount').text('Ksh.' + totalDrug.toFixed(2));
        $('#totalAmount').text('Ksh.' + (totalLab + totalService + totalDrug).toFixed(2));
    }
    
    // Call the function on page load
    calculateSummaryTotals();
    
    // Edit patient modal handler
    $('.btn-edit').click(function() {
        const patientId = $(this).data('id');
        $.get(`/admin/patients/${patientId}`, function(patient) {
            $('#edit_patient_id').val(patient.id);
            $('#edit_patient_number').text(patient.op_number || patient.ip_number);
            $('#edit_name').val(patient.name);
            $('#edit_age').val(patient.age);
            $('#edit_gender').val(patient.gender);
            $('#edit_address').val(patient.address);
            $('#edit_phone').val(patient.phone);
            $('#edit_nok_name').val(patient.nok_name);
            $('#edit_nok_contact').val(patient.nok_contact);
            $('#edit_chief_complaints').val(patient.chief_complaints);
            $('#edit_diagnosis').val(patient.diagnosis);
            $('#edit_tca').val(patient.tca);
            $('#edit_status').val(patient.status);
            $('#editPatientModal').modal('show');
        });
    });
    
    // View patient modal handler
    $('.btn-view').click(function() {
        const patientId = $(this).data('id');
        $('#addLabTestBtn').data('patient-id', patientId);
        $('#addServiceBtn').data('patient-id', patientId);
        
        $.get(`/admin/patients/${patientId}/details`, function(data) {
            $('#view_patient_number').text(data.patient_number);
            $('#view_name').text(data.name);
            $('#view_age').text(data.age);
            $('#view_gender').text(data.gender);
            $('#view_type').text(data.type);
            $('#view_address').text(data.address || '-');
            $('#view_phone').text(data.phone || '-');
            $('#view_nok_name').text(data.nok_name || '-');
            $('#view_nok_contact').text(data.nok_contact || '-');
            $('#view_complaints').text(data.complaints || '-');
            $('#view_diagnosis').text(data.diagnosis || '-');
            $('#view_treatment').text(data.treatment || '-');
            $('#view_tca').text(data.tca || '-');
            $('#view_status').html(`<span class="status-badge ${data.status === 'active' ? 'active' : 'completed'}">${data.status}</span>`);
            
            // Financial summary
            $('#view_total_lab_amount').text('Ksh.' + data.total_lab_amount.toFixed(2));
            $('#view_total_service_amount').text('Ksh.' + data.total_service_amount.toFixed(2));
            $('#view_total_drug_amount').text('Ksh.' + data.total_drug_amount.toFixed(2));
            $('#view_total_amount').text('Ksh.' + data.total_amount.toFixed(2));
            
            // Populate lab tests
            const labTestsTable = $('#view_lab_tests tbody');
            labTestsTable.empty();
            data.lab_tests.forEach(test => {
                labTestsTable.append(`
                    <tr data-id="${test.id}">
                        <td>${test.name}</td>
                        <td>Ksh.${test.price.toFixed(2)}</td>
                        <td>${test.results || '-'}</td>
                        <td>${test.date}</td>
                        <td>
                            <button class="btn btn-sm btn-edit-lab" data-id="${test.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-delete-lab" data-id="${test.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });
            
            // Populate services
            const servicesTable = $('#view_services tbody');
            servicesTable.empty();
            data.services.forEach(service => {
                servicesTable.append(`
                    <tr data-id="${service.id}">
                        <td>${service.name}</td>
                        <td>Ksh.${service.price.toFixed(2)}</td>
                        <td>${service.date}</td>
                        <td>
                            <button class="btn btn-sm btn-edit-service" data-id="${service.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-delete-service" data-id="${service.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });
            
            // Populate prescriptions
            const prescriptionsTable = $('#view_prescriptions tbody');
            prescriptionsTable.empty();
            data.prescriptions.forEach(prescription => {
                prescriptionsTable.append(`
                    <tr>
                        <td>${prescription.drug_name}</td>
                        <td>${prescription.quantity}</td>
                        <td>Ksh.${prescription.unit_price.toFixed(2)}</td>
                        <td>Ksh.${(prescription.unit_price * prescription.quantity).toFixed(2)}</td>
                        <td>${prescription.date}</td>
                        <td><span class="status-badge ${prescription.status}">${prescription.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-edit-prescription" data-id="${prescription.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });
            
            $('#viewPatientModal').modal('show');
        });
    });
    
    // Add Lab Test button handler
    $('#addLabTestBtn').click(function() {
        const patientId = $(this).data('patient-id');
        $('#lab_patient_id').val(patientId);
        $('#addLabTestModal').modal('show');
    });
    
    // Add Service button handler
    $('#addServiceBtn').click(function() {
        const patientId = $(this).data('patient-id');
        $('#service_patient_id').val(patientId);
        $('#addServiceModal').modal('show');
    });
    
    // Add Lab Test form submission
    $('#addLabTestForm').submit(function(e) {
        e.preventDefault();
        const formData = $(this).serialize();
        
        $.post('/admin/patient/lab/add', formData, function(response) {
            if (response.success) {
                $('#addLabTestModal').modal('hide');
                $('#addLabTestForm')[0].reset();
                // Refresh the view
                $('.btn-view[data-id="' + $('#lab_patient_id').val() + '"]').click();
            } else {
                alert(response.message || 'Error adding lab test');
            }
        }).fail(function() {
            alert('Error adding lab test');
        });
    });
    
    // Add Service form submission
    $('#addServiceForm').submit(function(e) {
        e.preventDefault();
        const formData = $(this).serialize();
        
        $.post('/admin/patient/service/add', formData, function(response) {
            if (response.success) {
                $('#addServiceModal').modal('hide');
                $('#addServiceForm')[0].reset();
                // Refresh the view
                $('.btn-view[data-id="' + $('#service_patient_id').val() + '"]').click();
            } else {
                alert(response.message || 'Error adding service');
            }
        }).fail(function() {
            alert('Error adding service');
        });
    });
    
    // Edit Lab Test button handler (delegate to dynamic elements)
    $(document).on('click', '.btn-edit-lab', function() {
        const labId = $(this).data('id');
        // Implement edit functionality here
        alert('Edit lab test with ID: ' + labId);
    });
    
    // Delete Lab Test button handler (delegate to dynamic elements)
    $(document).on('click', '.btn-delete-lab', function() {
        const labId = $(this).data('id');
        if (confirm('Are you sure you want to delete this lab test?')) {
            $.post('/admin/patient/lab/delete', { lab_id: labId }, function(response) {
                if (response.success) {
                    // Refresh the view
                    $('.btn-view[data-id="' + $('#lab_patient_id').val() + '"]').click();
                } else {
                    alert(response.message || 'Error deleting lab test');
                }
            }).fail(function() {
                alert('Error deleting lab test');
            });
        }
    });
    
    // Edit Service button handler (delegate to dynamic elements)
    $(document).on('click', '.btn-edit-service', function() {
        const serviceId = $(this).data('id');
        // Implement edit functionality here
        alert('Edit service with ID: ' + serviceId);
    });
    
    // Delete Service button handler (delegate to dynamic elements)
    $(document).on('click', '.btn-delete-service', function() {
        const serviceId = $(this).data('id');
        if (confirm('Are you sure you want to delete this service?')) {
            $.post('/admin/patient/service/delete', { service_id: serviceId }, function(response) {
                if (response.success) {
                    // Refresh the view
                    $('.btn-view[data-id="' + $('#service_patient_id').val() + '"]').click();
                } else {
                    alert(response.message || 'Error deleting service');
                }
            }).fail(function() {
                alert('Error deleting service');
            });
        }
    });
    
    // Form validation
    $('#addPatientForm, #editPatientForm').submit(function(e) {
        const name = $('#name').val() || $('#edit_name').val();
        if (!name) {
            alert('Patient name is required');
            e.preventDefault();
            return false;
        }
        return true;
    });
});
</script>
{% endblock %}