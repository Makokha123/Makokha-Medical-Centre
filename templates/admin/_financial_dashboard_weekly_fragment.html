<!-- Weekly Financial Dashboard Fragment (for AJAX loading) -->

<style>
    .financial-dashboard-container {
        font-size: 9px;
    }
    
    .financial-dashboard-container * {
        font-size: 9px !important;
    }
</style>

<div class="financial-dashboard-container">

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-left-primary h-100">
            <div class="card-body">
                <div class="text-primary font-weight-bold text-uppercase mb-1">Weekly Revenue</div>
                <div class="h3 mb-0">KES {{ "{:,.0f}".format(metrics.total_revenue) }}</div>
                <small class="text-muted">
                    {% if metrics.start_date %}
                        {{ metrics.start_date.strftime('%b %d') }} - {{ metrics.end_date.strftime('%b %d, %Y') }}
                    {% endif %}
                </small>
                <div class="mt-2">
                    {% if metrics.revenue_change_pct >= 0 %}
                        <i class="fas fa-arrow-up text-success"></i> {{ "{:.1f}%".format(metrics.revenue_change_pct) }} vs last week
                    {% else %}
                        <i class="fas fa-arrow-down text-danger"></i> {{ "{:.1f}%".format(metrics.revenue_change_pct) }} vs last week
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card border-left-success h-100">
            <div class="card-body">
                <div class="text-success font-weight-bold text-uppercase mb-1">Weekly Expenses</div>
                <div class="h3 mb-0">KES {{ "{:,.0f}".format(metrics.total_expense) }}</div>
                <small class="text-muted">Operating Costs</small>
                <div class="mt-2">
                    {% if metrics.expense_change_pct >= 0 %}
                        <i class="fas fa-arrow-up text-danger"></i> {{ "{:.1f}%".format(metrics.expense_change_pct) }} vs last week
                    {% else %}
                        <i class="fas fa-arrow-down text-success"></i> {{ "{:.1f}%".format(abs(metrics.expense_change_pct)) }} vs last week
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card border-left-info h-100">
            <div class="card-body">
                <div class="text-info font-weight-bold text-uppercase mb-1">Weekly Net Profit</div>
                <div class="h3 mb-0">KES {{ "{:,.0f}".format(metrics.net_profit) }}</div>
                <small class="text-muted">Revenue - Expenses</small>
                <div class="mt-2">
                    {% if metrics.profit_change_pct >= 0 %}
                        <i class="fas fa-arrow-up text-success"></i> {{ "{:.1f}%".format(metrics.profit_change_pct) }} vs last week
                    {% else %}
                        <i class="fas fa-arrow-down text-danger"></i> {{ "{:.1f}%".format(abs(metrics.profit_change_pct)) }} vs last week
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card border-left-warning h-100">
            <div class="card-body">
                <div class="text-warning font-weight-bold text-uppercase mb-1">Avg Daily Profit</div>
                <div class="h3 mb-0">KES {{ "{:,.0f}".format(metrics.net_profit / 7) }}</div>
                <small class="text-muted">Weekly Average</small>
                <div class="mt-2">
                    <span class="badge badge-info">7 Days</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Multi-Week Range Report -->
{% if is_range and weekly_data %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">Weekly Report: {{ date_range_label }} ({{ num_weeks }} weeks)</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover table-striped">
                        <thead class="thead-light">
                            <tr>
                                <th>Week</th>
                                <th class="text-right">Revenue</th>
                                <th class="text-right">Expenses</th>
                                <th class="text-right">Profit</th>
                                <th class="text-right">Margin %</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for week in weekly_data %}
                            <tr>
                                <td><strong>Week of {{ week.start_date.strftime('%b %d') }} - {{ week.end_date.strftime('%b %d, %Y') }}</strong></td>
                                <td class="text-right">KES {{ "{:,.0f}".format(week.revenue) }}</td>
                                <td class="text-right">KES {{ "{:,.0f}".format(week.expense) }}</td>
                                <td class="text-right font-weight-bold {% if week.profit >= 0 %}text-success{% else %}text-danger{% endif %}">KES {{ "{:,.0f}".format(week.profit) }}</td>
                                <td class="text-right">{{ "{:.1f}%".format(week.margin) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Professional Financial Analysis Charts -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-success text-white py-3">
                <h6 class="mb-0 font-weight-bold">ðŸ“Š Weekly Performance Analysis</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="chart-container" style="position: relative; height: 250px;">
                            <canvas id="weekly-revenue-vs-expense-chart"></canvas>
                        </div>
                        <p class="text-center text-muted mt-2" style="font-size: 8px;"><strong>Weekly Revenue vs Expenses</strong></p>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container" style="position: relative; height: 250px;">
                            <canvas id="weekly-profit-trend-chart"></canvas>
                        </div>
                        <p class="text-center text-muted mt-2" style="font-size: 8px;"><strong>Profit Margin Trend</strong></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">Daily Breakdown</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="thead-light">
                            <tr>
                                <th>Date</th>
                                <th class="text-right">Revenue</th>
                                <th class="text-right">Expenses</th>
                                <th class="text-right">Net Profit</th>
                                <th class="text-right">Margin %</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if daily_breakdown %}
                                {% for day in daily_breakdown %}
                                    <tr>
                                        <td><strong>{{ day.date.strftime('%a, %b %d') }}</strong></td>
                                        <td class="text-right">KES {{ "{:,.0f}".format(day.revenue) }}</td>
                                        <td class="text-right">KES {{ "{:,.0f}".format(day.expense) }}</td>
                                        <td class="text-right font-weight-bold {% if day.profit >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            KES {{ "{:,.0f}".format(day.profit) }}
                                        </td>
                                        <td class="text-right">{{ "{:.1f}%".format(day.margin if day.margin else 0) }}</td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted">No data available</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">Revenue Distribution</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Source</th>
                                <th class="text-right">Amount</th>
                                <th class="text-right">Share</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set sources = [
                                ('Pharmacy', metrics.revenue_breakdown.pharmacy),
                                ('Lab Tests', metrics.revenue_breakdown.lab),
                                ('Imaging', metrics.revenue_breakdown.imaging),
                                ('Consultation', metrics.revenue_breakdown.consultation),
                                ('Insurance', metrics.revenue_breakdown.insurance),
                                ('Other', metrics.revenue_breakdown.other)
                            ] %}
                            {% for name, amount in sources %}
                                {% if amount > 0 %}
                                    <tr>
                                        <td>{{ name }}</td>
                                        <td class="text-right font-weight-bold">KES {{ "{:,.0f}".format(amount) }}</td>
                                        <td class="text-right">
                                            {% set revenue_pct = (amount / metrics.total_revenue * 100) if metrics.total_revenue > 0 else 0 %}
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-success" role="progressbar" 
                                                    data-width="{{ revenue_pct }}"
                                                    style="width: 50%;">
                                                    {{ "{:.0f}%".format(revenue_pct) }}
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0">Expense Breakdown</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th class="text-right">Amount</th>
                                <th class="text-right">Share</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set categories = [
                                ('Payroll', metrics.expense_breakdown.payroll),
                                ('Pharmacy', metrics.expense_breakdown.pharmacy),
                                ('Equipment', metrics.expense_breakdown.equipment),
                                ('Utilities', metrics.expense_breakdown.utilities),
                                ('Debt Service', metrics.expense_breakdown.debt),
                                ('Other', metrics.expense_breakdown.other)
                            ] %}
                            {% for name, amount in categories %}
                                {% if amount > 0 %}
                                    <tr>
                                        <td>{{ name }}</td>
                                        <td class="text-right font-weight-bold">KES {{ "{:,.0f}".format(amount) }}</td>
                                        <td class="text-right">
                                            {% set expense_pct = (amount / metrics.total_expense * 100) if metrics.total_expense > 0 else 0 %}
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-danger" role="progressbar" 
                                                    data-width="{{ expense_pct }}"
                                                    style="width: 50%;">
                                                    {{ "{:.0f}%".format(expense_pct) }}
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Set progress bar widths from data attributes
    document.querySelectorAll('[data-width]').forEach(el => {
        const width = el.getAttribute('data-width');
        el.style.width = width + '%';
    });
    
    // Initialize weekly charts
    initializeWeeklyCharts();
    
    function initializeWeeklyCharts() {
        const revenueCtx = document.getElementById('weekly-revenue-vs-expense-chart');
        const profitCtx = document.getElementById('weekly-profit-trend-chart');
        
        if (!revenueCtx || !profitCtx) {
            console.log('Weekly chart containers not found');
            return;
        }
        
        const metricsData = {
            revenue: parseFloat('{{ metrics.total_revenue|default(0) }}') || 0,
            expenses: parseFloat('{{ metrics.total_expense|default(0) }}') || 0,
            profit: parseFloat('{{ metrics.total_profit|default(0) }}') || 0,
            margin: parseFloat('{{ metrics.profit_margin|default(0) }}') || 0,
            isRange: {{ 'true' if is_range else 'false' }}
        };
        
        {% if is_range and weekly_data %}
            // Range mode: multiple weeks
            const weeklyChartData = {{ weekly_data|tojson|safe }};
            const labels = weeklyChartData.map(w => {
                const startDate = new Date(w.start_date);
                return 'W ' + Math.ceil(startDate.getDate() / 7) + ' (' + startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ')';
            });
            const revenues = weeklyChartData.map(w => parseFloat(w.revenue) || 0);
            const expenses = weeklyChartData.map(w => parseFloat(w.expense) || 0);
            const margins = weeklyChartData.map(w => parseFloat(w.margin) || 0);
            
            // Revenue vs Expenses
            new Chart(revenueCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Revenue',
                            data: revenues,
                            backgroundColor: 'rgba(40, 167, 69, 0.7)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Expenses',
                            data: expenses,
                            backgroundColor: 'rgba(220, 53, 69, 0.7)',
                            borderColor: 'rgba(220, 53, 69, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    legend: { position: 'top' },
                    scales: {
                        yAxes: [{
                            ticks: { beginAtZero: true, callback: function(v) { return 'KES ' + v.toLocaleString(); } }
                        }]
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': KES ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            // Profit Margin Trend
            new Chart(profitCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Profit Margin %',
                        data: margins,
                        borderColor: 'rgba(23, 162, 184, 1)',
                        backgroundColor: 'rgba(23, 162, 184, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    legend: { position: 'top' },
                    scales: {
                        yAxes: [{
                            ticks: { beginAtZero: true, max: 100, callback: function(v) { return v + '%'; } }
                        }]
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
                                }
                            }
                        }
                    }
                }
            });
        {% else %}
            // Single week mode
            const profits = revenues.map((r, i) => r - expenses[i]);
            
            // Revenue vs Expenses
            new Chart(revenueCtx, {
                type: 'bar',
                data: {
                    labels: ['This Week'],
                    datasets: [
                        {
                            label: 'Revenue',
                            data: [metricsData.revenue],
                            backgroundColor: 'rgba(40, 167, 69, 0.7)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Expenses',
                            data: [metricsData.expenses],
                            backgroundColor: 'rgba(220, 53, 69, 0.7)',
                            borderColor: 'rgba(220, 53, 69, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    legend: { position: 'top' },
                    scales: {
                        yAxes: [{
                            ticks: { beginAtZero: true, callback: function(v) { return 'KES ' + v.toLocaleString(); } }
                        }]
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': KES ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            // Profit Margin
            new Chart(profitCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Profit', 'Expenses'],
                    datasets: [{
                        data: [metricsData.profit, metricsData.expenses],
                        backgroundColor: ['rgba(40, 167, 69, 0.7)', 'rgba(220, 53, 69, 0.7)'],
                        borderColor: ['rgba(40, 167, 69, 1)', 'rgba(220, 53, 69, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    legend: { position: 'top' },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const pct = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': KES ' + context.parsed.toLocaleString() + ' (' + pct + '%)';
                                }
                            }
                        }
                    }
                }
            });
        {% endif %}
    }
</script>
</div> <!-- End of financial-dashboard-container -->