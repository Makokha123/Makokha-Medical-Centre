{% extends "base.html" %}

{% block content %}
<div class="content">
    <div class="page-header">
        <h2><i class="fas fa-users"></i> All Patients</h2>
    </div>

    <!-- Filter Section -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search patient name...">
                </div>
                <div class="col-md-3">
                    <select id="wardFilter" class="form-control">
                        <option value="">All Wards</option>
                        {% for ward in wards %}
                        <option value="{{ ward.id }}">{{ ward.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="statusFilter" class="form-control">
                        <option value="">All Status</option>
                        <option value="stable">Stable</option>
                        <option value="critical">Critical</option>
                        <option value="recovering">Recovering</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary btn-block" onclick="applyFilters()">
                        <i class="fas fa-filter"></i> Apply Filters
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Patients Table -->
    <div class="card">
        <div class="card-header">
            <strong><i class="fas fa-bed"></i> Inpatients ({{ patients|length }})</strong>
        </div>
        <div class="card-body">
            {% if patients %}
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="patientsTable">
                    <thead>
                        <tr>
                            <th>IP Number</th>
                            <th>Patient Name</th>
                            <th>Age</th>
                            <th>Gender</th>
                            <th>Ward</th>
                            <th>Bed</th>
                            <th>Admission Date</th>
                            <th>Latest Vitals</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for patient in patients %}
                        <tr data-ward="{{ patient.bed_assignment.ward_id if patient.bed_assignment else '' }}">
                            <td><strong>{{ patient.ip_number }}</strong></td>
                            <td>{{ patient.name }}</td>
                            <td>{{ patient.age }} yrs</td>
                            <td>{{ patient.gender }}</td>
                            <td>
                                {% if patient.bed_assignment %}
                                {{ patient.bed_assignment.ward.name }}
                                {% else %}
                                <span class="text-muted">Not assigned</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if patient.bed_assignment %}
                                {{ patient.bed_assignment.bed.bed_number }}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if patient.bed_assignment %}
                                {{ patient.bed_assignment.assigned_at.strftime('%Y-%m-%d') }}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if patient.latest_report %}
                                <small>
                                    {% if patient.latest_report.temperature %}T: {{ patient.latest_report.temperature }}°C<br>{% endif %}
                                    {% if patient.latest_report.blood_pressure_systolic %}BP: {{ patient.latest_report.blood_pressure_systolic }}/{{ patient.latest_report.blood_pressure_diastolic }}{% endif %}
                                </small>
                                {% else %}
                                <span class="text-muted">No vitals</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('nurse_patient_details', patient_id=patient.id) }}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i> View
                                </a>
                                <button class="btn btn-sm btn-success" onclick="quickVitals('{{ patient.id }}')">
                                    <i class="fas fa-heartbeat"></i> Vitals
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted text-center py-4">No inpatients found</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Quick Vitals Modal -->
<div class="modal fade" id="quickVitalsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-heartbeat"></i> Record Vital Signs</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <form id="vitalsForm" method="POST" action="">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Temperature (°C)</label>
                                <input type="number" step="0.1" name="temperature" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Blood Sugar (mg/dL)</label>
                                <input type="number" step="0.1" name="blood_sugar" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>BP Systolic</label>
                                <input type="number" name="bp_systolic" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>BP Diastolic</label>
                                <input type="number" name="bp_diastolic" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Pulse Rate (bpm)</label>
                                <input type="number" name="pulse_rate" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Respiratory Rate</label>
                                <input type="number" name="respiratory_rate" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Oxygen Saturation (%)</label>
                        <input type="number" name="oxygen_saturation" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Observations</label>
                        <textarea name="observations" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Vitals</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let currentPatientId = null;

function quickVitals(patientId) {
    currentPatientId = patientId;
    $('#vitalsForm').attr('action', `/nurse/patient/${patientId}/vitals`);
    $('#quickVitalsModal').modal('show');
}

function applyFilters() {
    const search = $('#searchInput').val().toLowerCase();
    const ward = $('#wardFilter').val();
    
    $('#patientsTable tbody tr').each(function() {
        const row = $(this);
        const name = row.find('td:eq(1)').text().toLowerCase();
        const rowWard = row.data('ward').toString();
        
        let show = true;
        
        if (search && !name.includes(search)) {
            show = false;
        }
        
        if (ward && rowWard !== ward) {
            show = false;
        }
        
        row.toggle(show);
    });
}

// Real-time search
$('#searchInput').on('keyup', applyFilters);
</script>

<style>
.table-hover tbody tr:hover {
    background-color: #f5f5f5;
    cursor: pointer;
}

.page-header {
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #007bff;
}
</style>
{% endblock %}
