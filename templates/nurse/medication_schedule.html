{% extends "base.html" %}

{% block content %}
<div class="content">
    <div class="page-header">
        <h2><i class="fas fa-calendar-check"></i> Medication Schedule</h2>
    </div>

    <!-- Filter Section -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <label>Filter by Time</label>
                    <select id="timeFilter" class="form-control" onchange="applyFilter()">
                        <option value="all">All Medications</option>
                        <option value="due">Due Now</option>
                        <option value="overdue">Overdue</option>
                        <option value="upcoming">Upcoming (Next 2 hours)</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label>Filter by Ward</label>
                    <select id="wardFilter" class="form-control" onchange="applyFilter()">
                        <option value="all">All Wards</option>
                        {% for ward in wards %}
                        <option value="{{ ward.id }}">{{ ward.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary btn-block" onclick="refreshSchedule()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Medication Schedule Table -->
    <div class="card">
        <div class="card-header">
            <strong><i class="fas fa-pills"></i> Scheduled Medications</strong>
        </div>
        <div class="card-body">
            {% if medications %}
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="medicationTable">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Scheduled Time</th>
                            <th>Patient</th>
                            <th>Ward/Bed</th>
                            <th>Medication</th>
                            <th>Dosage</th>
                            <th>Route</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for med in medications %}
                        <tr data-ward="{{ med.patient.ward_id if med.patient.bed_assignment else '' }}" data-status="{{ med.time_status }}">
                            <td>
                                {% if med.time_status == 'overdue' %}
                                <span class="badge badge-danger">OVERDUE</span>
                                {% elif med.time_status == 'due' %}
                                <span class="badge badge-warning">DUE NOW</span>
                                {% else %}
                                <span class="badge badge-info">UPCOMING</span>
                                {% endif %}
                            </td>
                            <td>{{ med.scheduled_time.strftime('%H:%M') if med.scheduled_time else 'Not scheduled' }}</td>
                            <td>
                                <strong>{{ med.patient.name }}</strong><br>
                                <small>IP: {{ med.patient.ip_number }}</small>
                            </td>
                            <td>
                                {% if med.patient.bed_assignment %}
                                {{ med.patient.bed_assignment.ward.name }} / {{ med.patient.bed_assignment.bed.bed_number }}
                                {% else %}
                                <span class="text-muted">Not assigned</span>
                                {% endif %}
                            </td>
                            <td>{{ med.medication_name }}</td>
                            <td>{{ med.dosage }}</td>
                            <td>{{ med.route }}</td>
                            <td>
                                <button class="btn btn-sm btn-success" onclick="administerMed('{{ med.id }}', '{{ med.patient_id }}')">
                                    <i class="fas fa-check"></i> Administer
                                </button>
                                <a href="{{ url_for('nurse_patient_details', patient_id=med.patient_id) }}" class="btn btn-sm btn-info">
                                    <i class="fas fa-eye"></i> Patient
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted text-center py-4">No medications scheduled</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Quick Administer Modal -->
<div class="modal fade" id="administerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-pills"></i> Confirm Medication Administration</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <form id="administerForm" method="POST" action="">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="medication_id" id="medId">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Status</label>
                        <select name="status" class="form-control" required>
                            <option value="administered">Administered</option>
                            <option value="refused">Patient Refused</option>
                            <option value="delayed">Delayed</option>
                            <option value="missed">Missed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea name="notes" class="form-control" rows="3" placeholder="Any adverse reactions or observations..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Confirm</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function administerMed(medId, patientId) {
    $('#medId').val(medId);
    $('#administerForm').attr('action', `/nurse/patient/${patientId}/administer-scheduled/${medId}`);
    $('#administerModal').modal('show');
}

function applyFilter() {
    const timeFilter = $('#timeFilter').val();
    const wardFilter = $('#wardFilter').val();
    
    $('#medicationTable tbody tr').each(function() {
        const row = $(this);
        const status = row.data('status');
        const ward = row.data('ward').toString();
        
        let show = true;
        
        // Time filter
        if (timeFilter !== 'all' && status !== timeFilter) {
            show = false;
        }
        
        // Ward filter
        if (wardFilter !== 'all' && ward !== wardFilter) {
            show = false;
        }
        
        row.toggle(show);
    });
}

function refreshSchedule() {
    location.reload();
}
</script>

<style>
.page-header {
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #007bff;
}

.table-hover tbody tr:hover {
    background-color: #f5f5f5;
    cursor: pointer;
}
</style>
{% endblock %}
