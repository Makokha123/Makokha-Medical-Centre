{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-3">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <div>
      <h3 class="mb-1">{{ title }}</h3>
      <div class="text-muted small">Quick view of patients in this category.</div>
    </div>
    <div class="d-flex gap-2">
      {% if category == 'outpatients' %}
        <a class="btn btn-success" href="{{ url_for('doctor_new_patient', patient_type='OP', lock_patient_type=1) }}">Add New Patient</a>
      {% elif category == 'inpatients' %}
        <a class="btn btn-success" href="{{ url_for('doctor_new_patient', patient_type='IP', lock_patient_type=1) }}">Add New Patient</a>
      {% endif %}
      <a class="btn btn-outline-secondary" href="{{ url_for('doctor_patients') }}">All Patients</a>
      <a class="btn btn-primary" href="{{ url_for('doctor_dashboard') }}">Dashboard</a>
    </div>
  </div>

  <div id="completeAlert" class="alert alert-warning alert-dismissible fade d-none" role="alert">
    <div id="completeAlertBody"></div>
    <button type="button" class="btn-close" aria-label="Close" onclick="hideCompleteAlert()"></button>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      {% if patients and patients|length %}
        <div class="table-container">
          <table class="simple-table">
            <thead>
              <tr>
                <th>Patient ID</th>
                <th>Name</th>
                <th>Age</th>
                <th>Gender</th>
                <th>Last Visit</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for p in patients %}
                <tr>
                  <td>
                    {% if p.ip_number %}
                      <div class="d-flex align-items-center gap-2 flex-wrap">
                        <span>{{ p.ip_number }}</span>
                        {% if p.discharge_state == 'pending' %}
                          <span class="badge bg-warning text-dark">Pending</span>
                        {% elif p.discharge_state == 'discharged' %}
                          <span class="badge bg-success">Discharged</span>
                        {% endif %}
                      </div>
                    {% elif p.op_number %}
                      <div class="d-flex align-items-center gap-2 flex-wrap">
                        <span>{{ p.op_number }}</span>
                        {% if p.discharge_state == 'pending' %}
                          <span class="badge bg-warning text-dark">Pending</span>
                        {% elif p.discharge_state == 'discharged' %}
                          <span class="badge bg-success">Discharged</span>
                        {% endif %}
                      </div>
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td>{{ p.decrypted_name or 'N/A' }}</td>
                  <td>{{ p.age if p.age is not none else 'N/A' }}</td>
                  <td>{{ p.gender or 'N/A' }}</td>
                  <td>{{ p.updated_at.strftime('%Y-%m-%d') if p.updated_at else 'N/A' }}</td>
                  <td>
                    <span class="status-badge {{ 'in-stock' if p.status == 'active' else 'low-stock' }}">{{ p.status }}</span>
                  </td>
                  <td>
                    <div class="action-btns">
                      {% if category in ['outpatients', 'inpatients'] %}
                        <a href="{{ url_for('doctor_patient_details', patient_id=p.id) }}" class="action-btn btn-primary" title="View">
                          <i class="fas fa-eye"></i>
                        </a>
                        {% if category == 'outpatients' %}
                          <button class="action-btn btn-success" onclick="completeTreatment('{{ p.id }}')" title="Complete">
                            <i class="fas fa-check"></i>
                          </button>
                          <button class="action-btn btn-warning" onclick="admitPatient('{{ p.id }}')" title="Admit">
                            <i class="fas fa-hospital"></i>
                          </button>
                        {% else %}
                          {% if p.discharge_state == 'pending' %}
                            <button class="action-btn btn-secondary" disabled title="Pending discharge">
                              <i class="fas fa-clock"></i>
                            </button>
                          {% else %}
                            <button class="action-btn btn-warning" onclick="completeTreatment('{{ p.id }}')" title="Request Discharge">
                              <i class="fas fa-sign-out-alt"></i>
                            </button>
                          {% endif %}
                        {% endif %}
                        <button class="action-btn btn-info" onclick="viewSections('{{ p.id }}')" title="Sections">
                          <i class="fas fa-folder-open"></i>
                        </button>
                        <button class="action-btn btn-danger" onclick="confirmDelete('{{ p.id }}')" title="Delete">
                          <i class="fas fa-trash"></i>
                        </button>

                      {% elif category in ['old_outpatients', 'old_inpatients'] %}
                        <a href="{{ url_for('doctor_patient_details', patient_id=p.id) }}" class="action-btn btn-primary" title="View">
                          <i class="fas fa-eye"></i>
                        </a>
                        <button class="action-btn btn-warning" onclick="readmitPatient('{{ p.id }}')" title="Readmit">
                          <i class="fas fa-user-plus"></i>
                        </button>
                        <button class="action-btn btn-info" onclick="viewSections('{{ p.id }}')" title="Sections">
                          <i class="fas fa-folder-open"></i>
                        </button>

                      {% elif category == 'discharged' %}
                        <a href="{{ url_for('doctor_patient_details', patient_id=p.id) }}" class="action-btn btn-primary" title="View">
                          <i class="fas fa-eye"></i>
                        </a>
                        <button class="action-btn btn-info" onclick="viewSections('{{ p.id }}')" title="Sections">
                          <i class="fas fa-folder-open"></i>
                        </button>
                        <form method="POST" action="{{ url_for('doctor_confirm_discharge', patient_id=p.id) }}" class="d-inline" onsubmit="return confirm('Confirm discharge? This will complete the inpatient record.');">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <button class="action-btn btn-success" type="submit" title="Confirm Discharge">
                            <i class="fas fa-check-circle"></i>
                          </button>
                        </form>
                      {% else %}
                        <a class="action-btn btn-primary" href="{{ url_for('doctor_patient_details', patient_id=p.id) }}" title="Open">
                          <i class="fas fa-folder-open"></i>
                        </a>
                      {% endif %}
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-center py-5">
          <div class="text-muted">No patients found in this category.</div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
function getCsrfToken() {
  const meta = document.querySelector('meta[name="csrf-token"]');
  return meta ? meta.getAttribute('content') : '';
}

function showCompleteAlert(message, level) {
  const alertEl = document.getElementById('completeAlert');
  const bodyEl = document.getElementById('completeAlertBody');
  if (!alertEl || !bodyEl) return;

  const cls = (level === 'danger') ? 'alert-danger'
      : (level === 'success') ? 'alert-success'
      : (level === 'info') ? 'alert-info'
      : 'alert-warning';

  alertEl.classList.remove('alert-warning', 'alert-danger', 'alert-success', 'alert-info');
  alertEl.classList.add(cls);
  bodyEl.textContent = message;
  alertEl.classList.remove('d-none');
  alertEl.classList.add('show');
  try { alertEl.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch (e) {}
}

function hideCompleteAlert() {
  const alertEl = document.getElementById('completeAlert');
  if (!alertEl) return;
  alertEl.classList.remove('show');
  alertEl.classList.add('d-none');
}

function completeTreatment(patientId) {
  if (!confirm('Complete treatment for this patient?')) return;

  fetch(`/doctor/patient/${patientId}/complete`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCsrfToken(),
    },
    body: JSON.stringify({})
  })
  .then(async (res) => {
    let data = {};
    try { data = await res.json(); } catch (e) { data = {}; }

    if (res.ok && data.success) {
      location.reload();
      return;
    }

    if (data && data.ward_stay_due) {
      const w = data.ward_stay_due;
      const dailyRate = (w.daily_rate !== undefined && w.daily_rate !== null) ? Number(w.daily_rate) : null;
      const amount = (w.amount !== undefined && w.amount !== null) ? Number(w.amount) : null;
      const days = (w.days !== undefined && w.days !== null) ? Number(w.days) : null;

      const msg = [
        'Cannot discharge: ward stay charges are unpaid.',
        `Ward: ${w.ward_name || '-'}`,
        `Bed: ${w.bed_number || '-'}`,
        `Due: ${days !== null && !Number.isNaN(days) ? days : '-'} day(s) (${w.start_date || '-'} to ${w.end_date || '-'})`,
        `Rate: ${dailyRate !== null && !Number.isNaN(dailyRate) ? dailyRate.toFixed(2) : '-'}`,
        `Amount: ${amount !== null && !Number.isNaN(amount) ? amount.toFixed(2) : '-'}`,
        'Please ask reception to bill/pay the ward stay, then try again.'
      ].join(' | ');
      showCompleteAlert(msg, 'warning');
      return;
    }

    showCompleteAlert((data && data.error) ? data.error : 'Error completing treatment', 'danger');
  })
  .catch(() => {
    showCompleteAlert('Network error completing treatment', 'danger');
  });
}

function viewSections(patientId) {
  // Navigate to medical record page
  window.location.href = `/doctor/patient/${patientId}/record`;
}

function admitPatient(patientId) {
  // Navigate to admission page
  window.location.href = `/doctor/patient/${patientId}/admit`;
}

function confirmDelete(patientId) {
  if (!confirm('Are you sure you want to delete this patient?')) return;

  fetch(`/doctor/patient/${patientId}/delete`, {
    method: 'DELETE',
    headers: { 'X-CSRFToken': getCsrfToken() }
  })
  .then((response) => response.json())
  .then((data) => {
    if (data.success) {
      alert(data.message);
      location.reload();
    } else {
      alert(`Error: ${data.error}`);
    }
  })
  .catch(() => alert('Error deleting patient'));
}

function readmitPatient(patientId) {
  if (!confirm('Readmit this patient?')) return;

  fetch('/doctor/patient/readmit', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': getCsrfToken(),
    },
    body: `patient_id=${encodeURIComponent(patientId)}`
  })
  .then((res) => res.json())
  .then((data) => {
    if (data.success) location.reload();
    else alert(data.error || 'Error readmitting patient');
  })
  .catch(() => alert('Error readmitting patient'));
}
</script>

<style>
:root {
    --primary: #4361ee;
    --secondary: #6c757d;
    --success: #28a745;
    --danger: #dc3545;
    --warning: #ffc107;
    --info: #17a2b8;
    --white: #ffffff;
    --gray-200: #e9ecef;
    --gray-300: #dee2e6;
    --gray-600: #6c757d;
    --gray-800: #343a40;
    --border-radius: 8px;
    --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    --transition: all 0.3s ease;
}

/* Table Container - Modern Card Style */
.table-container {
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    overflow-x: auto;
    overflow-y: auto;
    max-height: 70vh;
    -webkit-overflow-scrolling: touch;
    margin-bottom: 24px;
}

/* Simple Table Styles */
.simple-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--white);
    margin: 0;
    font-size: 14px;
}

.simple-table thead {
    background: #0d6efd;
    color: white;
}

/* Sticky header for all patient tables */
.simple-table thead th {
    position: sticky;
    top: 0;
    z-index: 5;
    background: #0d6efd;
    padding: 12px 14px;
    text-align: left;
    font-weight: 600;
    border: 2px solid #0d6efd;
    white-space: nowrap;
}

.simple-table td {
    padding: 10px 14px;
    border: 1px solid var(--gray-300);
}

.simple-table tbody tr {
    transition: background-color 0.2s ease;
}

.simple-table tbody tr:hover {
    background-color: #f9f9f9;
}

.simple-table tbody tr:last-child td {
    border-bottom: 2px solid var(--gray-300);
}

/* Action Buttons Container */
.action-btns {
    display: flex;
    gap: 6px;
    flex-wrap: nowrap;
    align-items: center;
}

/* Action Button Styles */
.action-btn {
    padding: 6px 10px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 30px;
    height: 30px;
    color: white;
    text-decoration: none;
}

.action-btn i {
    font-size: 12px;
}

.action-btn:hover {
    transform: scale(1.05);
    text-decoration: none;
    color: white;
}

.action-btn.btn-primary {
    background: #4361ee;
}

.action-btn.btn-primary:hover {
    background: #3651d3;
}

.action-btn.btn-success {
    background: #28a745;
}

.action-btn.btn-success:hover {
    background: #218838;
}

.action-btn.btn-warning {
    background: #ffc107;
    color: #212529;
}

.action-btn.btn-warning:hover {
    background: #e0a800;
    color: #212529;
}

.action-btn.btn-danger {
    background: #dc3545;
}

.action-btn.btn-danger:hover {
    background: #c82333;
}

.action-btn.btn-info {
    background: #17a2b8;
}

.action-btn.btn-info:hover {
    background: #138496;
}

.action-btn.btn-secondary {
    background: #6c757d;
}

.action-btn.btn-secondary:hover {
    background: #5a6268;
}

.action-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
}

/* Status Badges */
.badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
    white-space: nowrap;
}

.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    display: inline-block;
    white-space: nowrap;
}

.status-badge.in-stock {
    background: #e6f4ea;
    color: #137333;
}

.status-badge.low-stock {
    background: #fef7e0;
    color: #b06000;
}

/* Responsive Design */
@media (min-width: 481px) and (max-width: 767px) {
    .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .simple-table {
        font-size: 12px;
    }
    
    .simple-table th,
    .simple-table td {
        padding: 8px 10px;
        font-size: 11px;
    }
    
    .action-btn {
        width: 26px;
        height: 26px;
        padding: 4px 6px;
        font-size: 11px;
    }
    
    .action-btn i {
        font-size: 11px;
    }
}

@media (min-width: 320px) and (max-width: 480px) {
    .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        max-height: 60vh;
    }
    
    .simple-table {
        min-width: 800px;
        font-size: 12px;
    }
    
    .simple-table th,
    .simple-table td {
        padding: 8px 10px;
        font-size: 11px;
    }
    
    .action-btn {
        padding: 4px 8px;
        min-width: 28px;
        height: 28px;
        font-size: 11px;
    }
    
    .action-btn i {
        font-size: 11px;
    }
    
    .badge {
        font-size: 10px;
        padding: 2px 6px;
    }
}
</style>
{% endblock %}