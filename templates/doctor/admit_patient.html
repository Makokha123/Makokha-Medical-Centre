{% extends "base.html" %}

{% block content %}
<div class="content">
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-md-8 offset-md-2">
                <div class="card">
                    <div class="card-header bg-warning text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-hospital-user"></i> Admit Patient
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- Patient Info -->
                        <div class="alert alert-info">
                            <h5><i class="fas fa-user"></i> Patient Information</h5>
                            <p class="mb-1"><strong>Name:</strong> {{ patient.decrypted_name }}</p>
                            <p class="mb-1"><strong>Current Status:</strong> Outpatient</p>
                            <p class="mb-1"><strong>OP Number:</strong> {{ patient.op_number }}</p>
                            <p class="mb-0"><strong>Age:</strong> {{ patient.age }} | <strong>Gender:</strong> {{ patient.gender }}</p>
                        </div>

                        <form method="POST" id="admissionForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            
                            <div class="form-group">
                                <label for="ward_id"><i class="fas fa-building"></i> Select Ward *</label>
                                <select class="form-control" id="ward_id" name="ward_id" required>
                                    <option value="">-- Select Ward --</option>
                                    {% for ward in wards %}
                                    <option value="{{ ward.id }}" data-rate="{{ ward.daily_rate }}">
                                        {{ ward.name }} (Daily Rate: KSH {{ "%.2f"|format(ward.daily_rate) }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="bed_id"><i class="fas fa-bed"></i> Select Bed *</label>
                                <select class="form-control" id="bed_id" name="bed_id" required disabled>
                                    <option value="">-- Select ward first --</option>
                                </select>
                                <small class="form-text text-muted">
                                    Available beds will load after selecting a ward
                                </small>
                            </div>

                            <div class="form-group">
                                <label><i class="fas fa-money-bill-wave"></i> Daily Charge</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">KSH</span>
                                    </div>
                                    <input type="text" class="form-control" id="daily_charge_display" readonly value="0.00">
                                </div>
                                <small class="form-text text-muted">
                                    Charges apply from admission date until discharge
                                </small>
                            </div>

                            <hr>

                            <!-- Insurance capture (optional) -->
                            <div class="mb-3">
                                <h5 class="mb-2"><i class="fas fa-shield-alt"></i> Insurance (Optional)</h5>

                                {% if active_insurance and active_insurance.provider %}
                                <div class="alert alert-light border">
                                    <div><strong>Current active:</strong> {{ active_insurance.provider.name }}</div>
                                    <div class="small text-muted">
                                        Policy: {{ active_insurance.policy_number or '—' }} | Member: {{ active_insurance.member_number or '—' }}
                                    </div>
                                </div>
                                {% endif %}

                                <div class="form-group">
                                    <label for="insurance_provider_id">Insurance Provider</label>
                                    <select class="form-control" id="insurance_provider_id" name="insurance_provider_id">
                                        <option value="">-- No Insurance / Skip --</option>
                                        {% for p in insurance_providers or [] %}
                                        <option value="{{ p.id }}"
                                            {% if active_insurance and active_insurance.provider_id == p.id %}selected{% endif %}>
                                            {{ p.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted">Select a provider if patient has insurance.</small>
                                </div>

                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label for="insurance_policy_number">Policy Number</label>
                                        <input type="text" class="form-control" id="insurance_policy_number" name="insurance_policy_number"
                                            value="{{ active_insurance.policy_number if active_insurance else '' }}"
                                            placeholder="e.g. NHIF-XXXX / Policy #">
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label for="insurance_member_number">Member Number</label>
                                        <input type="text" class="form-control" id="insurance_member_number" name="insurance_member_number"
                                            value="{{ active_insurance.member_number if active_insurance else '' }}"
                                            placeholder="Member / Card number">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="insurance_covers_inpatient" name="insurance_covers_inpatient" value="1" checked>
                                        <label class="form-check-label" for="insurance_covers_inpatient">Insurance covers inpatient billing</label>
                                        <small class="form-text text-muted">If unchecked, insurance will be disabled for inpatient billing unless replaced.</small>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Important:</strong> Once admitted, an IP number will be assigned to this patient, 
                                and you will be required to notify the nurse in charge to complete the admission process.
                            </div>

                            <div class="form-group text-right">
                                <a href="{{ url_for('doctor_patients') }}" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Cancel
                                </a>
                                <button type="submit" class="btn btn-warning" id="admitBtn">
                                    <i class="fas fa-hospital-user"></i> Admit Patient
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Load available beds when ward is selected
    $('#ward_id').change(function() {
        const wardId = $(this).val();
        const dailyRate = $(this).find(':selected').data('rate');
        
        // Update daily charge display
        if (dailyRate) {
            $('#daily_charge_display').val(parseFloat(dailyRate).toFixed(2));
        } else {
            $('#daily_charge_display').val('0.00');
        }
        
        // Reset and disable bed select
        const $bedSelect = $('#bed_id');
        $bedSelect.html('<option value="">Loading beds...</option>').prop('disabled', true);
        
        if (!wardId) {
            $bedSelect.html('<option value="">-- Select ward first --</option>');
            return;
        }
        
        // Load available beds
        $.get(`/api/wards/${wardId}/beds/available`, function(beds) {
            if (beds.length === 0) {
                $bedSelect.html('<option value="">No available beds in this ward</option>');
                $bedSelect.prop('disabled', true);
            } else {
                $bedSelect.html('<option value="">-- Select Bed --</option>');
                beds.forEach(function(bed) {
                    $bedSelect.append(`<option value="${bed.id}">${bed.bed_number}</option>`);
                });
                $bedSelect.prop('disabled', false);
            }
        }).fail(function() {
            $bedSelect.html('<option value="">Error loading beds</option>');
            alert('Failed to load available beds. Please try again.');
        });
    });
    
    // Form submission
    $('#admissionForm').submit(function(e) {
        if (!confirm('Confirm patient admission? This will assign an IP number and bed.')) {
            e.preventDefault();
            return false;
        }
        
        $('#admitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Admitting...');
    });
});
</script>

<style>
.card-header {
    font-weight: bold;
}

.alert-info h5 {
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(0,0,0,0.1);
}

.form-group label {
    font-weight: 600;
    margin-bottom: 8px;
}

.input-group-text {
    background-color: #f8f9fa;
    border-right: 0;
}

#daily_charge_display {
    background-color: #f8f9fa;
    font-weight: bold;
    text-align: right;
}
</style>
{% endblock %}
