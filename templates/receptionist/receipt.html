{% extends "base.html" %}

{% block title %}Receipt{% endblock %}

{% block content %}
<div class="container" style="max-width: 900px;">
    <div class="d-flex justify-content-between align-items-center mt-4 mb-3">
        <h3 class="mb-0">Receipt</h3>
        <div class="no-print">
            <a class="btn btn-secondary" href="{{ url_for('receptionist_dashboard') }}">Back</a>
            {% set whatsapp_share_endpoint = url_for('api_sale_share_whatsapp', sale_id=sale.id) %}
            {% set whatsapp_fallback_pdf = url_for('api_sale_receipt_pdf', sale_id=sale.id) %}
            {% include 'components/whatsapp_share_button.html' %}
            <button class="btn btn-primary" onclick="window.print()"><i class="fas fa-print"></i> Print</button>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-6">
                    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Clinic Logo" style="height: 48px;">
                    <div class="small text-muted">Makokha Medical Centre</div>
                </div>
                <div class="col-md-6 text-md-end">
                    <div><strong>Receipt #</strong> {{ sale.sale_number }}</div>
                    <div><strong>Date</strong> {{ sale.created_at.strftime('%Y-%m-%d %H:%M') if sale.created_at else '' }}</div>
                    <div><strong>Payment</strong> {{ sale.payment_method|capitalize if sale.payment_method else 'Cash' }}</div>
                </div>
            </div>

            <div class="mb-3">
                <strong>Patient:</strong>
                {% if sale.patient %}
                    {{ decrypt_data(sale.patient.name) }}
                {% else %}
                    Walk-in Customer
                {% endif %}
            </div>

            {% set ns = namespace(services=[], labs=[], imaging=[], drugs=[], controlled=[], ward=[], other=[]) %}
            {% for item in (sale.items or []) %}
                {% set _desc = (item.description or item.drug_name or '') %}
                {% if item.service_id %}
                    {% set _ = ns.services.append(item) %}
                {% elif item.lab_test_id %}
                    {% set _ = ns.labs.append(item) %}
                {% elif item.imaging_test_id or ((_desc or '').lower().startswith('imaging:')) %}
                    {% set _ = ns.imaging.append(item) %}
                {% elif ((_desc or '').lower().startswith('ward stay:')) %}
                    {% set _ = ns.ward.append(item) %}
                {% elif ((_desc or '').lower().startswith('controlled:')) %}
                    {% set _ = ns.controlled.append(item) %}
                {% elif item.drug_id %}
                    {% set _ = ns.drugs.append(item) %}
                {% else %}
                    {% set _ = ns.other.append(item) %}
                {% endif %}
            {% endfor %}

            {% macro render_section(title, rows) -%}
                {% if rows and (rows|length) > 0 %}
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-2">{{ title }}</h6>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered mb-0">
                                <thead>
                                    <tr>
                                        <th>Description</th>
                                        <th class="text-end" style="width:90px;">Qty</th>
                                        <th class="text-end" style="width:140px;">Unit Price</th>
                                        <th class="text-end" style="width:140px;">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% set subt = namespace(v=0.0) %}
                                    {% for item in rows %}
                                        {% set qty = (item.quantity or 1) %}
                                        {% set unit = (item.unit_price or 0) %}
                                        {% set line_total = (item.total_price if item.total_price is not none else (qty * unit)) %}
                                        {% set subt.v = (subt.v + (line_total or 0)) %}
                                        <tr>
                                            <td>{{ item.description or item.drug_name or 'Item' }}</td>
                                            <td class="text-end">{{ qty }}</td>
                                            <td class="text-end">KSH {{ "%.2f"|format(unit) }}</td>
                                            <td class="text-end">KSH {{ "%.2f"|format(line_total or 0) }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th colspan="3" class="text-end">Subtotal</th>
                                        <th class="text-end">KSH {{ "%.2f"|format(subt.v) }}</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                {% endif %}
            {%- endmacro %}

            {{ render_section('Services Done', ns.services) }}
            {{ render_section('Lab (Completed)', ns.labs) }}
            {{ render_section('Imaging (Completed)', ns.imaging) }}
            {{ render_section('Drugs Prescribed/Dispensed', ns.drugs) }}
            {{ render_section('Controlled Drugs', ns.controlled) }}
            {{ render_section('Ward Stay', ns.ward) }}
            {{ render_section('Other Charges', ns.other) }}

            <div class="mt-3">
                <h6 class="mb-2">Payment Summary</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered mb-0">
                        <tbody>
                            <tr>
                                <th>Total</th>
                                <td class="text-end"><strong>KSH {{ "%.2f"|format(sale.total_amount or 0) }}</strong></td>
                            </tr>
                            <tr>
                                <th>Payment Method</th>
                                <td class="text-end">{{ (sale.payment_method or 'cash')|upper }}</td>
                            </tr>
                            <tr>
                                <th>Amount</th>
                                <td class="text-end"><strong>KSH {{ "%.2f"|format(sale.total_amount or 0) }}</strong></td>
                            </tr>
                            {% if (sale.payment_method or 'cash') == 'cash' and amount_given is not none %}
                            <tr>
                                <th>Amount Given (Cash)</th>
                                <td class="text-end">KSH {{ "%.2f"|format(amount_given) }}</td>
                            </tr>
                            <tr>
                                <th>Balance</th>
                                <td class="text-end">KSH {{ "%.2f"|format(change if change is not none else ((amount_given or 0) - (sale.total_amount or 0))) }}</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="text-center mt-4">
                <div class="d-flex justify-content-center" style="margin-bottom:12px;">
                    {{ generate_rubber_stamp() }}
                </div>
                <div class="small text-muted">Thank you for your visit.</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
@media print {
    .no-print { display: none !important; }
}
</style>
{% endblock %}
